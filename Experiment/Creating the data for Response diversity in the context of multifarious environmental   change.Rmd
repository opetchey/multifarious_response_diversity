---
title: "Creating the data for Response diversity in the context of multifarious environmental
  change"
author: "Francesco Polazzo"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    fig_caption: yes
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    code_folding: hide
---

```{r include = FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      include = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE)
```

```{r results='hide'}
# rm(list = ls())
library(plotly)
library(tidyverse)
library(here)
library(patchwork)
library(DT)
library(mgcv)
library(gratia)
library(rlang)
library(vctrs)
library(scales)
library(broom)
library(reshape2)
library(ggtext)
library(ggsci)
source.files <- list.files(here("r"), full.names = TRUE)
sapply(source.files, source, .GlobalEnv)
```
# Intention
This is the second part of the reproducible analysis supporting the findings of the manuscript entitled "Response diversity in the context of multifarious environmental change".
Here, we are going to produce the data necessary to reproduce the figures presented in the manuscript, and to analyse the relative results.

We hypothesised that multiple factors may shape response diversity in a multifarious environmental change context. Specifically, we are going to investigate whether the three following factors may drive response diversity:
I.	The relative strength of effect of different environmental drivers.
II.	Correlation in species' responses to different environmental drivers. 
III.	Mean value of environmental conditions.

Initially, we also hypothesised that the different correlation scenarios of temperature and salinity change over time may be driving response diversity. However, after thinking and discussing the hypothesis, we concluded that there was no reason to believe that. Yet, we used different correlation scenarios in salinity and temperature change in the simulation to show that our results are robust to every kind of environmental change scenario. 

In this document, we first analyse the II and III treatments, and then we repeat the analysis in a case where temperature and salinity have exactly the same effect on species growth rate.

For each community, we calculate first the potential response diversity (with unknown direction of environmental change), and then also response diversity for each environmental change scenario.

Within the project "response diversity in the context of multifarious environmental change", we have been simulating species response curves using the Eppley performance curve.

With one environmental variable, the performance (i.e., rate) is given by:

-   $rate(E) = ae^{bE}(1 - (\frac{E - z}{w/2})^2)$
-   $E$ is the values of the environmental factor.
-   $z$ controls location of maximum.
-   $w$ controls range of $E$ over which the rate is positive.
-   $a$ scaling constant.
-   $b$ controls rate of increase towards the maximum rate, as $E$ increases.

Adding a second environmental variable gives:

$rate(E_1, E_2) = a_1e^{b_1E_1}(1 - (\frac{E_1 - z_1}{w_1/2})^2) + a_2e^{b_2E_2}(1 - (\frac{E_2 - z_2}{w_2/2})^2)$

We now want to assess the role of diversity in response to one (or both) environmental variable(s) influence response diversity.

To do that, we are going to manipulate amount of diversity in responses to one or both env variables among the species, and also the correlation in the tolerances (position of optima, determine by the terms z1 and z2 in the above formula). We will make scenarios of communities with diversity in response to only E1 (temperature), or both E1 (temperature) and E2 (salinity), with diversity in both that is positively correlated or negatively.

\# Variation in diversity in z1

## Increasing variance in z1 - negative correlation between env variables (E1 and E2) with fluctuations.

We now create 3 communities. Community 1 is characterized by low diversity in z1, community 2 has medium diversity in z1, and community 3 has high diversity in z1. z2 is constant in the 3 communities and fixed to a medium level of diversity.

E1 and E2 have *negative* correlation. We create 3 scenarios where we keep the variation of E1 and E2 fixed, but we change the mean so that in the first scenario E1 and E2 have low mean value, in the second medium, and high in the third (factor III).

```{r}
## define the series of values of the environmental variables
E1_series <- 273.15 + seq(0, 50, 1)
E2_series <- seq(0, 50, 1)

## define new_data for following GAM fitting

new_data <- tibble(E1 = 273.15 + seq(0, 50, 0.2),
                   E2 = seq(0, 50, 0.2))
```

```{r}
# Specify the correlation E1 and E2 
#negative in this example and high variation in E1 and E2 
E1max<-350; E1min<-250
E2max<- 70; E2min<- -25

# Scenario 1 - low mean vakues of E1 and E2
theme_set(theme_classic(base_size = 12))
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(  20                         , -  20                         ,
                                     -  20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(  20                         , -  20                         ,
                                     -  20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(  20                         , -  20                         ,
                                     -  20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))



detach("package:MASS", unload=TRUE)

```

### Community 1 - low diversity in z1.

```{r}
## Set species parameters
species_pars <- list(a1_mean = 1e-9,
  b1_mean = 0.063,
  z1_mean = 285,
  w1_mean = 60,
  a2_mean = 1e-3,
  b2_mean = 0.02,
  z2_mean = 20,
  w2_mean = 10,
  zint_mean = 0,
  sd_rate_mean = 0,
  z1_range = NA,
  z2_range = NA)

```

```{r plotcomm1_neg, fig.cap='Community 1, single species responses. (a) Species responses to the gradient of temperature. Different colour lines show the dependency of the rate to the second environmental variable (salinity). (b) Species responses to the gradient of salinity. Different colour lines show the dependency of the rate to the second environmental variable (temperature).', fig.align="center", fig.height=20, fig.width=12}
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm1 <- multi_performance_plot(comm)
performance_comm1

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)
```

```{r}
# Find optimum for E1 and E1 for each sp. Needed for fig 10 of the manuscript.
optima_com1 <- get_optima(comm, new_data)
optima_com1$community <- 1
```

```{r}
# Calculate absolute response diversity for community 1 - scenario 1 

# Unknown env conditions - get all surface
refs <- crossing(E1 = 273.15 + seq(0, 50, 10),
                     E2 = seq(0, 50, 10))

nested_gams <- comm %>% 
    nest(cols =-species) %>% 
    mutate(
      gams = map(cols, ~ gam(rate ~  te(E1, E2),
                             data = .x,
                             method = "REML")),
      predicted = map(gams, ~ predict(.x, newdata = new_data))
    )
  
  #list of gams
  m_list <- (nested_gams$gams)
  #list of spp names
  my_spp_names <- (nested_gams$species)
  # get partial derivatives
  pd_list <- modify_depth(m_list, 1, ~ get_partials(., refs))
  # from list to tibble
  pd_spp <- tibble(
    E1_ref = map(pd_list, "E1"),
    E2_ref = map(pd_list, "E2"),
    pd_E1 = map(pd_list, "pd_E1"),
    pd_E2 = map(pd_list, "pd_E2")) %>%
      dplyr::mutate(sp = my_spp_names) %>%
      relocate(sp, E1_ref, E2_ref, pd_E1, pd_E2) %>%
      unnest(E1_ref, E2_ref, pd_E1, pd_E2)
  
  radius <- 1
num_arrows <- 100
pd_spp <- crossing(angle = rep(seq(0, 2*pi, length = num_arrows)),
              E1_ref = pd_spp$E1_ref,
              E2_ref =pd_spp$E2_ref) %>%
  full_join(pd_spp) %>%
  mutate(E1 = cos(angle) * radius,
         E2 = sin(angle) * radius,
         dir_deriv = E1 * pd_E1 + E2 * pd_E2,
         unit_vec_mag = sqrt(E1^2 + E2^2))



# filter useless stuff
pd_spp <- pd_spp %>% 
  dplyr::select(angle, sp, E1_ref, E2_ref, dir_deriv)

#
# Calculating diversity for each direction and location this should be always the first step
# Dissimilarity
Div_loc_dir_comm1.1 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = F))



RDiv_comm1.1 <- tibble(Div_loc_dir_comm1.1 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
  summarise(mean = mean(div)) %>% 
  ungroup() %>% 
  summarise(dissimilarity = mean(mean)))

Div_loc_dir2_comm1.1 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = T))


RDiv1_comm1.1 <- tibble(Div_loc_dir2_comm1.1 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
                 summarise(mean = mean(div)) %>% 
                 ungroup() %>% 
                 summarise(divergence = mean(mean))) %>% 
  cbind(RDiv_comm1.1)

  
```

### Community 2 - medium diversity in z1.

```{r plotcomm2_neg, fig.cap='Community 2, single species responses. (a) Species responses to the gradient of temperature. Different colour lines show the dependency of the rate to the second environmental variable (salinity). (b) Species responses to the gradient of salinity. Different colour lines show the dependency of the rate to the second environmental variable (temperature).', fig.align="center", fig.height=20, fig.width=12}
species_pars$z1_range <- 25
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm2 <- multi_performance_plot(comm)
performance_comm2
# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)

```

```{r}
# Find optimum for E1 and E1 for each sp. Needed for fig. 10.
optima_com2 <- get_optima(comm, new_data)
optima_com2$community <- 2
```


```{r}
# Calculate absolute response diversity for community 2 - scenario 1 

# Unknown env conditions - get all surface
refs <- crossing(E1 = 273.15 + seq(0, 50, 10),
                     E2 = seq(0, 50, 10))

nested_gams <- comm %>% 
    nest(cols =-species) %>% 
    mutate(
      gams = map(cols, ~ gam(rate ~  te(E1, E2),
                             data = .x,
                             method = "REML")),
      predicted = map(gams, ~ predict(.x, newdata = new_data))
    )
  
  #list of gams
  m_list <- (nested_gams$gams)
  #list of spp names
  my_spp_names <- (nested_gams$species)
  # get partial derivatives
  pd_list <- modify_depth(m_list, 1, ~ get_partials(., refs))
  # from list to tibble
  pd_spp <- tibble(
    E1_ref = map(pd_list, "E1"),
    E2_ref = map(pd_list, "E2"),
    pd_E1 = map(pd_list, "pd_E1"),
    pd_E2 = map(pd_list, "pd_E2")) %>%
      dplyr::mutate(sp = my_spp_names) %>%
      relocate(sp, E1_ref, E2_ref, pd_E1, pd_E2) %>%
      unnest(E1_ref, E2_ref, pd_E1, pd_E2)
  
  radius <- 1
num_arrows <- 100
pd_spp <- crossing(angle = rep(seq(0, 2*pi, length = num_arrows)),
              E1_ref = pd_spp$E1_ref,
              E2_ref =pd_spp$E2_ref) %>%
  full_join(pd_spp) %>%
  mutate(E1 = cos(angle) * radius,
         E2 = sin(angle) * radius,
         dir_deriv = E1 * pd_E1 + E2 * pd_E2,
         unit_vec_mag = sqrt(E1^2 + E2^2))



# filter useless stuff
pd_spp <- pd_spp %>% 
  dplyr::select(angle, sp, E1_ref, E2_ref, dir_deriv)

#
# Calculating diversity for each direction and location this should be always the first step
# Dissimilarity
Div_loc_dir_comm2.1 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = F))



RDiv_comm2.1 <- tibble(Div_loc_dir_comm2.1 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
  summarise(mean = mean(div)) %>% 
  ungroup() %>% 
  summarise(dissimilarity = mean(mean)))

Div_loc_dir2_comm2.1 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = T))


RDiv1_comm2.1 <- tibble(Div_loc_dir2_comm2.1 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
                 summarise(mean = mean(div)) %>% 
                 ungroup() %>% 
                 summarise(divergence = mean(mean))) %>% 
  cbind(RDiv_comm2.1)

  
```



### Community 3 - high diversity in z1.

```{r plotcomm3_neg, fig.cap=' Community 3, single species responses. (a) Species responses to the gradient of temperature. Different colour lines show the dependency of the rate to the second environmental variable (salinity). (b) Species responses to the gradient of salinity. Different colour lines show the dependency of the rate to the second environmental variable (temperature).', fig.align="center", fig.height=20, fig.width=12}
species_pars$z1_range <- 50
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm3 <- multi_performance_plot(comm)
performance_comm3
# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)
```

```{r}
# Find optimum for E1 and E1 for each sp 
optima_com3 <- get_optima(comm, new_data)
optima_com3$community <- 3
```

```{r}
# Calculate absolute response diversity for community 3 - scenario 1 

# Unknown env conditions - get all surface
refs <- crossing(E1 = 273.15 + seq(0, 50, 10),
                     E2 = seq(0, 50, 10))

nested_gams <- comm %>% 
    nest(cols =-species) %>% 
    mutate(
      gams = map(cols, ~ gam(rate ~  te(E1, E2),
                             data = .x,
                             method = "REML")),
      predicted = map(gams, ~ predict(.x, newdata = new_data))
    )
  
  #list of gams
  m_list <- (nested_gams$gams)
  #list of spp names
  my_spp_names <- (nested_gams$species)
  # get partial derivatives
  pd_list <- modify_depth(m_list, 1, ~ get_partials(., refs))
  # from list to tibble
  pd_spp <- tibble(
    E1_ref = map(pd_list, "E1"),
    E2_ref = map(pd_list, "E2"),
    pd_E1 = map(pd_list, "pd_E1"),
    pd_E2 = map(pd_list, "pd_E2")) %>%
      dplyr::mutate(sp = my_spp_names) %>%
      relocate(sp, E1_ref, E2_ref, pd_E1, pd_E2) %>%
      unnest(E1_ref, E2_ref, pd_E1, pd_E2)
  
  radius <- 1
num_arrows <- 100
pd_spp <- crossing(angle = rep(seq(0, 2*pi, length = num_arrows)),
              E1_ref = pd_spp$E1_ref,
              E2_ref =pd_spp$E2_ref) %>%
  full_join(pd_spp) %>%
  mutate(E1 = cos(angle) * radius,
         E2 = sin(angle) * radius,
         dir_deriv = E1 * pd_E1 + E2 * pd_E2,
         unit_vec_mag = sqrt(E1^2 + E2^2))



# filter useless stuff
pd_spp <- pd_spp %>% 
  dplyr::select(angle, sp, E1_ref, E2_ref, dir_deriv)

#
# Calculating diversity for each direction and location this should be always the first step
# Dissimilarity
Div_loc_dir_comm3.1 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = F))



RDiv_comm3.1 <- tibble(Div_loc_dir_comm3.1 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
  summarise(mean = mean(div)) %>% 
  ungroup() %>% 
  summarise(dissimilarity = mean(mean)))

Div_loc_dir2_comm3.1 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = T))


RDiv1_comm3.1 <- tibble(Div_loc_dir2_comm3.1 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
                 summarise(mean = mean(div)) %>% 
                 ungroup() %>% 
                 summarise(divergence = mean(mean))) %>% 
  cbind(RDiv_comm3.1)

```

### Potential response diversity
```{r}
RDiv1_comm1.1$community <- 1
RDiv1_comm2.1$community <- 2
RDiv1_comm3.1$community <- 3
Absolute_RD_1 <- rbind(RDiv1_comm1.1, RDiv1_comm2.1, RDiv1_comm3.1)

#change to long format
Absolute_RD_1 <- pivot_longer(Absolute_RD_1, cols = "dissimilarity":"divergence", names_to = "RDiv",
                                values_to = "value", values_drop_na = TRUE)

Absolute_RD_1$community <- as.factor(Absolute_RD_1$community)

```


### Position of the optimum

Here and elsewhere in this document, the position of the optima has been estimated as the environmental location (E1 and E2 values) for which the rate is maximum.

```{r}
optima_scenario1 <- rbind(optima_com1, optima_com2, optima_com3)

 
```


### Response diversity calculation - first scenario (low mean values of E1 and E2)

```{r }
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```



```{r}
# Preparing data sets for overview plots
dd1 <- data.frame(rdiv_1[, c("rdiv", "sign")]) 
dd1$cor <- "negative"
dd1$z1 <- "low"
dd1$E1_mean <- "low"

dd1.2 <- data.frame(rdiv_1.2[, c("rdiv", "sign")]) 
dd1.2$cor <- "negative"
dd1.2$z1 <- "low"
dd1.2$E1_mean <- "medium"

dd1.3 <- data.frame(rdiv_1.3[, c("rdiv", "sign")]) 
dd1.3$cor <- "negative"
dd1.3$z1 <- "low"
dd1.3$E1_mean <- "high"


dd2 <- data.frame(rdiv_2[, c("rdiv", "sign")]) 
dd2$cor <- "negative"
dd2$z1 <- "medium"
dd2$E1_mean <- "low"

dd2.2 <- data.frame(rdiv_2.2[, c("rdiv", "sign")]) 
dd2.2$cor <- "negative"
dd2.2$z1 <- "medium"
dd2.2$E1_mean <- "medium"

dd2.3 <- data.frame(rdiv_2.3[, c("rdiv", "sign")]) 
dd2.3$cor <- "negative"
dd2.3$z1 <- "medium"
dd2.3$E1_mean <- "high"

dd3 <- data.frame(rdiv_3[, c("rdiv", "sign")]) 
dd3$cor <- "negative"
dd3$z1 <- "high"
dd3$E1_mean <-"low"


dd3.2 <- data.frame(rdiv_3.2[, c("rdiv", "sign")]) 
dd3.2$cor <- "negative"
dd3.2$z1 <- "high"
dd3.2$E1_mean <- "medium"

dd3.3 <- data.frame(rdiv_3.3[, c("rdiv", "sign")]) 
dd3.3$cor <- "negative"
dd3.3$z1 <- "high"
dd3.3$E1_mean <- "high"
```




## Fluctuation in environmental change - positive correlation

Increasing variance in z1 - positive correlation between env variables (E1 and E2) 

Same steps as before (3 communities with increasing diversity in z1 while z2 is fixed), but the correlation between E1 and E1 is positive

```{r }
E1max<-350; E1min<-250
E2max<- 70; E2min<- -25
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(  20                         ,   20                         ,
                                       20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(  20                         ,   20                         ,
                                       20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(  20                         ,   20                         ,
                                       20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


detach("package:MASS", unload=TRUE)

```

```{r}
# create reproducible community
set.seed(2456)
### Community 1 - low diversity in z1.
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)


species_pars$z1_range <- 25
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)

### Community 3 - high diversity in z1. 

species_pars$z1_range <- 50
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)

```

### Response diversity calculation

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```



```{r}
# Preparing data sets for overview plotting
dd4 <- data.frame(rdiv_1[, c("rdiv", "sign")]) 
dd4$cor <- "positive"
dd4$z1 <- "low"
dd4$E1_mean <- "low"

dd4.2 <- data.frame(rdiv_1.2[, c("rdiv", "sign")]) 
dd4.2$cor <- "positive"
dd4.2$z1 <- "low"
dd4.2$E1_mean <- "medium"

dd4.3 <- data.frame(rdiv_1.3[, c("rdiv", "sign")]) 
dd4.3$cor <- "positive"
dd4.3$z1 <- "low"
dd4.3$E1_mean <- "high"


dd5 <- data.frame(rdiv_2[, c("rdiv", "sign")]) 
dd5$cor <- "positive"
dd5$z1 <- "medium"
dd5$E1_mean <- "low"

dd5.2 <- data.frame(rdiv_2.2[, c("rdiv", "sign")]) 
dd5.2$cor <- "positive"
dd5.2$z1 <- "medium"
dd5.2$E1_mean <- "medium"

dd5.3 <- data.frame(rdiv_2.3[, c("rdiv", "sign")]) 
dd5.3$cor <- "positive"
dd5.3$z1 <- "medium"
dd5.3$E1_mean <- "high"

dd6 <- data.frame(rdiv_3[, c("rdiv", "sign")]) 
dd6$cor <- "positive"
dd6$z1 <- "high"
dd6$E1_mean <-"low"


dd6.2 <- data.frame(rdiv_3.2[, c("rdiv", "sign")]) 
dd6.2$cor <- "positive"
dd6.2$z1 <- "high"
dd6.2$E1_mean <- "medium"

dd6.3 <- data.frame(rdiv_3.3[, c("rdiv", "sign")]) 
dd6.3$cor <- "positive"
dd6.3$z1 <- "high"
dd6.3$E1_mean <- "high"
```


## Fluctuation in environmental change - no correlation

Increasing variance in z1 - no correlation between env variables (E1 and E2) 

Same steps as before (3 communities with increasing diversity in z1 while z2 is fixed), but there is no correlation between E1 and E1

```{r}
E1max<-350; E1min<-250
E2max<- 70; E2min<- -25
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(  20                         , 0.0,
                                     0.0,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.))) 



### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(  20                         , 0.0,
                                     0.0,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(  20                         , 0.0,
                                     0.0,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


detach("package:MASS", unload=TRUE)

```

```{r}
# create reproducible community
set.seed(2456)
### Community 1 - low diversity in z1.
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)


species_pars$z1_range <- 25
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)

### Community 3 - high diversity in z1. 

species_pars$z1_range <- 50
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)

```

### Response diversity calculation

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```


```{r}
# Preparing data sets for overview plotting
dd7 <- data.frame(rdiv_1[, c("rdiv", "sign")]) 
dd7$cor <- "no cor"
dd7$z1 <- "low"
dd7$E1_mean <- "low"

dd7.2 <- data.frame(rdiv_1.2[, c("rdiv", "sign")]) 
dd7.2$cor <- "no cor"
dd7.2$z1 <- "low"
dd7.2$E1_mean <- "medium"

dd7.3 <- data.frame(rdiv_1.3[, c("rdiv", "sign")]) 
dd7.3$cor <- "no cor"
dd7.3$z1 <- "low"
dd7.3$E1_mean <- "high"


dd8 <- data.frame(rdiv_2[, c("rdiv", "sign")]) 
dd8$cor <- "no cor"
dd8$z1 <- "medium"
dd8$E1_mean <- "low"

dd8.2 <- data.frame(rdiv_2.2[, c("rdiv", "sign")]) 
dd8.2$cor <- "no cor"
dd8.2$z1 <- "medium"
dd8.2$E1_mean <- "medium"

dd8.3 <- data.frame(rdiv_2.3[, c("rdiv", "sign")]) 
dd8.3$cor <- "no cor"
dd8.3$z1 <- "medium"
dd8.3$E1_mean <- "high"

dd9 <- data.frame(rdiv_3[, c("rdiv", "sign")]) 
dd9$cor <- "no cor"
dd9$z1 <- "high"
dd9$E1_mean <-"low"


dd9.2 <- data.frame(rdiv_3.2[, c("rdiv", "sign")]) 
dd9.2$cor <- "no cor"
dd9.2$z1 <- "high"
dd9.2$E1_mean <- "medium"

dd9.3 <- data.frame(rdiv_3.3[, c("rdiv", "sign")]) 
dd9.3$cor <- "no cor"
dd9.3$z1 <- "high"
dd9.3$E1_mean <- "high"
```

## preparing data set
```{r}

dd_plot1 <- rbind(dd1[,c(1,3:5)], dd1.2[,c(1,3:5)],dd1.3[,c(1,3:5)],
                  dd2[,c(1,3:5)], dd2.2[,c(1,3:5)],dd2.3[,c(1,3:5)],
                  dd3[,c(1,3:5)], dd3.2[,c(1,3:5)],dd3.3[,c(1,3:5)],
                  dd4[,c(1,3:5)], dd4.2[,c(1,3:5)],dd4.3[,c(1,3:5)],
                  dd5[,c(1,3:5)], dd5.2[,c(1,3:5)],dd5.3[,c(1,3:5)], 
                  dd6[,c(1,3:5)], dd6.2[,c(1,3:5)],dd6.3[,c(1,3:5)],
                  dd7[,c(1,3:5)], dd7.2[,c(1,3:5)],dd7.3[,c(1,3:5)],
                  dd8[,c(1,3:5)], dd8.2[,c(1,3:5)],dd8.3[,c(1,3:5)],
                  dd9[,c(1,3:5)], dd9.2[,c(1,3:5)],dd9.3[,c(1,3:5)])
dd_plot1$E1_mean <- factor(dd_plot1$E1_mean, levels = c("low", "medium", "high"))
theme_set(theme_classic(base_size = 12))
level_order <- c("low", "medium", "high")
dd_dissimilarity_scenario1 <- dd_plot1

g1.1 <-
  ggplot(dd_plot1, aes(x = z1, y = rdiv, color = E1_mean)) +
   # scale_y_continuous(limits = c(0.99, 1.005), expand = c(0.02, 0.02)) +
    scale_color_uchicago() +
    labs(x = "z1 diversity", y = "Dissimilarity (derivatives)") +
    theme(
      legend.position = "none",
      axis.title = element_text(size = 16),
      panel.grid = element_blank()
    )


rdiv1 <- g1.1 +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  stat_summary(fun = mean, geom = "point", size = 5) + labs(tag = "(a)") + 
  scale_x_discrete(limits = level_order) 

dd_plot2 <- rbind(dd1[,c(2,3:5)], dd1.2[,c(2,3:5)],dd1.3[,c(2,3:5)],
                  dd2[,c(2,3:5)], dd2.2[,c(2,3:5)],dd2.3[,c(2,3:5)],
                  dd3[,c(2,3:5)], dd3.2[,c(2,3:5)],dd3.3[,c(2,3:5)],
                  dd4[,c(2,3:5)], dd4.2[,c(2,3:5)],dd4.3[,c(2,3:5)],
                  dd5[,c(2,3:5)], dd5.2[,c(2,3:5)],dd5.3[,c(2,3:5)], 
                  dd6[,c(2,3:5)], dd6.2[,c(2,3:5)],dd6.3[,c(2,3:5)],
                  dd7[,c(2,3:5)], dd7.2[,c(2,3:5)],dd7.3[,c(2,3:5)],
                  dd8[,c(2,3:5)], dd8.2[,c(2,3:5)],dd8.3[,c(2,3:5)],
                  dd9[,c(2,3:5)], dd9.2[,c(2,3:5)],dd9.3[,c(2,3:5)])
dd_plot2$E1_mean <- factor(dd_plot2$E1_mean, levels = c("low", "medium", "high"))

dd_divergence_scenario1 <- dd_plot2
g1.2 <-
  ggplot(dd_plot2, aes(x = z1, y = sign, color = E1_mean)) +
    scale_color_uchicago() +
    labs(x = "T optimum diversity", y = "Divergence (sign sensitive)") +
    theme(
      legend.position = "none",
      axis.title = element_text(size = 16),
      panel.grid = element_blank()
    )

sign1 <- g1.2 +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  stat_summary(fun = mean, geom = "point", size = 5)+ labs(tag = "(b)") +
  ylim(0, 1)+ 
  scale_x_discrete(limits = level_order) 

combined <- rdiv1 + sign1 & theme(legend.position = "bottom")
combined + plot_layout(guides = "collect")

```




# Variation in diversity in z1 and z2

Now we do the same, but having also z2 changing together with z1 with positive correlation. So, diversity in z1 and z2 are increasing gradually from low to high in the 3 communities.

## Fluctuation in environmental change - negative correlation

Increasing variance in z1 and z2 - negative correlation between environmental variables (E1 and E2).

We now create 3 communities. Community 1 is characterized by low diversity in z1 and z2, community 2 has medium diversity in z1 and z2, and community 3 has high diversity in z1 and z2.

E1 and E2 fluctuate with *negative* correlation.

```{r}
# Specify the correlation E1 and E2 
#negative in this example and high variation in E1 and E2 
E1max<-350; E1min<-250
E2max<- 70; E2min<- -25

# Scenario 1 - low mean vakues of E1 and E2
theme_set(theme_classic(base_size = 12))
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(  20                         , -  20                         ,
                                     -  20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))



### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(  20                         , -  20                         ,
                                     -  20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(  20                         , -  20                         ,
                                     -  20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

detach("package:MASS", unload=TRUE)

```

### Community 1 - low diversity in z1.

```{r}
## Set species parameters
species_pars <- list(a1_mean = 1e-9,
  b1_mean = 0.063,
  z1_mean = 285,
  w1_mean = 60,
  a2_mean = 1e-3,
  b2_mean = 0.02,
  z2_mean = 20,
  w2_mean = 10,
  zint_mean = 0,
  sd_rate_mean = 0,
  z1_range = NA,
  z2_range = NA)

```

```{r plotcomm1_pos, fig.cap='Community 1, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=20, fig.width=12}
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm1 <- multi_performance_plot(comm)
performance_comm1

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)
```

```{r}
# Find optimum for E1 and E1 for each sp 
optima_com1 <- get_optima(comm, new_data)
optima_com1$community <- 1
```

```{r}
# Calculate absolute response diversity for community 1 - scenario 2

# Unknown env conditions - get all surface
refs <- crossing(E1 = 273.15 + seq(0, 50, 10),
                     E2 = seq(0, 50, 10))

nested_gams <- comm %>% 
    nest(cols =-species) %>% 
    mutate(
      gams = map(cols, ~ gam(rate ~  te(E1, E2),
                             data = .x,
                             method = "REML")),
      predicted = map(gams, ~ predict(.x, newdata = new_data))
    )
  
  #list of gams
  m_list <- (nested_gams$gams)
  #list of spp names
  my_spp_names <- (nested_gams$species)
  # get partial derivatives
  pd_list <- modify_depth(m_list, 1, ~ get_partials(., refs))
  # from list to tibble
  pd_spp <- tibble(
    E1_ref = map(pd_list, "E1"),
    E2_ref = map(pd_list, "E2"),
    pd_E1 = map(pd_list, "pd_E1"),
    pd_E2 = map(pd_list, "pd_E2")) %>%
      dplyr::mutate(sp = my_spp_names) %>%
      relocate(sp, E1_ref, E2_ref, pd_E1, pd_E2) %>%
      unnest(E1_ref, E2_ref, pd_E1, pd_E2)
  
  radius <- 1
num_arrows <- 100
pd_spp <- crossing(angle = rep(seq(0, 2*pi, length = num_arrows)),
              E1_ref = pd_spp$E1_ref,
              E2_ref =pd_spp$E2_ref) %>%
  full_join(pd_spp) %>%
  mutate(E1 = cos(angle) * radius,
         E2 = sin(angle) * radius,
         dir_deriv = E1 * pd_E1 + E2 * pd_E2,
         unit_vec_mag = sqrt(E1^2 + E2^2))



# filter useless stuff
pd_spp <- pd_spp %>% 
  dplyr::select(angle, sp, E1_ref, E2_ref, dir_deriv)

#
# Calculating diversity for each direction and location this should be always the first step
# Dissimilarity
Div_loc_dir_comm1.2 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = F))



RDiv_comm1.2 <- tibble(Div_loc_dir_comm1.2 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
  summarise(mean = mean(div)) %>% 
  ungroup() %>% 
  summarise(dissimilarity = mean(mean)))

Div_loc_dir2_comm1.2 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = T))


RDiv1_comm1.2 <- tibble(Div_loc_dir2_comm1.2 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
                 summarise(mean = mean(div)) %>% 
                 ungroup() %>% 
                 summarise(divergence = mean(mean))) %>% 
  cbind(RDiv_comm1.2)

  
```

### Community 2 - medium diversity in z1.

```{r plotcomm2_pos, fig.cap='Community 2, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=20, fig.width=12}
species_pars$z1_range <- 25
species_pars$z2_range <- 25

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm2 <- multi_performance_plot(comm)
performance_comm2
# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)

```

```{r}
# Find optimum for E1 and E1 for each sp 
optima_com2 <- get_optima(comm, new_data)
optima_com2$community <- 2
```


```{r}
# Calculate absolute response diversity for community 2 - scenario 2 

# Unknown env conditions - get all surface
refs <- crossing(E1 = 273.15 + seq(0, 50, 10),
                     E2 = seq(0, 50, 10))

nested_gams <- comm %>% 
    nest(cols =-species) %>% 
    mutate(
      gams = map(cols, ~ gam(rate ~  te(E1, E2),
                             data = .x,
                             method = "REML")),
      predicted = map(gams, ~ predict(.x, newdata = new_data))
    )
  
  #list of gams
  m_list <- (nested_gams$gams)
  #list of spp names
  my_spp_names <- (nested_gams$species)
  # get partial derivatives
  pd_list <- modify_depth(m_list, 1, ~ get_partials(., refs))
  # from list to tibble
  pd_spp <- tibble(
    E1_ref = map(pd_list, "E1"),
    E2_ref = map(pd_list, "E2"),
    pd_E1 = map(pd_list, "pd_E1"),
    pd_E2 = map(pd_list, "pd_E2")) %>%
      dplyr::mutate(sp = my_spp_names) %>%
      relocate(sp, E1_ref, E2_ref, pd_E1, pd_E2) %>%
      unnest(E1_ref, E2_ref, pd_E1, pd_E2)
  
  radius <- 1
num_arrows <- 100
pd_spp <- crossing(angle = rep(seq(0, 2*pi, length = num_arrows)),
              E1_ref = pd_spp$E1_ref,
              E2_ref =pd_spp$E2_ref) %>%
  full_join(pd_spp) %>%
  mutate(E1 = cos(angle) * radius,
         E2 = sin(angle) * radius,
         dir_deriv = E1 * pd_E1 + E2 * pd_E2,
         unit_vec_mag = sqrt(E1^2 + E2^2))



# filter useless stuff
pd_spp <- pd_spp %>% 
  dplyr::select(angle, sp, E1_ref, E2_ref, dir_deriv)

#
# Calculating diversity for each direction and location this should be always the first step
# Dissimilarity
Div_loc_dir_comm2.2 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = F))



RDiv_comm2.2 <- tibble(Div_loc_dir_comm2.2 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
  summarise(mean = mean(div)) %>% 
  ungroup() %>% 
  summarise(dissimilarity = mean(mean)))

Div_loc_dir2_comm2.2 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = T))


RDiv1_comm2.2 <- tibble(Div_loc_dir2_comm2.2 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
                 summarise(mean = mean(div)) %>% 
                 ungroup() %>% 
                 summarise(divergence = mean(mean))) %>% 
  cbind(RDiv_comm2.2)

  
```
### Community 3 - high diversity in z1.

```{r plotcomm3_pos, fig.cap=' Community 3, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=20, fig.width=12}
species_pars$z1_range <- 50
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm3 <- multi_performance_plot(comm)
performance_comm3
# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)
```

```{r}
# Find optimum for E1 and E1 for each sp 
optima_com3 <- get_optima(comm, new_data)
optima_com3$community <- 3
```

```{r}
# Calculate absolute response diversity for community 3 - scenario 2 

# Unknown env conditions - get all surface
refs <- crossing(E1 = 273.15 + seq(0, 50, 10),
                     E2 = seq(0, 50, 10))

nested_gams <- comm %>% 
    nest(cols =-species) %>% 
    mutate(
      gams = map(cols, ~ gam(rate ~  te(E1, E2),
                             data = .x,
                             method = "REML")),
      predicted = map(gams, ~ predict(.x, newdata = new_data))
    )
  
  #list of gams
  m_list <- (nested_gams$gams)
  #list of spp names
  my_spp_names <- (nested_gams$species)
  # get partial derivatives
  pd_list <- modify_depth(m_list, 1, ~ get_partials(., refs))
  # from list to tibble
  pd_spp <- tibble(
    E1_ref = map(pd_list, "E1"),
    E2_ref = map(pd_list, "E2"),
    pd_E1 = map(pd_list, "pd_E1"),
    pd_E2 = map(pd_list, "pd_E2")) %>%
      dplyr::mutate(sp = my_spp_names) %>%
      relocate(sp, E1_ref, E2_ref, pd_E1, pd_E2) %>%
      unnest(E1_ref, E2_ref, pd_E1, pd_E2)
  
  radius <- 1
num_arrows <- 100
pd_spp <- crossing(angle = rep(seq(0, 2*pi, length = num_arrows)),
              E1_ref = pd_spp$E1_ref,
              E2_ref =pd_spp$E2_ref) %>%
  full_join(pd_spp) %>%
  mutate(E1 = cos(angle) * radius,
         E2 = sin(angle) * radius,
         dir_deriv = E1 * pd_E1 + E2 * pd_E2,
         unit_vec_mag = sqrt(E1^2 + E2^2))



# filter useless stuff
pd_spp <- pd_spp %>% 
  dplyr::select(angle, sp, E1_ref, E2_ref, dir_deriv)

#
# Calculating diversity for each direction and location this should be always the first step
# Dissimilarity
Div_loc_dir_comm3.2 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = F))



RDiv_comm3.2 <- tibble(Div_loc_dir_comm3.2 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
  summarise(mean = mean(div)) %>% 
  ungroup() %>% 
  summarise(dissimilarity = mean(mean)))

Div_loc_dir2_comm3.2 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = T))


RDiv1_comm3.2 <- tibble(Div_loc_dir2_comm3.2 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
                 summarise(mean = mean(div)) %>% 
                 ungroup() %>% 
                 summarise(divergence = mean(mean))) %>% 
  cbind(RDiv_comm3.2)

```

### Potential response diversity
```{r }
RDiv1_comm1.2$community <- 1
RDiv1_comm2.2$community <- 2
RDiv1_comm3.2$community <- 3
Absolute_RD_2 <- rbind(RDiv1_comm1.2, RDiv1_comm2.2, RDiv1_comm3.2)

#change to long format
Absolute_RD_2 <- pivot_longer(Absolute_RD_2, cols = "dissimilarity":"divergence", names_to = "RDiv",
                                values_to = "value", values_drop_na = TRUE)

Absolute_RD_2$community <- as.factor(Absolute_RD_2$community)

```
### Position of the optimum

.

```{r }
optima_scenatio2 <- rbind(optima_com1, optima_com2, optima_com3)

```



### Response diversity calculation - first scenario (low mean values of E1 and E2)

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```


```{r}
# Preparing data sets for overview plots
dd1 <- data.frame(rdiv_1[, c("rdiv", "sign")]) 
dd1$cor <- "negative"
dd1$z1 <- "low"
dd1$E1_mean <- "low"

dd1.2 <- data.frame(rdiv_1.2[, c("rdiv", "sign")]) 
dd1.2$cor <- "negative"
dd1.2$z1 <- "low"
dd1.2$E1_mean <- "medium"

dd1.3 <- data.frame(rdiv_1.3[, c("rdiv", "sign")]) 
dd1.3$cor <- "negative"
dd1.3$z1 <- "low"
dd1.3$E1_mean <- "high"


dd2 <- data.frame(rdiv_2[, c("rdiv", "sign")]) 
dd2$cor <- "negative"
dd2$z1 <- "medium"
dd2$E1_mean <- "low"

dd2.2 <- data.frame(rdiv_2.2[, c("rdiv", "sign")]) 
dd2.2$cor <- "negative"
dd2.2$z1 <- "medium"
dd2.2$E1_mean <- "medium"

dd2.3 <- data.frame(rdiv_2.3[, c("rdiv", "sign")]) 
dd2.3$cor <- "negative"
dd2.3$z1 <- "medium"
dd2.3$E1_mean <- "high"

dd3 <- data.frame(rdiv_3[, c("rdiv", "sign")]) 
dd3$cor <- "negative"
dd3$z1 <- "high"
dd3$E1_mean <-"low"


dd3.2 <- data.frame(rdiv_3.2[, c("rdiv", "sign")]) 
dd3.2$cor <- "negative"
dd3.2$z1 <- "high"
dd3.2$E1_mean <- "medium"

dd3.3 <- data.frame(rdiv_3.3[, c("rdiv", "sign")]) 
dd3.3$cor <- "negative"
dd3.3$z1 <- "high"
dd3.3$E1_mean <- "high"
```



## Fluctuation in environmental change - positive correlation

Increasing variance in z1 and z2 - positive correlation between env variables (E1 and E2) 

Same steps as before (3 communities with increasing diversity in z1 while z2 is fixed), but the correlation between E1 and E1 is positive

```{r}
E1max<-350; E1min<-250
E2max<- 70; E2min<- -25
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(  20                         ,   20                         ,
                                       20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(  20                         ,   20                         ,
                                       20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#
### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(  20                         ,   20                         ,
                                       20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


detach("package:MASS", unload=TRUE)

```

```{r}
# create reproducible community
set.seed(2456)
### Community 1 - low diversity in z1.
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)


species_pars$z1_range <- 25
species_pars$z2_range <- 25

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)

### Community 3 - high diversity in z1. 

species_pars$z1_range <- 50
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)

```

### Response diversity calculation

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```


```{r}
# Preparing data sets for overview plots
dd4 <- data.frame(rdiv_1[, c("rdiv", "sign")]) 
dd4$cor <- "positive"
dd4$z1 <- "low"
dd4$E1_mean <- "low"

dd4.2 <- data.frame(rdiv_1.2[, c("rdiv", "sign")]) 
dd4.2$cor <- "positive"
dd4.2$z1 <- "low"
dd4.2$E1_mean <- "medium"

dd4.3 <- data.frame(rdiv_1.3[, c("rdiv", "sign")]) 
dd4.3$cor <- "positive"
dd4.3$z1 <- "low"
dd4.3$E1_mean <- "high"


dd5 <- data.frame(rdiv_2[, c("rdiv", "sign")]) 
dd5$cor <- "positive"
dd5$z1 <- "medium"
dd5$E1_mean <- "low"

dd5.2 <- data.frame(rdiv_2.2[, c("rdiv", "sign")]) 
dd5.2$cor <- "positive"
dd5.2$z1 <- "medium"
dd5.2$E1_mean <- "medium"

dd5.3 <- data.frame(rdiv_2.3[, c("rdiv", "sign")]) 
dd5.3$cor <- "positive"
dd5.3$z1 <- "medium"
dd5.3$E1_mean <- "high"

dd6 <- data.frame(rdiv_3[, c("rdiv", "sign")]) 
dd6$cor <- "positive"
dd6$z1 <- "high"
dd6$E1_mean <-"low"


dd6.2 <- data.frame(rdiv_3.2[, c("rdiv", "sign")]) 
dd6.2$cor <- "positive"
dd6.2$z1 <- "high"
dd6.2$E1_mean <- "medium"

dd6.3 <- data.frame(rdiv_3.3[, c("rdiv", "sign")]) 
dd6.3$cor <- "positive"
dd6.3$z1 <- "high"
dd6.3$E1_mean <- "high"
```


## Fluctuation in environmental change - no correlation

Increasing variance in z1 - no correlation between env variables (E1 and E2) 

Same steps as before (3 communities with increasing diversity in z1 while z2 is fixed), but there is no correlation between E1 and E1

```{r }
E1max<-350; E1min<-250
E2max<- 70; E2min<- -25
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(  20                         , 0.0,
                                     0.0,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))



### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(  20                         , 0.0,
                                     0.0,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(  20                         , 0.0,
                                     0.0,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


detach("package:MASS", unload=TRUE)

```

```{r}
# create reproducible community
set.seed(2456)
### Community 1 - low diversity in z1.
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)


species_pars$z1_range <- 25
species_pars$z2_range <- 25

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)

### Community 3 - high diversity in z1. 

species_pars$z1_range <- 50
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)

```

### Response diversity calculation

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```


```{r}
# Preparing data sets for overview plots
dd7 <- data.frame(rdiv_1[, c("rdiv", "sign")]) 
dd7$cor <- "no cor"
dd7$z1 <- "low"
dd7$E1_mean <- "low"

dd7.2 <- data.frame(rdiv_1.2[, c("rdiv", "sign")]) 
dd7.2$cor <- "no cor"
dd7.2$z1 <- "low"
dd7.2$E1_mean <- "medium"

dd7.3 <- data.frame(rdiv_1.3[, c("rdiv", "sign")]) 
dd7.3$cor <- "no cor"
dd7.3$z1 <- "low"
dd7.3$E1_mean <- "high"


dd8 <- data.frame(rdiv_2[, c("rdiv", "sign")]) 
dd8$cor <- "no cor"
dd8$z1 <- "medium"
dd8$E1_mean <- "low"

dd8.2 <- data.frame(rdiv_2.2[, c("rdiv", "sign")]) 
dd8.2$cor <- "no cor"
dd8.2$z1 <- "medium"
dd8.2$E1_mean <- "medium"

dd8.3 <- data.frame(rdiv_2.3[, c("rdiv", "sign")]) 
dd8.3$cor <- "no cor"
dd8.3$z1 <- "medium"
dd8.3$E1_mean <- "high"

dd9 <- data.frame(rdiv_3[, c("rdiv", "sign")]) 
dd9$cor <- "no cor"
dd9$z1 <- "high"
dd9$E1_mean <-"low"


dd9.2 <- data.frame(rdiv_3.2[, c("rdiv", "sign")]) 
dd9.2$cor <- "no cor"
dd9.2$z1 <- "high"
dd9.2$E1_mean <- "medium"

dd9.3 <- data.frame(rdiv_3.3[, c("rdiv", "sign")]) 
dd9.3$cor <- "no cor"
dd9.3$z1 <- "high"
dd9.3$E1_mean <- "high"
```



## Creating dataset

```{r}

dd_plot1 <- rbind(dd1[,c(1,3:5)], dd1.2[,c(1,3:5)],dd1.3[,c(1,3:5)],
                  dd2[,c(1,3:5)], dd2.2[,c(1,3:5)],dd2.3[,c(1,3:5)],
                  dd3[,c(1,3:5)], dd3.2[,c(1,3:5)],dd3.3[,c(1,3:5)],
                  dd4[,c(1,3:5)], dd4.2[,c(1,3:5)],dd4.3[,c(1,3:5)],
                  dd5[,c(1,3:5)], dd5.2[,c(1,3:5)],dd5.3[,c(1,3:5)], 
                  dd6[,c(1,3:5)], dd6.2[,c(1,3:5)],dd6.3[,c(1,3:5)],
                  dd7[,c(1,3:5)], dd7.2[,c(1,3:5)],dd7.3[,c(1,3:5)],
                  dd8[,c(1,3:5)], dd8.2[,c(1,3:5)],dd8.3[,c(1,3:5)],
                  dd9[,c(1,3:5)], dd9.2[,c(1,3:5)],dd9.3[,c(1,3:5)])
dd_plot1$E1_mean <- factor(dd_plot1$E1_mean, levels = c("low", "medium", "high"))

dd_dissimilarity_scenario2 <- dd_plot1


dd_plot2 <- rbind(dd1[,c(2,3:5)], dd1.2[,c(2,3:5)],dd1.3[,c(2,3:5)],
                  dd2[,c(2,3:5)], dd2.2[,c(2,3:5)],dd2.3[,c(2,3:5)],
                  dd3[,c(2,3:5)], dd3.2[,c(2,3:5)],dd3.3[,c(2,3:5)],
                  dd4[,c(2,3:5)], dd4.2[,c(2,3:5)],dd4.3[,c(2,3:5)],
                  dd5[,c(2,3:5)], dd5.2[,c(2,3:5)],dd5.3[,c(2,3:5)], 
                  dd6[,c(2,3:5)], dd6.2[,c(2,3:5)],dd6.3[,c(2,3:5)],
                  dd7[,c(2,3:5)], dd7.2[,c(2,3:5)],dd7.3[,c(2,3:5)],
                  dd8[,c(2,3:5)], dd8.2[,c(2,3:5)],dd8.3[,c(2,3:5)],
                  dd9[,c(2,3:5)], dd9.2[,c(2,3:5)],dd9.3[,c(2,3:5)])
dd_plot2$E1_mean <- factor(dd_plot2$E1_mean, levels = c("low", "medium", "high"))
dd_divergence_scenario2 <- dd_plot2


```


# Variation in diversity in z1 and z2

Now we do the same, but having also z2 changing together with z1 with negative correlation. So, diversity in z1 is increasing gradually from low to high in the 3 communities, while z2 decreases gradually in the 3 communities.

## fluctuation in environmental change - negative correlation

Increasing variance in z1 and z2 - negative correlation between env variables (E1 and E2).

We now create 3 communities. Community 1 is characterized by low diversity in z1 and high diversity in z2, community 2 has medium diversity in z1 and z2, and community 3 has high diversity in z1 and low in z2.

E1 and E2 have  *negative* correlation.

```{r}
# Specify the correlation E1 and E2 
#negative in this example and high variation in E1 and E2 
E1max<-350; E1min<-250
E2max<- 70; E2min<- -25

# Scenario 1 - low mean vakues of E1 and E2
theme_set(theme_classic(base_size = 12))
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(  200                         , -  20                         ,
                                     -  20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(  20                         , -  20                         ,
                                     -  20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))



### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(  20                         , -  20                         ,
                                     -  20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


detach("package:MASS", unload=TRUE)

```

### Community 1 - low diversity in z1.

```{r}
## Set species parameters
species_pars <- list(a1_mean = 1e-9,
  b1_mean = 0.063,
  z1_mean = 285,
  w1_mean = 60,
  a2_mean = 1e-3,
  b2_mean = 0.02,
  z2_mean = 20,
  w2_mean = 10,
  zint_mean = 0,
  sd_rate_mean = 0,
  z1_range = NA,
  z2_range = NA)

```

```{r plotcomm1_mix, fig.cap='Community 1, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=20, fig.width=12}
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm1 <- multi_performance_plot(comm)
performance_comm1

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)
```

```{r}
# Find optimum for E1 and E1 for each sp 
optima_com1 <- get_optima(comm, new_data)
optima_com1$community <- 1
```

```{r}
# Calculate absolute response diversity for community 1 - scenario 3

# Unknown env conditions - get all surface
refs <- crossing(E1 = 273.15 + seq(0, 50, 10),
                     E2 = seq(0, 50, 10))

nested_gams <- comm %>% 
    nest(cols =-species) %>% 
    mutate(
      gams = map(cols, ~ gam(rate ~  te(E1, E2),
                             data = .x,
                             method = "REML")),
      predicted = map(gams, ~ predict(.x, newdata = new_data))
    )
  
  #list of gams
  m_list <- (nested_gams$gams)
  #list of spp names
  my_spp_names <- (nested_gams$species)
  # get partial derivatives
  pd_list <- modify_depth(m_list, 1, ~ get_partials(., refs))
  # from list to tibble
  pd_spp <- tibble(
    E1_ref = map(pd_list, "E1"),
    E2_ref = map(pd_list, "E2"),
    pd_E1 = map(pd_list, "pd_E1"),
    pd_E2 = map(pd_list, "pd_E2")) %>%
      dplyr::mutate(sp = my_spp_names) %>%
      relocate(sp, E1_ref, E2_ref, pd_E1, pd_E2) %>%
      unnest(E1_ref, E2_ref, pd_E1, pd_E2)
  
  radius <- 1
num_arrows <- 100
pd_spp <- crossing(angle = rep(seq(0, 2*pi, length = num_arrows)),
              E1_ref = pd_spp$E1_ref,
              E2_ref =pd_spp$E2_ref) %>%
  full_join(pd_spp) %>%
  mutate(E1 = cos(angle) * radius,
         E2 = sin(angle) * radius,
         dir_deriv = E1 * pd_E1 + E2 * pd_E2,
         unit_vec_mag = sqrt(E1^2 + E2^2))



# filter useless stuff
pd_spp <- pd_spp %>% 
  dplyr::select(angle, sp, E1_ref, E2_ref, dir_deriv)

#
# Calculating diversity for each direction and location this should be always the first step
# Dissimilarity
Div_loc_dir_comm1.3 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = F))



RDiv_comm1.3 <- tibble(Div_loc_dir_comm1.3 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
  summarise(mean = mean(div)) %>% 
  ungroup() %>% 
  summarise(dissimilarity = mean(mean)))

Div_loc_dir2_comm1.3 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = T))


RDiv1_comm1.3 <- tibble(Div_loc_dir2_comm1.3 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
                 summarise(mean = mean(div)) %>% 
                 ungroup() %>% 
                 summarise(divergence = mean(mean))) %>% 
  cbind(RDiv_comm1.3)

  
```
### Community 2 - medium diversity in z1.

```{r plotcomm2_mix, fig.cap='Community 2, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=20, fig.width=12}
species_pars$z1_range <- 25
species_pars$z2_range <- 25

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm2 <- multi_performance_plot(comm)
performance_comm2
# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)

```

```{r}
# Find optimum for E1 and E1 for each sp 
optima_com2 <- get_optima(comm, new_data)
optima_com2$community <- 2
```


```{r}
# Calculate absolute response diversity for community 2 - scenario 3 

# Unknown env conditions - get all surface
refs <- crossing(E1 = 273.15 + seq(0, 50, 10),
                     E2 = seq(0, 50, 10))

nested_gams <- comm %>% 
    nest(cols =-species) %>% 
    mutate(
      gams = map(cols, ~ gam(rate ~  te(E1, E2),
                             data = .x,
                             method = "REML")),
      predicted = map(gams, ~ predict(.x, newdata = new_data))
    )
  
  #list of gams
  m_list <- (nested_gams$gams)
  #list of spp names
  my_spp_names <- (nested_gams$species)
  # get partial derivatives
  pd_list <- modify_depth(m_list, 1, ~ get_partials(., refs))
  # from list to tibble
  pd_spp <- tibble(
    E1_ref = map(pd_list, "E1"),
    E2_ref = map(pd_list, "E2"),
    pd_E1 = map(pd_list, "pd_E1"),
    pd_E2 = map(pd_list, "pd_E2")) %>%
      dplyr::mutate(sp = my_spp_names) %>%
      relocate(sp, E1_ref, E2_ref, pd_E1, pd_E2) %>%
      unnest(E1_ref, E2_ref, pd_E1, pd_E2)
  
  radius <- 1
num_arrows <- 100
pd_spp <- crossing(angle = rep(seq(0, 2*pi, length = num_arrows)),
              E1_ref = pd_spp$E1_ref,
              E2_ref =pd_spp$E2_ref) %>%
  full_join(pd_spp) %>%
  mutate(E1 = cos(angle) * radius,
         E2 = sin(angle) * radius,
         dir_deriv = E1 * pd_E1 + E2 * pd_E2,
         unit_vec_mag = sqrt(E1^2 + E2^2))



# filter useless stuff
pd_spp <- pd_spp %>% 
  dplyr::select(angle, sp, E1_ref, E2_ref, dir_deriv)

#
# Calculating diversity for each direction and location this should be always the first step
# Dissimilarity
Div_loc_dir_comm2.3 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = F))



RDiv_comm2.3 <- tibble(Div_loc_dir_comm2.3 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
  summarise(mean = mean(div)) %>% 
  ungroup() %>% 
  summarise(dissimilarity = mean(mean)))

Div_loc_dir2_comm2.3 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = T))


RDiv1_comm2.3 <- tibble(Div_loc_dir2_comm2.3 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
                 summarise(mean = mean(div)) %>% 
                 ungroup() %>% 
                 summarise(divergence = mean(mean))) %>% 
  cbind(RDiv_comm2.3)

  
```


### Community 3 - high diversity in z1.

```{r plotcomm3_mix, fig.cap=' Community 3, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=20, fig.width=12}
species_pars$z1_range <- 50
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm3 <- multi_performance_plot(comm)
performance_comm3
# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)
```

```{r}
# Find optimum for E1 and E1 for each sp 
optima_com3 <- get_optima(comm, new_data)
optima_com3$community <- 3
```

```{r}
# Calculate absolute response diversity for community 3 - scenario 2 

# Unknown env conditions - get all surface
refs <- crossing(E1 = 273.15 + seq(0, 50, 10),
                     E2 = seq(0, 50, 10))

nested_gams <- comm %>% 
    nest(cols =-species) %>% 
    mutate(
      gams = map(cols, ~ gam(rate ~  te(E1, E2),
                             data = .x,
                             method = "REML")),
      predicted = map(gams, ~ predict(.x, newdata = new_data))
    )
  
  #list of gams
  m_list <- (nested_gams$gams)
  #list of spp names
  my_spp_names <- (nested_gams$species)
  # get partial derivatives
  pd_list <- modify_depth(m_list, 1, ~ get_partials(., refs))
  # from list to tibble
  pd_spp <- tibble(
    E1_ref = map(pd_list, "E1"),
    E2_ref = map(pd_list, "E2"),
    pd_E1 = map(pd_list, "pd_E1"),
    pd_E2 = map(pd_list, "pd_E2")) %>%
      dplyr::mutate(sp = my_spp_names) %>%
      relocate(sp, E1_ref, E2_ref, pd_E1, pd_E2) %>%
      unnest(E1_ref, E2_ref, pd_E1, pd_E2)
  
  radius <- 1
num_arrows <- 100
pd_spp <- crossing(angle = rep(seq(0, 2*pi, length = num_arrows)),
              E1_ref = pd_spp$E1_ref,
              E2_ref =pd_spp$E2_ref) %>%
  full_join(pd_spp) %>%
  mutate(E1 = cos(angle) * radius,
         E2 = sin(angle) * radius,
         dir_deriv = E1 * pd_E1 + E2 * pd_E2,
         unit_vec_mag = sqrt(E1^2 + E2^2))



# filter useless stuff
pd_spp <- pd_spp %>% 
  dplyr::select(angle, sp, E1_ref, E2_ref, dir_deriv)

#
# Calculating diversity for each direction and location this should be always the first step
# Dissimilarity
Div_loc_dir_comm3.3 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = F))



RDiv_comm3.3 <- tibble(Div_loc_dir_comm3.3 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
  summarise(mean = mean(div)) %>% 
  ungroup() %>% 
  summarise(dissimilarity = mean(mean)))

Div_loc_dir2_comm3.3 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = T))


RDiv1_comm3.3 <- tibble(Div_loc_dir2_comm3.3 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
                 summarise(mean = mean(div)) %>% 
                 ungroup() %>% 
                 summarise(divergence = mean(mean))) %>% 
  cbind(RDiv_comm3.3)

```

### Potential response diversity
```{r}
RDiv1_comm1.3$community <- 1
RDiv1_comm2.3$community <- 2
RDiv1_comm3.3$community <- 3
Absolute_RD_3 <- rbind(RDiv1_comm1.3, RDiv1_comm2.3, RDiv1_comm3.3)

#change to long format
Absolute_RD_3 <- pivot_longer(Absolute_RD_3, cols = "dissimilarity":"divergence", names_to = "RDiv",
                                values_to = "value", values_drop_na = TRUE)

Absolute_RD_3$community <- as.factor(Absolute_RD_3$community)

```


## Potential response diveristy across scenarios - here we create the data set to campare the potential response diversity in the three different scenarios we created above. That is, we compare potential dissimilarity and divergence in communities changing only in z1, in communities changing in z1 and z2 with positive correlation, and communities changing in z1 and z2 with negative correlation. 
```{r }
# preparing data for overview plotting
Absolute_RD_1$scenario <- 1
Absolute_RD_2$scenario <- 2
Absolute_RD_3$scenario <- 3
Absolute_RD <- rbind(Absolute_RD_1, Absolute_RD_2, Absolute_RD_3)

Absolute_RD$scenario <- as.factor(Absolute_RD$scenario)
Absolute_RD$community <- factor(Absolute_RD$community, levels = c(3,2,1))
```


### Position of the optimum

Here and elsewhere in this document, the position of the optima has been estimated as the environmental location (E1 and E2 values) for which the rate is maximum.

```{r}
optima_scenario3 <- rbind(optima_com1, optima_com2, optima_com3)

```



### Response diversity calculation - first scenario (low mean values of E1 and E2)

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```



```{r}
# preparing data sets for overview plots
dd1 <- data.frame(rdiv_1[, c("rdiv", "sign")]) 
dd1$cor <- "negative"
dd1$z1 <- "low"
dd1$E1_mean <- "low"

dd1.2 <- data.frame(rdiv_1.2[, c("rdiv", "sign")]) 
dd1.2$cor <- "negative"
dd1.2$z1 <- "low"
dd1.2$E1_mean <- "medium"

dd1.3 <- data.frame(rdiv_1.3[, c("rdiv", "sign")]) 
dd1.3$cor <- "negative"
dd1.3$z1 <- "low"
dd1.3$E1_mean <- "high"


dd2 <- data.frame(rdiv_2[, c("rdiv", "sign")]) 
dd2$cor <- "negative"
dd2$z1 <- "medium"
dd2$E1_mean <- "low"

dd2.2 <- data.frame(rdiv_2.2[, c("rdiv", "sign")]) 
dd2.2$cor <- "negative"
dd2.2$z1 <- "medium"
dd2.2$E1_mean <- "medium"

dd2.3 <- data.frame(rdiv_2.3[, c("rdiv", "sign")]) 
dd2.3$cor <- "negative"
dd2.3$z1 <- "medium"
dd2.3$E1_mean <- "high"

dd3 <- data.frame(rdiv_3[, c("rdiv", "sign")]) 
dd3$cor <- "negative"
dd3$z1 <- "high"
dd3$E1_mean <-"low"


dd3.2 <- data.frame(rdiv_3.2[, c("rdiv", "sign")]) 
dd3.2$cor <- "negative"
dd3.2$z1 <- "high"
dd3.2$E1_mean <- "medium"

dd3.3 <- data.frame(rdiv_3.3[, c("rdiv", "sign")]) 
dd3.3$cor <- "negative"
dd3.3$z1 <- "high"
dd3.3$E1_mean <- "high"
```


## Fluctuation in environmental change - positive correlation

Increasing variance in z1 and z2 - positive correlation between env variables (E1 and E2) 

Same steps as before (3 communities with increasing diversity in z1 while z2 is fixed), but the correlation between E1 and E1 is positive

```{r }
E1max<-350; E1min<-250
E2max<- 70; E2min<- -25
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(  20                         ,   20                         ,
                                       20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))




### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(  20                         ,   20                         ,
                                       20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(  20                         ,   20                         ,
                                       20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


detach("package:MASS", unload=TRUE)

```

```{r}
# create reproducible community
set.seed(2456)
### Community 1 - low diversity in z1.
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)


species_pars$z1_range <- 25
species_pars$z2_range <- 25

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)

### Community 3 - high diversity in z1. 

species_pars$z1_range <- 50
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)

```

### Response diversity calculation

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```

```{r}
# preparing data sets for overview plots
dd4 <- data.frame(rdiv_1[, c("rdiv", "sign")]) 
dd4$cor <- "positive"
dd4$z1 <- "low"
dd4$E1_mean <- "low"

dd4.2 <- data.frame(rdiv_1.2[, c("rdiv", "sign")]) 
dd4.2$cor <- "positive"
dd4.2$z1 <- "low"
dd4.2$E1_mean <- "medium"

dd4.3 <- data.frame(rdiv_1.3[, c("rdiv", "sign")]) 
dd4.3$cor <- "positive"
dd4.3$z1 <- "low"
dd4.3$E1_mean <- "high"


dd5 <- data.frame(rdiv_2[, c("rdiv", "sign")]) 
dd5$cor <- "positive"
dd5$z1 <- "medium"
dd5$E1_mean <- "low"

dd5.2 <- data.frame(rdiv_2.2[, c("rdiv", "sign")]) 
dd5.2$cor <- "positive"
dd5.2$z1 <- "medium"
dd5.2$E1_mean <- "medium"

dd5.3 <- data.frame(rdiv_2.3[, c("rdiv", "sign")]) 
dd5.3$cor <- "positive"
dd5.3$z1 <- "medium"
dd5.3$E1_mean <- "high"

dd6 <- data.frame(rdiv_3[, c("rdiv", "sign")]) 
dd6$cor <- "positive"
dd6$z1 <- "high"
dd6$E1_mean <-"low"


dd6.2 <- data.frame(rdiv_3.2[, c("rdiv", "sign")]) 
dd6.2$cor <- "positive"
dd6.2$z1 <- "high"
dd6.2$E1_mean <- "medium"

dd6.3 <- data.frame(rdiv_3.3[, c("rdiv", "sign")]) 
dd6.3$cor <- "positive"
dd6.3$z1 <- "high"
dd6.3$E1_mean <- "high"
```

## Fluctuation in environmental change - no correlation

Increasing variance in z1 - no correlation between env variables (E1 and E2)

Same steps as before (3 communities with increasing diversity in z1 while z2 is fixed), but there is no correlation between E1 and E1

```{r}
E1max<-350; E1min<-250
E2max<- 70; E2min<- -25
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(  20                         , 0.0,
                                     0.0,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(  20                         , 0.0,
                                     0.0,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(  20                         , 0.0,
                                     0.0,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))



detach("package:MASS", unload=TRUE)

```

```{r}
# create reproducible community
set.seed(2456)
### Community 1 - low diversity in z1.
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)


species_pars$z1_range <- 25
species_pars$z2_range <- 25

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)

### Community 3 - high diversity in z1. 

species_pars$z1_range <- 50
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)

```

### Response diversity calculation

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```


```{r}
# preparing data sets for overview plots
dd7 <- data.frame(rdiv_1[, c("rdiv", "sign")]) 
dd7$cor <- "no cor"
dd7$z1 <- "low"
dd7$E1_mean <- "low"

dd7.2 <- data.frame(rdiv_1.2[, c("rdiv", "sign")]) 
dd7.2$cor <- "no cor"
dd7.2$z1 <- "low"
dd7.2$E1_mean <- "medium"

dd7.3 <- data.frame(rdiv_1.3[, c("rdiv", "sign")]) 
dd7.3$cor <- "no cor"
dd7.3$z1 <- "low"
dd7.3$E1_mean <- "high"


dd8 <- data.frame(rdiv_2[, c("rdiv", "sign")]) 
dd8$cor <- "no cor"
dd8$z1 <- "medium"
dd8$E1_mean <- "low"

dd8.2 <- data.frame(rdiv_2.2[, c("rdiv", "sign")]) 
dd8.2$cor <- "no cor"
dd8.2$z1 <- "medium"
dd8.2$E1_mean <- "medium"

dd8.3 <- data.frame(rdiv_2.3[, c("rdiv", "sign")]) 
dd8.3$cor <- "no cor"
dd8.3$z1 <- "medium"
dd8.3$E1_mean <- "high"

dd9 <- data.frame(rdiv_3[, c("rdiv", "sign")]) 
dd9$cor <- "no cor"
dd9$z1 <- "high"
dd9$E1_mean <-"low"


dd9.2 <- data.frame(rdiv_3.2[, c("rdiv", "sign")]) 
dd9.2$cor <- "no cor"
dd9.2$z1 <- "high"
dd9.2$E1_mean <- "medium"

dd9.3 <- data.frame(rdiv_3.3[, c("rdiv", "sign")]) 
dd9.3$cor <- "no cor"
dd9.3$z1 <- "high"
dd9.3$E1_mean <- "high"
```



## Preparing data set

```{r }

dd_plot1 <- rbind(dd1[,c(1,3:5)], dd1.2[,c(1,3:5)],dd1.3[,c(1,3:5)],
                  dd2[,c(1,3:5)], dd2.2[,c(1,3:5)],dd2.3[,c(1,3:5)],
                  dd3[,c(1,3:5)], dd3.2[,c(1,3:5)],dd3.3[,c(1,3:5)],
                  dd4[,c(1,3:5)], dd4.2[,c(1,3:5)],dd4.3[,c(1,3:5)],
                  dd5[,c(1,3:5)], dd5.2[,c(1,3:5)],dd5.3[,c(1,3:5)], 
                  dd6[,c(1,3:5)], dd6.2[,c(1,3:5)],dd6.3[,c(1,3:5)],
                  dd7[,c(1,3:5)], dd7.2[,c(1,3:5)],dd7.3[,c(1,3:5)],
                  dd8[,c(1,3:5)], dd8.2[,c(1,3:5)],dd8.3[,c(1,3:5)],
                  dd9[,c(1,3:5)], dd9.2[,c(1,3:5)],dd9.3[,c(1,3:5)])
dd_plot1$z1 <- factor(dd_plot1$z1, levels = c("low", "medium", "high"))
dd_plot1$E1_mean <- factor(dd_plot1$E1_mean, levels = c("low", "medium", "high"))
dd_dissimilarity_scenario3 <- dd_plot1
theme_set(theme_classic(base_size = 12))



dd_plot2 <- rbind(dd1[,c(2,3:5)], dd1.2[,c(2,3:5)],dd1.3[,c(2,3:5)],
                  dd2[,c(2,3:5)], dd2.2[,c(2,3:5)],dd2.3[,c(2,3:5)],
                  dd3[,c(2,3:5)], dd3.2[,c(2,3:5)],dd3.3[,c(2,3:5)],
                  dd4[,c(2,3:5)], dd4.2[,c(2,3:5)],dd4.3[,c(2,3:5)],
                  dd5[,c(2,3:5)], dd5.2[,c(2,3:5)],dd5.3[,c(2,3:5)], 
                  dd6[,c(2,3:5)], dd6.2[,c(2,3:5)],dd6.3[,c(2,3:5)],
                  dd7[,c(2,3:5)], dd7.2[,c(2,3:5)],dd7.3[,c(2,3:5)],
                  dd8[,c(2,3:5)], dd8.2[,c(2,3:5)],dd8.3[,c(2,3:5)],
                  dd9[,c(2,3:5)], dd9.2[,c(2,3:5)],dd9.3[,c(2,3:5)])
dd_plot2$z1 <- factor(dd_plot2$z1, levels = c("low", "medium", "high"))
dd_plot2$E1_mean <- factor(dd_plot2$E1_mean, levels = c("low", "medium", "high"))
dd_divergence_scenario3 <- dd_plot2


```




# Equal effect of temperature and salinity on species growth rate. 

Now, we repeat the same steps as in the first part of the analysis, but with temperature and salinity having the same effect on species' growth rate. 



```{r}
## define the series of values of the environmental variables
E1_series <- seq(0, 50, 1)
E2_series <- seq(0, 50, 1)

## define new_data for following GAM fitting

new_data <- tibble(E1 =  seq(0, 50, 0.2),
                   E2 = seq(0, 50, 0.2))
```


## fluctuation in environmental change - negative correlation
```{r }
# Specify the correlation E1 and E2 
#negative in this example and high variation in E1 and E2 
E1max<- 70; E1min<- -25
E2max<- 70; E2min<- -25

# Scenario 1 - low mean values of E1 and E2

library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(20, -20,
                                     -20, 20),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))




### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(  20                         , -  20                         ,
                                     -  20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))



### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(  20                         , -  20                         ,
                                     -  20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


detach("package:MASS", unload=TRUE)

```

### Community 1 - low diversity in z1.

```{r}
## Set species parameters
species_pars <- list(a1_mean = 1e-3,
  b1_mean = 0.02,
  z1_mean = 20,
  w1_mean = 10,
  a2_mean = 1e-3,
  b2_mean = 0.02,
  z2_mean = 20,
  w2_mean = 10,
  zint_mean = 0,
  sd_rate_mean = 0,
  z1_range = NA,
  z2_range = NA)

```

```{r plotcomm1_neg1, fig.cap='Community 1, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=20, fig.width=12}
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 15

# create reproducible community
set.seed(6878)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm1 <- multi_performance_plot(comm)
performance_comm1

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)
```

```{r}
# Find optimum for E1 and E1 for each sp 
optima_com1 <- get_optima(comm, new_data)
optima_com1$community <- 1
```

```{r}
# Calculate absolute response diversity for community 1 - scenario 1 

# Unknown env conditions - get all surface
refs <- crossing(E1 = seq(0, 50, 10),
                     E2 = seq(0, 50, 10))

nested_gams <- comm %>% 
    nest(cols =-species) %>% 
    mutate(
      gams = map(cols, ~ gam(rate ~  te(E1, E2),
                             data = .x,
                             method = "REML")),
      predicted = map(gams, ~ predict(.x, newdata = new_data))
    )
  
  #list of gams
  m_list <- (nested_gams$gams)
  #list of spp names
  my_spp_names <- (nested_gams$species)
  # get partial derivatives
  pd_list <- modify_depth(m_list, 1, ~ get_partials(., refs))
  # from list to tibble
  pd_spp <- tibble(
    E1_ref = map(pd_list, "E1"),
    E2_ref = map(pd_list, "E2"),
    pd_E1 = map(pd_list, "pd_E1"),
    pd_E2 = map(pd_list, "pd_E2")) %>%
      dplyr::mutate(sp = my_spp_names) %>%
      relocate(sp, E1_ref, E2_ref, pd_E1, pd_E2) %>%
      unnest(E1_ref, E2_ref, pd_E1, pd_E2)
  
  radius <- 1
num_arrows <- 100
pd_spp <- crossing(angle = rep(seq(0, 2*pi, length = num_arrows)),
              E1_ref = pd_spp$E1_ref,
              E2_ref =pd_spp$E2_ref) %>%
  full_join(pd_spp) %>%
  mutate(E1 = cos(angle) * radius,
         E2 = sin(angle) * radius,
         dir_deriv = E1 * pd_E1 + E2 * pd_E2,
         unit_vec_mag = sqrt(E1^2 + E2^2))



# filter useless stuff
pd_spp <- pd_spp %>% 
  dplyr::select(angle, sp, E1_ref, E2_ref, dir_deriv)

#
# Calculating diversity for each direction and location this should be always the first step
# Dissimilarity
Div_loc_dir_comm1.1 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = F))



RDiv_comm1.1 <- tibble(Div_loc_dir_comm1.1 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
  summarise(mean = mean(div)) %>% 
  ungroup() %>% 
  summarise(dissimilarity = mean(mean)))

Div_loc_dir2_comm1.1 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = T))


RDiv1_comm1.1 <- tibble(Div_loc_dir2_comm1.1 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
                 summarise(mean = mean(div)) %>% 
                 ungroup() %>% 
                 summarise(divergence = mean(mean))) %>% 
  cbind(RDiv_comm1.1)

  
```

### Community 2 - medium diversity in z1.

```{r plotcomm2_neg1, fig.cap='Community 2, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=20, fig.width=12}
species_pars$z1_range <- 25
species_pars$z2_range <- 15

# create reproducible community
set.seed(3455)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm2 <- multi_performance_plot(comm)
performance_comm2
# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)

```

```{r}
# Find optimum for E1 and E1 for each sp 
optima_com2 <- get_optima(comm, new_data)
optima_com2$community <- 2
```


```{r}
# Calculate absolute response diversity for community 2 - scenario 1 

# Unknown env conditions - get all surface
refs <- crossing(E1 = seq(0, 50, 10),
                     E2 = seq(0, 50, 10))

nested_gams <- comm %>% 
    nest(cols =-species) %>% 
    mutate(
      gams = map(cols, ~ gam(rate ~  te(E1, E2),
                             data = .x,
                             method = "REML")),
      predicted = map(gams, ~ predict(.x, newdata = new_data))
    )
  
  #list of gams
  m_list <- (nested_gams$gams)
  #list of spp names
  my_spp_names <- (nested_gams$species)
  # get partial derivatives
  pd_list <- modify_depth(m_list, 1, ~ get_partials(., refs))
  # from list to tibble
  pd_spp <- tibble(
    E1_ref = map(pd_list, "E1"),
    E2_ref = map(pd_list, "E2"),
    pd_E1 = map(pd_list, "pd_E1"),
    pd_E2 = map(pd_list, "pd_E2")) %>%
      dplyr::mutate(sp = my_spp_names) %>%
      relocate(sp, E1_ref, E2_ref, pd_E1, pd_E2) %>%
      unnest(E1_ref, E2_ref, pd_E1, pd_E2)
  
  radius <- 1
num_arrows <- 100
pd_spp <- crossing(angle = rep(seq(0, 2*pi, length = num_arrows)),
              E1_ref = pd_spp$E1_ref,
              E2_ref =pd_spp$E2_ref) %>%
  full_join(pd_spp) %>%
  mutate(E1 = cos(angle) * radius,
         E2 = sin(angle) * radius,
         dir_deriv = E1 * pd_E1 + E2 * pd_E2,
         unit_vec_mag = sqrt(E1^2 + E2^2))



# filter useless stuff
pd_spp <- pd_spp %>% 
  dplyr::select(angle, sp, E1_ref, E2_ref, dir_deriv)

#
# Calculating diversity for each direction and location this should be always the first step
# Dissimilarity
Div_loc_dir_comm2.1 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = F))



RDiv_comm2.1 <- tibble(Div_loc_dir_comm2.1 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
  summarise(mean = mean(div)) %>% 
  ungroup() %>% 
  summarise(dissimilarity = mean(mean)))

Div_loc_dir2_comm2.1 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = T))


RDiv1_comm2.1 <- tibble(Div_loc_dir2_comm2.1 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
                 summarise(mean = mean(div)) %>% 
                 ungroup() %>% 
                 summarise(divergence = mean(mean))) %>% 
  cbind(RDiv_comm2.1)

  
```



### Community 3 - high diversity in z1.

```{r plotcomm3_neg1, fig.cap=' Community 3, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=20, fig.width=12}
species_pars$z1_range <- 50
species_pars$z2_range <- 15

# create reproducible community
set.seed(6841)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm3 <- multi_performance_plot(comm)
performance_comm3
# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)
```

```{r}
# Find optimum for E1 and E1 for each sp 
optima_com3 <- get_optima(comm, new_data)
optima_com3$community <- 3
```



### Position of the optimum

Here and elsewhere in this document, the position of the optima has been estimated as the environmental location (E1 and E2 values) for which the rate is maximum.

```{r}
optima_scenario1_same <- rbind(optima_com1, optima_com2, optima_com3)

 
```


```{r}
# Calculate absolute response diversity for community 3 - scenario 1 

# Unknown env conditions - get all surface
refs <- crossing(E1 = seq(0, 50, 10),
                     E2 = seq(0, 50, 10))

nested_gams <- comm %>% 
    nest(cols =-species) %>% 
    mutate(
      gams = map(cols, ~ gam(rate ~  te(E1, E2),
                             data = .x,
                             method = "REML")),
      predicted = map(gams, ~ predict(.x, newdata = new_data))
    )
  
  #list of gams
  m_list <- (nested_gams$gams)
  #list of spp names
  my_spp_names <- (nested_gams$species)
  # get partial derivatives
  pd_list <- modify_depth(m_list, 1, ~ get_partials(., refs))
  # from list to tibble
  pd_spp <- tibble(
    E1_ref = map(pd_list, "E1"),
    E2_ref = map(pd_list, "E2"),
    pd_E1 = map(pd_list, "pd_E1"),
    pd_E2 = map(pd_list, "pd_E2")) %>%
      dplyr::mutate(sp = my_spp_names) %>%
      relocate(sp, E1_ref, E2_ref, pd_E1, pd_E2) %>%
      unnest(E1_ref, E2_ref, pd_E1, pd_E2)
  
  radius <- 1
num_arrows <- 100
pd_spp <- crossing(angle = rep(seq(0, 2*pi, length = num_arrows)),
              E1_ref = pd_spp$E1_ref,
              E2_ref =pd_spp$E2_ref) %>%
  full_join(pd_spp) %>%
  mutate(E1 = cos(angle) * radius,
         E2 = sin(angle) * radius,
         dir_deriv = E1 * pd_E1 + E2 * pd_E2,
         unit_vec_mag = sqrt(E1^2 + E2^2))



# filter useless stuff
pd_spp <- pd_spp %>% 
  dplyr::select(angle, sp, E1_ref, E2_ref, dir_deriv)

#
# Calculating diversity for each direction and location this should be always the first step
# Dissimilarity
Div_loc_dir_comm3.1 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = F))



RDiv_comm3.1 <- tibble(Div_loc_dir_comm3.1 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
  summarise(mean = mean(div)) %>% 
  ungroup() %>% 
  summarise(dissimilarity = mean(mean)))

Div_loc_dir2_comm3.1 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = T))


RDiv1_comm3.1 <- tibble(Div_loc_dir2_comm3.1 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
                 summarise(mean = mean(div)) %>% 
                 ungroup() %>% 
                 summarise(divergence = mean(mean))) %>% 
  cbind(RDiv_comm3.1)

```


### Potential response diversity
```{r }
RDiv1_comm1.1$community <- 1
RDiv1_comm2.1$community <- 2
RDiv1_comm3.1$community <- 3
Absolute_RD_1 <- rbind(RDiv1_comm1.1, RDiv1_comm2.1, RDiv1_comm3.1)

# change to long format
Absolute_RD_1 <- pivot_longer(Absolute_RD_1, cols = "dissimilarity":"divergence", names_to = "RDiv",
                                values_to = "value", values_drop_na = TRUE)

Absolute_RD_1$community <- as.factor(Absolute_RD_1$community)

```



### Response diversity calculation - first scenario (low mean values of E1 and E2)

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```



```{r}
# preparing data set for overview plots
dd1 <- data.frame(rdiv_1[, c("rdiv", "sign")]) 
dd1$cor <- "negative"
dd1$z1 <- "low"
dd1$E1_mean <- "low"

dd1.2 <- data.frame(rdiv_1.2[, c("rdiv", "sign")]) 
dd1.2$cor <- "negative"
dd1.2$z1 <- "low"
dd1.2$E1_mean <- "medium"

dd1.3 <- data.frame(rdiv_1.3[, c("rdiv", "sign")]) 
dd1.3$cor <- "negative"
dd1.3$z1 <- "low"
dd1.3$E1_mean <- "high"


dd2 <- data.frame(rdiv_2[, c("rdiv", "sign")]) 
dd2$cor <- "negative"
dd2$z1 <- "medium"
dd2$E1_mean <- "low"

dd2.2 <- data.frame(rdiv_2.2[, c("rdiv", "sign")]) 
dd2.2$cor <- "negative"
dd2.2$z1 <- "medium"
dd2.2$E1_mean <- "medium"

dd2.3 <- data.frame(rdiv_2.3[, c("rdiv", "sign")]) 
dd2.3$cor <- "negative"
dd2.3$z1 <- "medium"
dd2.3$E1_mean <- "high"

dd3 <- data.frame(rdiv_3[, c("rdiv", "sign")]) 
dd3$cor <- "negative"
dd3$z1 <- "high"
dd3$E1_mean <-"low"


dd3.2 <- data.frame(rdiv_3.2[, c("rdiv", "sign")]) 
dd3.2$cor <- "negative"
dd3.2$z1 <- "high"
dd3.2$E1_mean <- "medium"

dd3.3 <- data.frame(rdiv_3.3[, c("rdiv", "sign")]) 
dd3.3$cor <- "negative"
dd3.3$z1 <- "high"
dd3.3$E1_mean <- "high"
```


## Fluctuation in environmental change - positive correlation

Increasing variance in z1 - positive correlation between env variables (E1 and E2) 

Same steps as before (3 communities with increasing diversity ib z1 while z2 is fixed), but the correlation between E1 and E1 is positive

```{r }
E1max<- 70; E1min<- -25
E2max<- 70; E2min<- -25
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(  20                         ,   20                         ,
                                       20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(  20                         ,   20                         ,
                                       20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(  20                         ,   20                         ,
                                       20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


detach("package:MASS", unload=TRUE)

```

```{r}
# create reproducible community
set.seed(2456)
### Community 1 - low diversity in z1.
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)


species_pars$z1_range <- 25
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)

### Community 3 - high diversity in z1. 

species_pars$z1_range <- 50
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)

```

### Response diversity calculation

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```


```{r}
# preparing data set for overview plots
dd4 <- data.frame(rdiv_1[, c("rdiv", "sign")]) 
dd4$cor <- "positive"
dd4$z1 <- "low"
dd4$E1_mean <- "low"

dd4.2 <- data.frame(rdiv_1.2[, c("rdiv", "sign")]) 
dd4.2$cor <- "positive"
dd4.2$z1 <- "low"
dd4.2$E1_mean <- "medium"

dd4.3 <- data.frame(rdiv_1.3[, c("rdiv", "sign")]) 
dd4.3$cor <- "positive"
dd4.3$z1 <- "low"
dd4.3$E1_mean <- "high"


dd5 <- data.frame(rdiv_2[, c("rdiv", "sign")]) 
dd5$cor <- "positive"
dd5$z1 <- "medium"
dd5$E1_mean <- "low"

dd5.2 <- data.frame(rdiv_2.2[, c("rdiv", "sign")]) 
dd5.2$cor <- "positive"
dd5.2$z1 <- "medium"
dd5.2$E1_mean <- "medium"

dd5.3 <- data.frame(rdiv_2.3[, c("rdiv", "sign")]) 
dd5.3$cor <- "positive"
dd5.3$z1 <- "medium"
dd5.3$E1_mean <- "high"

dd6 <- data.frame(rdiv_3[, c("rdiv", "sign")]) 
dd6$cor <- "positive"
dd6$z1 <- "high"
dd6$E1_mean <-"low"


dd6.2 <- data.frame(rdiv_3.2[, c("rdiv", "sign")]) 
dd6.2$cor <- "positive"
dd6.2$z1 <- "high"
dd6.2$E1_mean <- "medium"

dd6.3 <- data.frame(rdiv_3.3[, c("rdiv", "sign")]) 
dd6.3$cor <- "positive"
dd6.3$z1 <- "high"
dd6.3$E1_mean <- "high"
```


## Fluctuation in environmental change - no correlation

Increasing variance in z1 - no correlation between env variables (E1 and E2) 

Same steps as before (3 communities with increasing diversity in z1 while z2 is fixed), but there is no correlation between E1 and E1

```{r }
E1max<- 70; E1min<- -25
E2max<- 70; E2min<- -25
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(  20                         , 0.0,
                                     0.0,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.))) 


### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(  20                         , 0.0,
                                     0.0,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))



### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(  20                         , 0.0,
                                     0.0,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


detach("package:MASS", unload=TRUE)

```

```{r}
# create reproducible community
set.seed(2456)
### Community 1 - low diversity in z1.
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)


species_pars$z1_range <- 25
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)

### Community 3 - high diversity in z1. 

species_pars$z1_range <- 50
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)

```

### Response diversity calculation

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```



```{r}
# preparing data set for overview plots
dd7 <- data.frame(rdiv_1[, c("rdiv", "sign")]) 
dd7$cor <- "no cor"
dd7$z1 <- "low"
dd7$E1_mean <- "low"

dd7.2 <- data.frame(rdiv_1.2[, c("rdiv", "sign")]) 
dd7.2$cor <- "no cor"
dd7.2$z1 <- "low"
dd7.2$E1_mean <- "medium"

dd7.3 <- data.frame(rdiv_1.3[, c("rdiv", "sign")]) 
dd7.3$cor <- "no cor"
dd7.3$z1 <- "low"
dd7.3$E1_mean <- "high"


dd8 <- data.frame(rdiv_2[, c("rdiv", "sign")]) 
dd8$cor <- "no cor"
dd8$z1 <- "medium"
dd8$E1_mean <- "low"

dd8.2 <- data.frame(rdiv_2.2[, c("rdiv", "sign")]) 
dd8.2$cor <- "no cor"
dd8.2$z1 <- "medium"
dd8.2$E1_mean <- "medium"

dd8.3 <- data.frame(rdiv_2.3[, c("rdiv", "sign")]) 
dd8.3$cor <- "no cor"
dd8.3$z1 <- "medium"
dd8.3$E1_mean <- "high"

dd9 <- data.frame(rdiv_3[, c("rdiv", "sign")]) 
dd9$cor <- "no cor"
dd9$z1 <- "high"
dd9$E1_mean <-"low"


dd9.2 <- data.frame(rdiv_3.2[, c("rdiv", "sign")]) 
dd9.2$cor <- "no cor"
dd9.2$z1 <- "high"
dd9.2$E1_mean <- "medium"

dd9.3 <- data.frame(rdiv_3.3[, c("rdiv", "sign")]) 
dd9.3$cor <- "no cor"
dd9.3$z1 <- "high"
dd9.3$E1_mean <- "high"
```

## Preparing data set

```{r}

dd_plot1 <- rbind(dd1[,c(1,3:5)], dd1.2[,c(1,3:5)],dd1.3[,c(1,3:5)],
                  dd2[,c(1,3:5)], dd2.2[,c(1,3:5)],dd2.3[,c(1,3:5)],
                  dd3[,c(1,3:5)], dd3.2[,c(1,3:5)],dd3.3[,c(1,3:5)],
                  dd4[,c(1,3:5)], dd4.2[,c(1,3:5)],dd4.3[,c(1,3:5)],
                  dd5[,c(1,3:5)], dd5.2[,c(1,3:5)],dd5.3[,c(1,3:5)], 
                  dd6[,c(1,3:5)], dd6.2[,c(1,3:5)],dd6.3[,c(1,3:5)],
                  dd7[,c(1,3:5)], dd7.2[,c(1,3:5)],dd7.3[,c(1,3:5)],
                  dd8[,c(1,3:5)], dd8.2[,c(1,3:5)],dd8.3[,c(1,3:5)],
                  dd9[,c(1,3:5)], dd9.2[,c(1,3:5)],dd9.3[,c(1,3:5)])
dd_plot1$E1_mean <- factor(dd_plot1$E1_mean, levels = c("low", "medium", "high"))
theme_set(theme_classic(base_size = 12))
level_order <- c("low", "medium", "high")
dd_dissimilarity_scenario1_SAME <- dd_plot1



dd_plot2 <- rbind(dd1[,c(2,3:5)], dd1.2[,c(2,3:5)],dd1.3[,c(2,3:5)],
                  dd2[,c(2,3:5)], dd2.2[,c(2,3:5)],dd2.3[,c(2,3:5)],
                  dd3[,c(2,3:5)], dd3.2[,c(2,3:5)],dd3.3[,c(2,3:5)],
                  dd4[,c(2,3:5)], dd4.2[,c(2,3:5)],dd4.3[,c(2,3:5)],
                  dd5[,c(2,3:5)], dd5.2[,c(2,3:5)],dd5.3[,c(2,3:5)], 
                  dd6[,c(2,3:5)], dd6.2[,c(2,3:5)],dd6.3[,c(2,3:5)],
                  dd7[,c(2,3:5)], dd7.2[,c(2,3:5)],dd7.3[,c(2,3:5)],
                  dd8[,c(2,3:5)], dd8.2[,c(2,3:5)],dd8.3[,c(2,3:5)],
                  dd9[,c(2,3:5)], dd9.2[,c(2,3:5)],dd9.3[,c(2,3:5)])
dd_plot2$E1_mean <- factor(dd_plot2$E1_mean, levels = c("low", "medium", "high"))

dd_divergence_scenario1_SAME <- dd_plot2

```


# Variation in diversity in z1 and z2

Now we do the same, but having also z2 changing together with z1 with positive correlation. So, diversity in z1 and z2 are increasing gradually from low to high in the 3 communities.

## Fluctuation in environmental change - negative correlation

Increasing variance in z1 and z2 - negative correlation between environmental variables (E1 and E2) 

We now create 3 communities. Community 1 is characterized by low diversity in z1 and z2, community 2 has medium diversity in z1 and z2, and community 3 has high diversity in z1 and z2.

E1 and E2 have high fluctuations and *negative* correlation.

```{r }
# Specify the correlation E1 and E2 
#negative in this example and high variation in E1 and E2 
E1max<- 70; E1min<- -25
E2max<- 70; E2min<- -25

# Scenario 1 - low mean vakues of E1 and E2
theme_set(theme_classic(base_size = 12))
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(  20                         , -  20                         ,
                                     -  20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))



### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(  20                         , -  20                         ,
                                     -  20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(  20                         , -  20                         ,
                                     -  20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))



detach("package:MASS", unload=TRUE)

```

### Community 1 - low diversity in z1.

```{r}
## Set species parameters
species_pars <- list(a1_mean = 1e-3,
  b1_mean = 0.02,
  z1_mean = 20,
  w1_mean = 10,
  a2_mean = 1e-3,
  b2_mean = 0.02,
  z2_mean = 20,
  w2_mean = 10,
  zint_mean = 0,
  sd_rate_mean = 0,
  z1_range = NA,
  z2_range = NA)

```

```{r plotcomm1_pos.1, fig.cap='Community 1, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=20, fig.width=12}
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(3541)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm1 <- multi_performance_plot(comm)
performance_comm1

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)
```

```{r}
# Find optimum for E1 and E1 for each sp 
optima_com1 <- get_optima(comm, new_data)
optima_com1$community <- 1
```

```{r}
# Calculate absolute response diversity for community 1 - scenario 2

# Unknown env conditions - get all surface
refs <- crossing(E1 = seq(0, 50, 10),
                     E2 = seq(0, 50, 10))

nested_gams <- comm %>% 
    nest(cols =-species) %>% 
    mutate(
      gams = map(cols, ~ gam(rate ~  te(E1, E2),
                             data = .x,
                             method = "REML")),
      predicted = map(gams, ~ predict(.x, newdata = new_data))
    )
  
  #list of gams
  m_list <- (nested_gams$gams)
  #list of spp names
  my_spp_names <- (nested_gams$species)
  # get partial derivatives
  pd_list <- modify_depth(m_list, 1, ~ get_partials(., refs))
  # from list to tibble
  pd_spp <- tibble(
    E1_ref = map(pd_list, "E1"),
    E2_ref = map(pd_list, "E2"),
    pd_E1 = map(pd_list, "pd_E1"),
    pd_E2 = map(pd_list, "pd_E2")) %>%
      dplyr::mutate(sp = my_spp_names) %>%
      relocate(sp, E1_ref, E2_ref, pd_E1, pd_E2) %>%
      unnest(E1_ref, E2_ref, pd_E1, pd_E2)
  
  radius <- 1
num_arrows <- 100
pd_spp <- crossing(angle = rep(seq(0, 2*pi, length = num_arrows)),
              E1_ref = pd_spp$E1_ref,
              E2_ref =pd_spp$E2_ref) %>%
  full_join(pd_spp) %>%
  mutate(E1 = cos(angle) * radius,
         E2 = sin(angle) * radius,
         dir_deriv = E1 * pd_E1 + E2 * pd_E2,
         unit_vec_mag = sqrt(E1^2 + E2^2))



# filter useless stuff
pd_spp <- pd_spp %>% 
  dplyr::select(angle, sp, E1_ref, E2_ref, dir_deriv)

#
# Calculating diversity for each direction and location this should be always the first step
# Dissimilarity
Div_loc_dir_comm1.2 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = F))



RDiv_comm1.2 <- tibble(Div_loc_dir_comm1.2 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
  summarise(mean = mean(div)) %>% 
  ungroup() %>% 
  summarise(dissimilarity = mean(mean)))

Div_loc_dir2_comm1.2 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = T))


RDiv1_comm1.2 <- tibble(Div_loc_dir2_comm1.2 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
                 summarise(mean = mean(div)) %>% 
                 ungroup() %>% 
                 summarise(divergence = mean(mean))) %>% 
  cbind(RDiv_comm1.2)

  
```

### Community 2 - medium diversity in z1.

```{r plotcomm2_pos.1, fig.cap='Community 2, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=20, fig.width=12}
species_pars$z1_range <- 25
species_pars$z2_range <- 25

# create reproducible community
set.seed(8645)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm2 <- multi_performance_plot(comm)
performance_comm2
# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)

```

```{r}
# Find optimum for E1 and E1 for each sp 
optima_com2 <- get_optima(comm, new_data)
optima_com2$community <- 2
```


```{r}
# Calculate absolute response diversity for community 2 - scenario 2 

# Unknown env conditions - get all surface
refs <- crossing(E1 = seq(0, 50, 10),
                     E2 = seq(0, 50, 10))

nested_gams <- comm %>% 
    nest(cols =-species) %>% 
    mutate(
      gams = map(cols, ~ gam(rate ~  te(E1, E2),
                             data = .x,
                             method = "REML")),
      predicted = map(gams, ~ predict(.x, newdata = new_data))
    )
  
  #list of gams
  m_list <- (nested_gams$gams)
  #list of spp names
  my_spp_names <- (nested_gams$species)
  # get partial derivatives
  pd_list <- modify_depth(m_list, 1, ~ get_partials(., refs))
  # from list to tibble
  pd_spp <- tibble(
    E1_ref = map(pd_list, "E1"),
    E2_ref = map(pd_list, "E2"),
    pd_E1 = map(pd_list, "pd_E1"),
    pd_E2 = map(pd_list, "pd_E2")) %>%
      dplyr::mutate(sp = my_spp_names) %>%
      relocate(sp, E1_ref, E2_ref, pd_E1, pd_E2) %>%
      unnest(E1_ref, E2_ref, pd_E1, pd_E2)
  
  radius <- 1
num_arrows <- 100
pd_spp <- crossing(angle = rep(seq(0, 2*pi, length = num_arrows)),
              E1_ref = pd_spp$E1_ref,
              E2_ref =pd_spp$E2_ref) %>%
  full_join(pd_spp) %>%
  mutate(E1 = cos(angle) * radius,
         E2 = sin(angle) * radius,
         dir_deriv = E1 * pd_E1 + E2 * pd_E2,
         unit_vec_mag = sqrt(E1^2 + E2^2))



# filter useless stuff
pd_spp <- pd_spp %>% 
  dplyr::select(angle, sp, E1_ref, E2_ref, dir_deriv)

#
# Calculating diversity for each direction and location this should be always the first step
# Dissimilarity
Div_loc_dir_comm2.2 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = F))



RDiv_comm2.2 <- tibble(Div_loc_dir_comm2.2 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
  summarise(mean = mean(div)) %>% 
  ungroup() %>% 
  summarise(dissimilarity = mean(mean)))

Div_loc_dir2_comm2.2 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = T))


RDiv1_comm2.2 <- tibble(Div_loc_dir2_comm2.2 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
                 summarise(mean = mean(div)) %>% 
                 ungroup() %>% 
                 summarise(divergence = mean(mean))) %>% 
  cbind(RDiv_comm2.2)

  
```
### Community 3 - high diversity in z1.

```{r plotcomm3_pos.1, fig.cap=' Community 3, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=20, fig.width=12}
species_pars$z1_range <- 50
species_pars$z2_range <- 50

# create reproducible community
set.seed(4853)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm3 <- multi_performance_plot(comm)
performance_comm3
# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)
```

```{r}
# Find optimum for E1 and E1 for each sp 
optima_com3 <- get_optima(comm, new_data)
optima_com3$community <- 3
```

```{r}
# Calculate absolute response diversity for community 3 - scenario 2 

# Unknown env conditions - get all surface
refs <- crossing(E1 = seq(0, 50, 10),
                     E2 = seq(0, 50, 10))

nested_gams <- comm %>% 
    nest(cols =-species) %>% 
    mutate(
      gams = map(cols, ~ gam(rate ~  te(E1, E2),
                             data = .x,
                             method = "REML")),
      predicted = map(gams, ~ predict(.x, newdata = new_data))
    )
  
  #list of gams
  m_list <- (nested_gams$gams)
  #list of spp names
  my_spp_names <- (nested_gams$species)
  # get partial derivatives
  pd_list <- modify_depth(m_list, 1, ~ get_partials(., refs))
  # from list to tibble
  pd_spp <- tibble(
    E1_ref = map(pd_list, "E1"),
    E2_ref = map(pd_list, "E2"),
    pd_E1 = map(pd_list, "pd_E1"),
    pd_E2 = map(pd_list, "pd_E2")) %>%
      dplyr::mutate(sp = my_spp_names) %>%
      relocate(sp, E1_ref, E2_ref, pd_E1, pd_E2) %>%
      unnest(E1_ref, E2_ref, pd_E1, pd_E2)
  
  radius <- 1
num_arrows <- 100
pd_spp <- crossing(angle = rep(seq(0, 2*pi, length = num_arrows)),
              E1_ref = pd_spp$E1_ref,
              E2_ref =pd_spp$E2_ref) %>%
  full_join(pd_spp) %>%
  mutate(E1 = cos(angle) * radius,
         E2 = sin(angle) * radius,
         dir_deriv = E1 * pd_E1 + E2 * pd_E2,
         unit_vec_mag = sqrt(E1^2 + E2^2))



# filter useless stuff
pd_spp <- pd_spp %>% 
  dplyr::select(angle, sp, E1_ref, E2_ref, dir_deriv)

#
# Calculating diversity for each direction and location this should be always the first step
# Dissimilarity
Div_loc_dir_comm3.2 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = F))



RDiv_comm3.2 <- tibble(Div_loc_dir_comm3.2 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
  summarise(mean = mean(div)) %>% 
  ungroup() %>% 
  summarise(dissimilarity = mean(mean)))

Div_loc_dir2_comm3.2 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = T))


RDiv1_comm3.2 <- tibble(Div_loc_dir2_comm3.2 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
                 summarise(mean = mean(div)) %>% 
                 ungroup() %>% 
                 summarise(divergence = mean(mean))) %>% 
  cbind(RDiv_comm3.2)

```

### Potential response diversity
```{r }
RDiv1_comm1.2$community <- 1
RDiv1_comm2.2$community <- 2
RDiv1_comm3.2$community <- 3
Absolute_RD_2 <- rbind(RDiv1_comm1.2, RDiv1_comm2.2, RDiv1_comm3.2)

# change to long format
Absolute_RD_2 <- pivot_longer(Absolute_RD_2, cols = "dissimilarity":"divergence", names_to = "RDiv",
                                values_to = "value", values_drop_na = TRUE)

Absolute_RD_2$community <- as.factor(Absolute_RD_2$community)

```
### Position of the optimum

Here and elsewhere in this document, the position of the optima has been estimated as the environmental location (E1 and E2 values) for which the rate is maximum.

```{r }
optima_scenatio2_same<- rbind(optima_com1, optima_com2, optima_com3)

```



### Response diversity calculation - first scenario (low mean values of E1 and E2)

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```



```{r}
# preparing data sets for overview plotting
dd1 <- data.frame(rdiv_1[, c("rdiv", "sign")]) 
dd1$cor <- "negative"
dd1$z1 <- "low"
dd1$E1_mean <- "low"

dd1.2 <- data.frame(rdiv_1.2[, c("rdiv", "sign")]) 
dd1.2$cor <- "negative"
dd1.2$z1 <- "low"
dd1.2$E1_mean <- "medium"

dd1.3 <- data.frame(rdiv_1.3[, c("rdiv", "sign")]) 
dd1.3$cor <- "negative"
dd1.3$z1 <- "low"
dd1.3$E1_mean <- "high"


dd2 <- data.frame(rdiv_2[, c("rdiv", "sign")]) 
dd2$cor <- "negative"
dd2$z1 <- "medium"
dd2$E1_mean <- "low"

dd2.2 <- data.frame(rdiv_2.2[, c("rdiv", "sign")]) 
dd2.2$cor <- "negative"
dd2.2$z1 <- "medium"
dd2.2$E1_mean <- "medium"

dd2.3 <- data.frame(rdiv_2.3[, c("rdiv", "sign")]) 
dd2.3$cor <- "negative"
dd2.3$z1 <- "medium"
dd2.3$E1_mean <- "high"

dd3 <- data.frame(rdiv_3[, c("rdiv", "sign")]) 
dd3$cor <- "negative"
dd3$z1 <- "high"
dd3$E1_mean <-"low"


dd3.2 <- data.frame(rdiv_3.2[, c("rdiv", "sign")]) 
dd3.2$cor <- "negative"
dd3.2$z1 <- "high"
dd3.2$E1_mean <- "medium"

dd3.3 <- data.frame(rdiv_3.3[, c("rdiv", "sign")]) 
dd3.3$cor <- "negative"
dd3.3$z1 <- "high"
dd3.3$E1_mean <- "high"
```



## Fluctuation in environmental change - positive correlation

Increasing variance in z1 and z2 - positive correlation between env variables (E1 and E2) 

Same steps as before (3 communities with increasing diversity in z1 while z2 is fixed), but the correlation between E1 and E1 is positive

```{r}
E1max<- 70; E1min<- -25
E2max<- 70; E2min<- -25
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(  20                         ,   20                         ,
                                       20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(  20                         ,   20                         ,
                                       20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(  20                         ,   20                         ,
                                       20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


detach("package:MASS", unload=TRUE)

```

```{r}
# create reproducible community
set.seed(2456)
### Community 1 - low diversity in z1.
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)


species_pars$z1_range <- 25
species_pars$z2_range <- 25

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)

### Community 3 - high diversity in z1. 

species_pars$z1_range <- 50
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)

```

### Response diversity calculation

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```


```{r}
# preparing data sets for overview plotting
dd4 <- data.frame(rdiv_1[, c("rdiv", "sign")]) 
dd4$cor <- "positive"
dd4$z1 <- "low"
dd4$E1_mean <- "low"

dd4.2 <- data.frame(rdiv_1.2[, c("rdiv", "sign")]) 
dd4.2$cor <- "positive"
dd4.2$z1 <- "low"
dd4.2$E1_mean <- "medium"

dd4.3 <- data.frame(rdiv_1.3[, c("rdiv", "sign")]) 
dd4.3$cor <- "positive"
dd4.3$z1 <- "low"
dd4.3$E1_mean <- "high"


dd5 <- data.frame(rdiv_2[, c("rdiv", "sign")]) 
dd5$cor <- "positive"
dd5$z1 <- "medium"
dd5$E1_mean <- "low"

dd5.2 <- data.frame(rdiv_2.2[, c("rdiv", "sign")]) 
dd5.2$cor <- "positive"
dd5.2$z1 <- "medium"
dd5.2$E1_mean <- "medium"

dd5.3 <- data.frame(rdiv_2.3[, c("rdiv", "sign")]) 
dd5.3$cor <- "positive"
dd5.3$z1 <- "medium"
dd5.3$E1_mean <- "high"

dd6 <- data.frame(rdiv_3[, c("rdiv", "sign")]) 
dd6$cor <- "positive"
dd6$z1 <- "high"
dd6$E1_mean <-"low"


dd6.2 <- data.frame(rdiv_3.2[, c("rdiv", "sign")]) 
dd6.2$cor <- "positive"
dd6.2$z1 <- "high"
dd6.2$E1_mean <- "medium"

dd6.3 <- data.frame(rdiv_3.3[, c("rdiv", "sign")]) 
dd6.3$cor <- "positive"
dd6.3$z1 <- "high"
dd6.3$E1_mean <- "high"
```


## Fluctuation in environmental change - no correlation

Increasing variance in z1 - no correlation between env variables (E1 and E2) 

Same steps as before (3 communities with increasing diversity in z1 while z2 is fixed), but there is no correlation between E1 and E1

```{r}
E1max<- 70; E1min<- -25
E2max<- 70; E2min<- -25
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(  20                         , 0.0,
                                     0.0,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(  20                         , 0.0,
                                     0.0,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(  20                         , 0.0,
                                     0.0,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


detach("package:MASS", unload=TRUE)

```

```{r}
# create reproducible community
set.seed(2456)
### Community 1 - low diversity in z1.
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)


species_pars$z1_range <- 25
species_pars$z2_range <- 25

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)

### Community 3 - high diversity in z1. 

species_pars$z1_range <- 50
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)

```

### Response diversity calculation

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```


```{r}
# preparing data sets for overview plotting
dd7 <- data.frame(rdiv_1[, c("rdiv", "sign")]) 
dd7$cor <- "no cor"
dd7$z1 <- "low"
dd7$E1_mean <- "low"

dd7.2 <- data.frame(rdiv_1.2[, c("rdiv", "sign")]) 
dd7.2$cor <- "no cor"
dd7.2$z1 <- "low"
dd7.2$E1_mean <- "medium"

dd7.3 <- data.frame(rdiv_1.3[, c("rdiv", "sign")]) 
dd7.3$cor <- "no cor"
dd7.3$z1 <- "low"
dd7.3$E1_mean <- "high"


dd8 <- data.frame(rdiv_2[, c("rdiv", "sign")]) 
dd8$cor <- "no cor"
dd8$z1 <- "medium"
dd8$E1_mean <- "low"

dd8.2 <- data.frame(rdiv_2.2[, c("rdiv", "sign")]) 
dd8.2$cor <- "no cor"
dd8.2$z1 <- "medium"
dd8.2$E1_mean <- "medium"

dd8.3 <- data.frame(rdiv_2.3[, c("rdiv", "sign")]) 
dd8.3$cor <- "no cor"
dd8.3$z1 <- "medium"
dd8.3$E1_mean <- "high"

dd9 <- data.frame(rdiv_3[, c("rdiv", "sign")]) 
dd9$cor <- "no cor"
dd9$z1 <- "high"
dd9$E1_mean <-"low"


dd9.2 <- data.frame(rdiv_3.2[, c("rdiv", "sign")]) 
dd9.2$cor <- "no cor"
dd9.2$z1 <- "high"
dd9.2$E1_mean <- "medium"

dd9.3 <- data.frame(rdiv_3.3[, c("rdiv", "sign")]) 
dd9.3$cor <- "no cor"
dd9.3$z1 <- "high"
dd9.3$E1_mean <- "high"
```

## Preparing data set

```{r }

dd_plot1 <- rbind(dd1[,c(1,3:5)], dd1.2[,c(1,3:5)],dd1.3[,c(1,3:5)],
                  dd2[,c(1,3:5)], dd2.2[,c(1,3:5)],dd2.3[,c(1,3:5)],
                  dd3[,c(1,3:5)], dd3.2[,c(1,3:5)],dd3.3[,c(1,3:5)],
                  dd4[,c(1,3:5)], dd4.2[,c(1,3:5)],dd4.3[,c(1,3:5)],
                  dd5[,c(1,3:5)], dd5.2[,c(1,3:5)],dd5.3[,c(1,3:5)], 
                  dd6[,c(1,3:5)], dd6.2[,c(1,3:5)],dd6.3[,c(1,3:5)],
                  dd7[,c(1,3:5)], dd7.2[,c(1,3:5)],dd7.3[,c(1,3:5)],
                  dd8[,c(1,3:5)], dd8.2[,c(1,3:5)],dd8.3[,c(1,3:5)],
                  dd9[,c(1,3:5)], dd9.2[,c(1,3:5)],dd9.3[,c(1,3:5)])
dd_plot1$E1_mean <- factor(dd_plot1$E1_mean, levels = c("low", "medium", "high"))
dd_dissimilarity_scenario2_SAME <- dd_plot1


dd_plot2 <- rbind(dd1[,c(2,3:5)], dd1.2[,c(2,3:5)],dd1.3[,c(2,3:5)],
                  dd2[,c(2,3:5)], dd2.2[,c(2,3:5)],dd2.3[,c(2,3:5)],
                  dd3[,c(2,3:5)], dd3.2[,c(2,3:5)],dd3.3[,c(2,3:5)],
                  dd4[,c(2,3:5)], dd4.2[,c(2,3:5)],dd4.3[,c(2,3:5)],
                  dd5[,c(2,3:5)], dd5.2[,c(2,3:5)],dd5.3[,c(2,3:5)], 
                  dd6[,c(2,3:5)], dd6.2[,c(2,3:5)],dd6.3[,c(2,3:5)],
                  dd7[,c(2,3:5)], dd7.2[,c(2,3:5)],dd7.3[,c(2,3:5)],
                  dd8[,c(2,3:5)], dd8.2[,c(2,3:5)],dd8.3[,c(2,3:5)],
                  dd9[,c(2,3:5)], dd9.2[,c(2,3:5)],dd9.3[,c(2,3:5)])
dd_plot2$E1_mean <- factor(dd_plot2$E1_mean, levels = c("low", "medium", "high"))
dd_divergence_scenario2_SAME <- dd_plot2

```


# Variation in diversity in z1 and z2

Now we do the same, but having also z2 changing together with z1 with negative correlation. So, diversity in z1 is increasing gradually from low to high in the 3 communities, while z2 decreases gradually in the 3 communities.

## Fluctuation in environmental change - negative correlation

Increasing variance in z1 and z2 - negative correlation between env variables (E1 and E2) 

We now create 3 communities. Community 1 is characterized by low diversity in z1 and high diversity in z2, community 2 has medium diversity in z1 and z2, and community 3 has high diversity in z1 and low in z2.

E1 and E2 have high fluctuations and *negative* correlation.

```{r }
# Specify the correlation E1 and E2 
#negative in this example and high variation in E1 and E2 
E1max<- 70; E1min<- -25
E2max<- 70; E2min<- -25

# Scenario 1 - low mean vakues of E1 and E2
theme_set(theme_classic(base_size = 12))
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(  20                         , -  20                         ,
                                     -  20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(  20                         , -  20                         ,
                                     -  20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(  20                         , -  20                         ,
                                     -  20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


detach("package:MASS", unload=TRUE)

```

### Community 1 - low diversity in z1.

```{r}
## Set species parameters
species_pars <- list(a1_mean = 1e-3,
  b1_mean = 0.02,
  z1_mean = 20,
  w1_mean = 10,
  a2_mean = 1e-3,
  b2_mean = 0.02,
  z2_mean = 20,
  w2_mean = 10,
  zint_mean = 0,
  sd_rate_mean = 0,
  z1_range = NA,
  z2_range = NA)

```

```{r plotcomm1_mix.1.2, fig.cap='Community 1, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=20, fig.width=12}
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 50

# create reproducible community
set.seed(3455)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm1 <- multi_performance_plot(comm)
performance_comm1

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)
```

```{r}
# Find optimum for E1 and E1 for each sp 
optima_com1 <- get_optima(comm, new_data)
optima_com1$community <- 1
```

```{r}
# Calculate absolute response diversity for community 1 - scenario 3

# Unknown env conditions - get all surface
refs <- crossing(E1 = seq(0, 50, 10),
                     E2 = seq(0, 50, 10))

nested_gams <- comm %>% 
    nest(cols =-species) %>% 
    mutate(
      gams = map(cols, ~ gam(rate ~  te(E1, E2),
                             data = .x,
                             method = "REML")),
      predicted = map(gams, ~ predict(.x, newdata = new_data))
    )
  
  #list of gams
  m_list <- (nested_gams$gams)
  #list of spp names
  my_spp_names <- (nested_gams$species)
  # get partial derivatives
  pd_list <- modify_depth(m_list, 1, ~ get_partials(., refs))
  # from list to tibble
  pd_spp <- tibble(
    E1_ref = map(pd_list, "E1"),
    E2_ref = map(pd_list, "E2"),
    pd_E1 = map(pd_list, "pd_E1"),
    pd_E2 = map(pd_list, "pd_E2")) %>%
      dplyr::mutate(sp = my_spp_names) %>%
      relocate(sp, E1_ref, E2_ref, pd_E1, pd_E2) %>%
      unnest(E1_ref, E2_ref, pd_E1, pd_E2)
  
  radius <- 1
num_arrows <- 100
pd_spp <- crossing(angle = rep(seq(0, 2*pi, length = num_arrows)),
              E1_ref = pd_spp$E1_ref,
              E2_ref =pd_spp$E2_ref) %>%
  full_join(pd_spp) %>%
  mutate(E1 = cos(angle) * radius,
         E2 = sin(angle) * radius,
         dir_deriv = E1 * pd_E1 + E2 * pd_E2,
         unit_vec_mag = sqrt(E1^2 + E2^2))



# filter useless stuff
pd_spp <- pd_spp %>% 
  dplyr::select(angle, sp, E1_ref, E2_ref, dir_deriv)

#
# Calculating diversity for each direction and location this should be always the first step
# Dissimilarity
Div_loc_dir_comm1.3 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = F))



RDiv_comm1.3 <- tibble(Div_loc_dir_comm1.3 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
  summarise(mean = mean(div)) %>% 
  ungroup() %>% 
  summarise(dissimilarity = mean(mean)))

Div_loc_dir2_comm1.3 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = T))


RDiv1_comm1.3 <- tibble(Div_loc_dir2_comm1.3 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
                 summarise(mean = mean(div)) %>% 
                 ungroup() %>% 
                 summarise(divergence = mean(mean))) %>% 
  cbind(RDiv_comm1.3)

  
```
### Community 2 - medium diversity in z1.

```{r plotcomm2_mix.1.2, fig.cap='Community 2, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=20, fig.width=12}
species_pars$z1_range <- 25
species_pars$z2_range <- 25

# create reproducible community
set.seed(43521)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm2 <- multi_performance_plot(comm)
performance_comm2
# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)

```

```{r}
# Find optimum for E1 and E1 for each sp 
optima_com2 <- get_optima(comm, new_data)
optima_com2$community <- 2
```


```{r}
# Calculate absolute response diversity for community 2 - scenario 3 

# Unknown env conditions - get all surface
refs <- crossing(E1 = seq(0, 50, 10),
                     E2 = seq(0, 50, 10))

nested_gams <- comm %>% 
    nest(cols =-species) %>% 
    mutate(
      gams = map(cols, ~ gam(rate ~  te(E1, E2),
                             data = .x,
                             method = "REML")),
      predicted = map(gams, ~ predict(.x, newdata = new_data))
    )
  
  #list of gams
  m_list <- (nested_gams$gams)
  #list of spp names
  my_spp_names <- (nested_gams$species)
  # get partial derivatives
  pd_list <- modify_depth(m_list, 1, ~ get_partials(., refs))
  # from list to tibble
  pd_spp <- tibble(
    E1_ref = map(pd_list, "E1"),
    E2_ref = map(pd_list, "E2"),
    pd_E1 = map(pd_list, "pd_E1"),
    pd_E2 = map(pd_list, "pd_E2")) %>%
      dplyr::mutate(sp = my_spp_names) %>%
      relocate(sp, E1_ref, E2_ref, pd_E1, pd_E2) %>%
      unnest(E1_ref, E2_ref, pd_E1, pd_E2)
  
  radius <- 1
num_arrows <- 100
pd_spp <- crossing(angle = rep(seq(0, 2*pi, length = num_arrows)),
              E1_ref = pd_spp$E1_ref,
              E2_ref =pd_spp$E2_ref) %>%
  full_join(pd_spp) %>%
  mutate(E1 = cos(angle) * radius,
         E2 = sin(angle) * radius,
         dir_deriv = E1 * pd_E1 + E2 * pd_E2,
         unit_vec_mag = sqrt(E1^2 + E2^2))



# filter useless stuff
pd_spp <- pd_spp %>% 
  dplyr::select(angle, sp, E1_ref, E2_ref, dir_deriv)

#
# Calculating diversity for each direction and location this should be always the first step
# Dissimilarity
Div_loc_dir_comm2.3 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = F))



RDiv_comm2.3 <- tibble(Div_loc_dir_comm2.3 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
  summarise(mean = mean(div)) %>% 
  ungroup() %>% 
  summarise(dissimilarity = mean(mean)))

Div_loc_dir2_comm2.3 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = T))


RDiv1_comm2.3 <- tibble(Div_loc_dir2_comm2.3 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
                 summarise(mean = mean(div)) %>% 
                 ungroup() %>% 
                 summarise(divergence = mean(mean))) %>% 
  cbind(RDiv_comm2.3)

  
```


### Community 3 - high diversity in z1.

```{r plotcomm3_mix.1.2, fig.cap=' Community 3, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=20, fig.width=12}
species_pars$z1_range <- 50
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(3442)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm3 <- multi_performance_plot(comm)
performance_comm3
# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)
```

```{r}
# Find optimum for E1 and E1 for each sp 
optima_com3 <- get_optima(comm, new_data)
optima_com3$community <- 3
```

```{r}
# Calculate absolute response diversity for community 3 - scenario 2 

# Unknown env conditions - get all surface
refs <- crossing(E1 =  seq(0, 50, 10),
                     E2 = seq(0, 50, 10))

nested_gams <- comm %>% 
    nest(cols =-species) %>% 
    mutate(
      gams = map(cols, ~ gam(rate ~  te(E1, E2),
                             data = .x,
                             method = "REML")),
      predicted = map(gams, ~ predict(.x, newdata = new_data))
    )
  
  #list of gams
  m_list <- (nested_gams$gams)
  #list of spp names
  my_spp_names <- (nested_gams$species)
  # get partial derivatives
  pd_list <- modify_depth(m_list, 1, ~ get_partials(., refs))
  # from list to tibble
  pd_spp <- tibble(
    E1_ref = map(pd_list, "E1"),
    E2_ref = map(pd_list, "E2"),
    pd_E1 = map(pd_list, "pd_E1"),
    pd_E2 = map(pd_list, "pd_E2")) %>%
      dplyr::mutate(sp = my_spp_names) %>%
      relocate(sp, E1_ref, E2_ref, pd_E1, pd_E2) %>%
      unnest(E1_ref, E2_ref, pd_E1, pd_E2)
  
  radius <- 1
num_arrows <- 100
pd_spp <- crossing(angle = rep(seq(0, 2*pi, length = num_arrows)),
              E1_ref = pd_spp$E1_ref,
              E2_ref =pd_spp$E2_ref) %>%
  full_join(pd_spp) %>%
  mutate(E1 = cos(angle) * radius,
         E2 = sin(angle) * radius,
         dir_deriv = E1 * pd_E1 + E2 * pd_E2,
         unit_vec_mag = sqrt(E1^2 + E2^2))



# filter useless stuff
pd_spp <- pd_spp %>% 
  dplyr::select(angle, sp, E1_ref, E2_ref, dir_deriv)

#
# Calculating diversity for each direction and location this should be always the first step
# Dissimilarity
Div_loc_dir_comm3.3 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = F))



RDiv_comm3.3 <- tibble(Div_loc_dir_comm3.3 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
  summarise(mean = mean(div)) %>% 
  ungroup() %>% 
  summarise(dissimilarity = mean(mean)))

Div_loc_dir2_comm3.3 <- pd_spp %>% 
  dplyr::group_by(E1_ref, E2_ref, angle) %>% 
  summarise(div = resp_div(dir_deriv, sign = T))


RDiv1_comm3.3 <- tibble(Div_loc_dir2_comm3.3 %>% dplyr::group_by(E1_ref, E2_ref) %>% 
                 summarise(mean = mean(div)) %>% 
                 ungroup() %>% 
                 summarise(divergence = mean(mean))) %>% 
  cbind(RDiv_comm3.3)

```

## Potential response diversity
```{r }
RDiv1_comm1.3$community <- 1
RDiv1_comm2.3$community <- 2
RDiv1_comm3.3$community <- 3
Absolute_RD_3 <- rbind(RDiv1_comm1.3, RDiv1_comm2.3, RDiv1_comm3.3)

# change to long format
Absolute_RD_3 <- pivot_longer(Absolute_RD_3, cols = "dissimilarity":"divergence", names_to = "RDiv",
                                values_to = "value", values_drop_na = TRUE)

Absolute_RD_3$community <- as.factor(Absolute_RD_3$community)


```

### Potential response diveristy across scenarios - here we prapre the data set used to campare the potential response diversity in the three different scenarios we created above. That is, we compare potential dissimilarity and divergence in communities changing only in z1, in communities changing in z1 and z2 with positive correlation, and communities changing in z1 and z2 with negative correlation. 
```{r }
Absolute_RD_1$scenario <- 1
Absolute_RD_2$scenario <- 2
Absolute_RD_3$scenario <- 3
Absolute_RD_same <- rbind(Absolute_RD_1, Absolute_RD_2, Absolute_RD_3)

Absolute_RD_same$scenario <- as.factor(Absolute_RD_same$scenario)
Absolute_RD_same$community <- factor(Absolute_RD_same$community, levels = c(3,2,1))


```


### Position of the optimum

Here and elsewhere in this document, the position of the optima has been estimated as the environmental location (E1 and E2 values) for which the rate is maximum.

```{r }
optima_scenario3_same <- rbind(optima_com1, optima_com2, optima_com3)

```




### Response diversity calculation - first scenario (low mean values of E1 and E2)

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```



```{r}
# Preparing data set for overview plots
dd1 <- data.frame(rdiv_1[, c("rdiv", "sign")]) 
dd1$cor <- "negative"
dd1$z1 <- "low"
dd1$E1_mean <- "low"

dd1.2 <- data.frame(rdiv_1.2[, c("rdiv", "sign")]) 
dd1.2$cor <- "negative"
dd1.2$z1 <- "low"
dd1.2$E1_mean <- "medium"

dd1.3 <- data.frame(rdiv_1.3[, c("rdiv", "sign")]) 
dd1.3$cor <- "negative"
dd1.3$z1 <- "low"
dd1.3$E1_mean <- "high"


dd2 <- data.frame(rdiv_2[, c("rdiv", "sign")]) 
dd2$cor <- "negative"
dd2$z1 <- "medium"
dd2$E1_mean <- "low"

dd2.2 <- data.frame(rdiv_2.2[, c("rdiv", "sign")]) 
dd2.2$cor <- "negative"
dd2.2$z1 <- "medium"
dd2.2$E1_mean <- "medium"

dd2.3 <- data.frame(rdiv_2.3[, c("rdiv", "sign")]) 
dd2.3$cor <- "negative"
dd2.3$z1 <- "medium"
dd2.3$E1_mean <- "high"

dd3 <- data.frame(rdiv_3[, c("rdiv", "sign")]) 
dd3$cor <- "negative"
dd3$z1 <- "high"
dd3$E1_mean <-"low"


dd3.2 <- data.frame(rdiv_3.2[, c("rdiv", "sign")]) 
dd3.2$cor <- "negative"
dd3.2$z1 <- "high"
dd3.2$E1_mean <- "medium"

dd3.3 <- data.frame(rdiv_3.3[, c("rdiv", "sign")]) 
dd3.3$cor <- "negative"
dd3.3$z1 <- "high"
dd3.3$E1_mean <- "high"
```


## Fluctuation in environmental change - positive correlation

Increasing variance in z1 and z2 - positive correlation between env variables (E1 and E2) 

Same steps as before (3 communities with increasing diversity ib z1 while z2 is fixed), but the correlation between E1 and E1 is positive

```{r }
E1max<- 70; E1min<- -25
E2max<- 70; E2min<- -25
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(  20                         ,   20                         ,
                                       20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(  20                         ,   20                         ,
                                       20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(  20                         ,   20                         ,
                                       20                         ,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))



detach("package:MASS", unload=TRUE)

```

```{r}
# create reproducible community
set.seed(2456)
### Community 1 - low diversity in z1.
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)


species_pars$z1_range <- 25
species_pars$z2_range <- 25

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)

### Community 3 - high diversity in z1. 

species_pars$z1_range <- 50
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)

```

### Response diversity calculation

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```



```{r}
# Preparing data set for overview plots
dd4 <- data.frame(rdiv_1[, c("rdiv", "sign")]) 
dd4$cor <- "positive"
dd4$z1 <- "low"
dd4$E1_mean <- "low"

dd4.2 <- data.frame(rdiv_1.2[, c("rdiv", "sign")]) 
dd4.2$cor <- "positive"
dd4.2$z1 <- "low"
dd4.2$E1_mean <- "medium"

dd4.3 <- data.frame(rdiv_1.3[, c("rdiv", "sign")]) 
dd4.3$cor <- "positive"
dd4.3$z1 <- "low"
dd4.3$E1_mean <- "high"


dd5 <- data.frame(rdiv_2[, c("rdiv", "sign")]) 
dd5$cor <- "positive"
dd5$z1 <- "medium"
dd5$E1_mean <- "low"

dd5.2 <- data.frame(rdiv_2.2[, c("rdiv", "sign")]) 
dd5.2$cor <- "positive"
dd5.2$z1 <- "medium"
dd5.2$E1_mean <- "medium"

dd5.3 <- data.frame(rdiv_2.3[, c("rdiv", "sign")]) 
dd5.3$cor <- "positive"
dd5.3$z1 <- "medium"
dd5.3$E1_mean <- "high"

dd6 <- data.frame(rdiv_3[, c("rdiv", "sign")]) 
dd6$cor <- "positive"
dd6$z1 <- "high"
dd6$E1_mean <-"low"


dd6.2 <- data.frame(rdiv_3.2[, c("rdiv", "sign")]) 
dd6.2$cor <- "positive"
dd6.2$z1 <- "high"
dd6.2$E1_mean <- "medium"

dd6.3 <- data.frame(rdiv_3.3[, c("rdiv", "sign")]) 
dd6.3$cor <- "positive"
dd6.3$z1 <- "high"
dd6.3$E1_mean <- "high"
```



## Fluctuation in environmental change - no correlation

Increasing variance in z1 - no correlation between env variables (E1 and E2) 

Same steps as before (3 communities with increasing diversity in z1 while z2 is fixed), but there is no correlation between E1 and E1

```{r }
E1max<- 70; E1min<- -25
E2max<- 70; E2min<- -25
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(  20                         , 0.0,
                                     0.0,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))



### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(  20                         , 0.0,
                                     0.0,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(  20                         , 0.0,
                                     0.0,   20                         ),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


detach("package:MASS", unload=TRUE)

```

```{r}
# create reproducible community
set.seed(2456)
### Community 1 - low diversity in z1.
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)


species_pars$z1_range <- 25
species_pars$z2_range <- 25

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)

### Community 3 - high diversity in z1. 

species_pars$z1_range <- 50
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)

```

### Response diversity calculation

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```



```{r}
# Preparing data set for overview plots
dd7 <- data.frame(rdiv_1[, c("rdiv", "sign")]) 
dd7$cor <- "no cor"
dd7$z1 <- "low"
dd7$E1_mean <- "low"

dd7.2 <- data.frame(rdiv_1.2[, c("rdiv", "sign")]) 
dd7.2$cor <- "no cor"
dd7.2$z1 <- "low"
dd7.2$E1_mean <- "medium"

dd7.3 <- data.frame(rdiv_1.3[, c("rdiv", "sign")]) 
dd7.3$cor <- "no cor"
dd7.3$z1 <- "low"
dd7.3$E1_mean <- "high"


dd8 <- data.frame(rdiv_2[, c("rdiv", "sign")]) 
dd8$cor <- "no cor"
dd8$z1 <- "medium"
dd8$E1_mean <- "low"

dd8.2 <- data.frame(rdiv_2.2[, c("rdiv", "sign")]) 
dd8.2$cor <- "no cor"
dd8.2$z1 <- "medium"
dd8.2$E1_mean <- "medium"

dd8.3 <- data.frame(rdiv_2.3[, c("rdiv", "sign")]) 
dd8.3$cor <- "no cor"
dd8.3$z1 <- "medium"
dd8.3$E1_mean <- "high"

dd9 <- data.frame(rdiv_3[, c("rdiv", "sign")]) 
dd9$cor <- "no cor"
dd9$z1 <- "high"
dd9$E1_mean <-"low"


dd9.2 <- data.frame(rdiv_3.2[, c("rdiv", "sign")]) 
dd9.2$cor <- "no cor"
dd9.2$z1 <- "high"
dd9.2$E1_mean <- "medium"

dd9.3 <- data.frame(rdiv_3.3[, c("rdiv", "sign")]) 
dd9.3$cor <- "no cor"
dd9.3$z1 <- "high"
dd9.3$E1_mean <- "high"
```

## Preparing data set
```{r SummaryPlot3.2, fig.align="center", fig.height=8, fig.width=10, fig.cap="Influence of the correlation between environmental variables and z1 diversity on response diversity. (a) Effects of the correlation between environmental variables and z1 diversity on response diversity measured as dissimilarity (sign insensitive measure). (b) Effects of the correlation between environmental variables and z1 diversity on response diversity measured as divergence (sign sensitive measure)."}

dd_plot1 <- rbind(dd1[,c(1,3:5)], dd1.2[,c(1,3:5)],dd1.3[,c(1,3:5)],
                  dd2[,c(1,3:5)], dd2.2[,c(1,3:5)],dd2.3[,c(1,3:5)],
                  dd3[,c(1,3:5)], dd3.2[,c(1,3:5)],dd3.3[,c(1,3:5)],
                  dd4[,c(1,3:5)], dd4.2[,c(1,3:5)],dd4.3[,c(1,3:5)],
                  dd5[,c(1,3:5)], dd5.2[,c(1,3:5)],dd5.3[,c(1,3:5)], 
                  dd6[,c(1,3:5)], dd6.2[,c(1,3:5)],dd6.3[,c(1,3:5)],
                  dd7[,c(1,3:5)], dd7.2[,c(1,3:5)],dd7.3[,c(1,3:5)],
                  dd8[,c(1,3:5)], dd8.2[,c(1,3:5)],dd8.3[,c(1,3:5)],
                  dd9[,c(1,3:5)], dd9.2[,c(1,3:5)],dd9.3[,c(1,3:5)])
dd_plot1$z1 <- factor(dd_plot1$z1, levels = c("low", "medium", "high"))
dd_plot1$E1_mean <- factor(dd_plot1$E1_mean, levels = c("low", "medium", "high"))

dd_dissimilarity_scenario3_SAME <- dd_plot1



dd_plot2 <- rbind(dd1[,c(2,3:5)], dd1.2[,c(2,3:5)],dd1.3[,c(2,3:5)],
                  dd2[,c(2,3:5)], dd2.2[,c(2,3:5)],dd2.3[,c(2,3:5)],
                  dd3[,c(2,3:5)], dd3.2[,c(2,3:5)],dd3.3[,c(2,3:5)],
                  dd4[,c(2,3:5)], dd4.2[,c(2,3:5)],dd4.3[,c(2,3:5)],
                  dd5[,c(2,3:5)], dd5.2[,c(2,3:5)],dd5.3[,c(2,3:5)], 
                  dd6[,c(2,3:5)], dd6.2[,c(2,3:5)],dd6.3[,c(2,3:5)],
                  dd7[,c(2,3:5)], dd7.2[,c(2,3:5)],dd7.3[,c(2,3:5)],
                  dd8[,c(2,3:5)], dd8.2[,c(2,3:5)],dd8.3[,c(2,3:5)],
                  dd9[,c(2,3:5)], dd9.2[,c(2,3:5)],dd9.3[,c(2,3:5)])
dd_plot2$z1 <- factor(dd_plot2$z1, levels = c("low", "medium", "high"))
dd_plot2$E1_mean <- factor(dd_plot2$E1_mean, levels = c("low", "medium", "high"))

dd_divergence_scenario3_SAME <- dd_plot2

```

```{r}
# setwd("/Users/francesco/Documents/GitHub/multifarious_response_diversity/Data/")
save.image(file = here("Data/my_work_space.RData"))
```

