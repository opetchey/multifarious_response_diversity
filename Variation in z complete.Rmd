---
title: "Variation in z"
author: "Francesco Polazzo"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    fig_caption: yes
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    code_folding: hide
---


```{r include = FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      include = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE)
```



```{r results='hide'}
rm(list = ls())
library(plotly)
library(tidyverse)
library(here)
library(patchwork)
library(DT)
library(mgcv)
library(gratia)
library(rlang)
library(vctrs)
library(scales)
library(broom)
library(reshape2)
library(ggtext)
library(ggsci)
source.files <- list.files(here("r"), full.names = TRUE)
sapply(source.files, source, .GlobalEnv)
```

# Intention
In this document, we are going to explore how diversity in species responses to one or both environmental variables, and different scenarios of correlation between them, may influence multifarious response diversity.
Additionally, we are going to look at how different correlation between the environmental variables influence the calculated response diversity.



Within the project "response diversity in the context of multifarious environmental change", we have been simulating species response curves using the Eppley performance curve.

With one environmental variable, the performance (i.e., rate) is given by:

* $rate(E) = ae^{bE}(1 - (\frac{E - z}{w/2})^2)$
* $E$ is the values of the environmental factor.
* $z$ controls location of maximum.
* $w$ controls range of $E$ over which the rate is positive.
* $a$ scaling constant.
* $b$ controls rate of increase towards the maximum rate, as $E$ increases.

Adding a second environmental variable gives:

$rate(E_1, E_2) = a_1e^{b_1E_1}(1 - (\frac{E_1 - z_1}{w_1/2})^2) + a_2e^{b_2E_2}(1 - (\frac{E_2 - z_2}{w_2/2})^2)$

We now want to assess the role of diversity in response to one (or both) environmental variable(s), and investigate how different covariances in diversity of responses to E1 and E2 influence response diversity. 

To do that, we are going to manipulate amount of diversity in responses to one or both env variables among the species, and also the correlation in the tolerances (position of optima, determine by the terms z1 and z2 in the above formula). We will make scenarios of communities with diversity in response to only E1, or both E1 and E2, with diversity in both that is positively correlated (co-tolerance) or negatively (anti-tolerance).

# Variation in diversity in z1

## High fluctuation in environmental change - negative correlation
Increasing variance in z1 - negative correlation between env variables (E1 and E2) with *high* fluctuations.

We now create 3 communities. Community 1 is characterized by low diversity in z1, community 2 has medium diversity in z1, and community 3 has high diversity in z1. z2 is constant in the 3 communities and fixed to a medium level of diversity. 

E1 and E2 have *high* fluctuations and *negative* correlation. 

```{r}
## define the series of values of the environmental variables
E1_series <- 273.15 + seq(0, 50, 1)
E2_series <- seq(0, 50, 1)

## define new_data for following GAM fitting

new_data <- tibble(E1 = 273.15 + seq(0, 50, 0.2),
                   E2 = seq(0, 50, 0.2))
```




```{r plot1env, fig.cap='Environmental variables with high variation and negative correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
# Specify the correlation E1 and E2 
#negative in this example and high variation in E1 and E2 
theme_set(theme_classic(base_size = 12))
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(mean(E1_series),  mean(E2_series))                                   
sample_covariance_matrix <- matrix(c(150, -150,
                                     -150, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "V1", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p_E1 <- refs %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  labs(tag = "(a)")

p_E2 <- refs %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
  labs(tag = "(b)")

# Plot environmental change over time
p_E1 + p_E2
detach("package:MASS", unload=TRUE)

```

### Community 1 - low diversity in z1. 


```{r}
## Set species parameters
species_pars <- list(a1_mean = 1e-9,
  b1_mean = 0.063,
  z1_mean = 285,
  w1_mean = 60,
  a2_mean = 1e-3,
  b2_mean = 0.02,
  z2_mean = 20,
  w2_mean = 10,
  zint_mean = 0,
  sd_rate_mean = 0,
  z1_range = NA,
  z2_range = NA)

```



```{r plotcomm1_neg, fig.cap='Community 1, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=12, fig.width=12}
s <- 4
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm1 <- multi_performance_plot(comm)
performance_comm1

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs)

```



### Community 2 - medium diversity in z1. 

```{r plotcomm2_neg, fig.cap='Community 2, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=12, fig.width=12}
species_pars$z1_range <- 25
species_pars$z2_range <- 15
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm2 <- multi_performance_plot(comm)
performance_comm2
# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs)

```


### Community 3 - high diversity in z1. 

```{r plotcomm3_neg, fig.cap=' Community 3, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=12, fig.width=12}
species_pars$z1_range <- 50
species_pars$z2_range <- 15
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm3 <- multi_performance_plot(comm)
performance_comm3
# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs)
```


### Response diversity calculation 

```{r RDplot1, fig.cap='Directional derivatives and response diversity for the three different communities. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# community 1  - calculation RD

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sing<-median(rdiv_1$sign)


# community 2  - calculation RD
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sing<-median(rdiv_2$sign)

# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sing<-median(rdiv_3$sign)


plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```


```{r}
dd1 <- data.frame(rdiv_1[, c(8:9)]) 
dd1$cor <- "negative"
dd1$z1 <- "low"

dd2 <- data.frame(rdiv_2[, c(8:9)]) 
dd2$cor <- "negative"
dd2$z1 <- "medium"

dd3 <- data.frame(rdiv_3[, c(8:9)]) 
dd3$cor <- "negative"
dd3$z1 <- "high"
```


## Low fluctuation in environmental change - negative correlation 
Increasing variance in z1 - negative correlation between env variables (E1 and E2) with *low* fluctuations

We repeat the same steps as in the previous section, but this time E1 and E2 have a very small variance.

```{r plot2env, fig.cap='Environmental variables with *low* variation and negative correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}

library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(mean(E1_series),  mean(E2_series))                                   
sample_covariance_matrix <- matrix(c(1, -1,
                                     -1, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "V1", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


#cor(refs)

# plot env change over time
p_E1 <- refs %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  labs(tag = "(a)")

p_E2 <- refs %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
  labs(tag = "(b)")

# Plot environmental change over time
p_E1 + p_E2
detach("package:MASS", unload=TRUE)
```


```{r results='hide'}
# creating communities
# we are not going to plot spp responses, as they are the same as before.
s <- 4
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 15
# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_1 <- get_directionals(comm, new_data, refs)

# community 2 - intermediate variation in z1. 
species_pars$z1_range <- 25
species_pars$z2_range <- 15
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs)

# community 3 - large variation in z1. 
species_pars$z1_range <- 50
species_pars$z2_range <- 15
# b1_range <- 0.02
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs)


```


### Response diversity calculation 

```{r RDplot2, fig.cap='Directional derivatives and response diversity for the three different communities. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# community 1  - calculation RD

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sing<-median(rdiv_1$sign)


# community 2  - calculation RD
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sing<-median(rdiv_2$sign)

# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sing<-median(rdiv_3$sign)


plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```



```{r}
new_rdiv <- rdiv_1[, c(8)]
new_sign <- rdiv_1[, c(9)]

dd1 <- dd1 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd1$cor <- "negative"
dd1$z1 <- "low"


new_rdiv <- rdiv_2[, c(8)]
new_sign <- rdiv_2[, c(9)]

dd2 <- dd2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd2$cor <- "negative"
dd2$z1 <- "medium"


new_rdiv <- rdiv_3[, c(8)]
new_sign <- rdiv_3[, c(9)]

dd3 <- dd3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd3$cor <- "negative"
dd3$z1 <- "high"
```


## High fluctuation in environmental change - positive correlation
Increasing variance in z1 - positive correlation between env variables (E1 and E2) with *high* fluctuations

Same steps as before (3 communities with increasing diversity ib z1 while z2 is fixed), but the correlation between E1 and E1 is negative.
 
```{r plot3env, fig.cap='Environmental variables with high variation and positive correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
library(MASS)
sample_size <- 15                                       
sample_medianvector <- c(mean(E1_series),  mean(E2_series))                                   
sample_covariance_matrix <- matrix(c(150, 150,
                                     150, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(5655)
refs <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "V1", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))



# plot env change over time
p_E1 <- refs %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  labs(tag = "(a)")

p_E2 <- refs %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
  labs(tag = "(b)")

# Plot environmental change over time
p_E1 + p_E2
detach("package:MASS", unload=TRUE)
```




```{r}
# create reproducible community
set.seed(2456)
s <- 4
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_1 <- get_directionals(comm, new_data, refs)

# community 2 - intermediate variation in z1. 
species_pars$z1_range <- 25
species_pars$z2_range <- 15
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs)


# community 3 - large variation in z1. 
species_pars$z1_range <- 50
species_pars$z2_range <- 15
# b1_range <- 0.02
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_3 <- get_directionals(comm, new_data, refs)


```


### Response diversity calculation 

```{r RDplot3, fig.cap='Directional derivatives and response diversity for the three different communities. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# community 1  - calculation RD

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sing<-median(rdiv_1$sign)


# community 2  - calculation RD
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sing<-median(rdiv_2$sign)

# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sing<-median(rdiv_3$sign)



plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```


```{r}
dd4 <- data.frame(rdiv_1[, c(8:9)]) 
dd4$cor <- "positive"
dd4$z1 <- "low"

dd5 <- data.frame(rdiv_2[, c(8:9)]) 
dd5$cor <- "positive"
dd5$z1 <- "medium"

dd6 <- data.frame(rdiv_3[, c(8:9)]) 
dd6$cor <- "positive"
dd6$z1 <- "high"
```



## Low fluctuation in environmental change - positive correlation

Increasing variance in z1 - positive correlation between env variables (E1 and E2) with *low* fluctuations

We repeat the same steps as in the previous section, but this time E1 and E2 have a very small variance.

```{r plot4env, fig.cap='Environmental variables with *low* variation and negative correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(mean(E1_series),  mean(E2_series))                                   
sample_covariance_matrix <- matrix(c(1, 1,
                                     1, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(5655)
refs <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "V1", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


# plot env change over time
p_E1 <- refs %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  labs(tag = "(a)")

p_E2 <- refs %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
  labs(tag = "(b)")

# Plot environmental change over time
p_E1 + p_E2
detach("package:MASS", unload=TRUE)
```

```{r}
# create reproducible community
set.seed(2456)
s <- 4
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_1 <- get_directionals(comm, new_data, refs)

# community 2 - intermediate variation in z1. 
species_pars$z1_range <- 25
species_pars$z2_range <- 15
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs)


# community 3 - large variation in z1. 
species_pars$z1_range <- 50
species_pars$z2_range <- 15
# b1_range <- 0.02
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs)

```


### Response diversity calculation 

```{r RDplot4, fig.cap=' Directional derivatives and response diversity for the three different communities. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}

# community 1  - calculation RD

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sing<-median(rdiv_1$sign)


# community 2  - calculation RD
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sing<-median(rdiv_2$sign)

# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sing<-median(rdiv_3$sign)


plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```

```{r}
new_rdiv <- rdiv_1[, c(8)]
new_sign <- rdiv_1[, c(9)]

dd4 <- dd4 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd4$cor <- "positive"
dd4$z1 <- "low"


new_rdiv <- rdiv_2[, c(8)]
new_sign <- rdiv_2[, c(9)]

dd5 <- dd5 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd5$cor <- "positive"
dd5$z1 <- "medium"


new_rdiv <- rdiv_3[, c(8)]
new_sign <- rdiv_3[, c(9)]

dd6 <- dd6 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd6$cor <- "positive"
dd6$z1 <- "high"
```

## High fluctuation in environmental change - no correlation
Increasing variance in z1 - no correlation between env variables (E1 and E2) with *high* fluctuations

Same steps as before (3 communities with increasing diversity in z1 while z2 is fixed), but there is no correlation between E1 and E1

```{r plot5env, fig.cap='Environmental variables with high variation and no correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(mean(E1_series),  mean(E2_series))                                   
sample_covariance_matrix <- matrix(c(150, 0.0,
                                     0.0, 90),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(5655)
refs <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "V1", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


# plot env change over time
p_E1 <- refs %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  labs(tag = "(a)")

p_E2 <- refs %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
  labs(tag = "(b)")

# Plot environmental change over time
p_E1 + p_E2
detach("package:MASS", unload=TRUE)
```

```{r}
# create reproducible community

s <- 4
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_1 <- get_directionals(comm, new_data, refs)

# community 2 - intermediate variation in z1. 
species_pars$z1_range <- 25
species_pars$z2_range <- 15
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs)


# community 3 - large variation in z1. 
species_pars$z1_range <- 50
species_pars$z2_range <- 15
# b1_range <- 0.02
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs)

```


### Response diversity calculation 

```{r RDplot5, fig.cap='Directional derivatives and response diversity for the three different communities. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# community 1  - calculation RD

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sing<-median(rdiv_1$sign)

# community 2  - calculation RD
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sing<-median(rdiv_2$sign)

# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sing<-median(rdiv_3$sign)

plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```



```{r}
dd7 <- data.frame(rdiv_1[, c(8:9)]) 
dd7$cor <- "no_cor"
dd7$z1 <- "low"

dd8 <- data.frame(rdiv_2[, c(8:9)]) 
dd8$cor <- "no_cor"
dd8$z1 <- "medium"

dd9 <- data.frame(rdiv_3[, c(8:9)]) 
dd9$cor <- "no_cor"
dd9$z1 <- "high"
```

## Low fluctuation in environmental change - no correlation
Increasing variance in z1 - no correlation between env variables (E1 and E2) with *low* fluctuations

We repeat the same steps as in the previous section, but this time E1 and E2 have a very small variance.

```{r plot6env, fig.cap='Environmental variables with *low* variation and negative correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}

library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(mean(E1_series),  mean(E2_series))                                   
sample_covariance_matrix <- matrix(c(1, 0.0,
                                     0.0, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(5655)
refs <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "V1", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


# plot env change over time
p_E1 <- refs %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  labs(tag = "(a)")

p_E2 <- refs %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
  labs(tag = "(b)")

# Plot environmental change over time
p_E1 + p_E2
detach("package:MASS", unload=TRUE)
```


```{r}
# create reproducible community

s <- 4
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_1 <- get_directionals(comm, new_data, refs)

# community 2 - intermediate variation in z1. 
species_pars$z1_range <- 25
species_pars$z2_range <- 15
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs)


# community 3 - large variation in z1. 
species_pars$z1_range <- 50
species_pars$z2_range <- 15
# b1_range <- 0.02
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs)
```


### Response diversity calculation 

```{r RDplot6, fig.cap='Directional derivatives and response diversity for the three different communities. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# community 1  - calculation RD

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sing<-median(rdiv_1$sign)

# community 2  - calculation RD
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sing<-median(rdiv_2$sign)

# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sing<-median(rdiv_3$sign)

plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```



```{r}
new_rdiv <- rdiv_1[, c(8)]
new_sign <- rdiv_1[, c(9)]

dd7 <- dd7 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd7$cor <- "no_cor"
dd7$z1 <- "low"


new_rdiv <- rdiv_2[, c(8)]
new_sign <- rdiv_2[, c(9)]

dd8 <- dd8 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd8$cor <- "no_cor"
dd8$z1 <- "medium"


new_rdiv <- rdiv_3[, c(8)]
new_sign <- rdiv_3[, c(9)]

dd9 <- dd9 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd9$cor <- "no_cor"
dd9$z1 <- "high"
```


## Summary plot - Effects of z1 diversity and correlation between environmental variables on response diversity 

```{r SummaryPlot1, fig.align="center", fig.height=8, fig.width=10, fig.cap="Influence of the correlation between environmental variables and z1 diversity on response diversity. (a) Effects of the correlation between environmental variables and z1 diversity on response diversity measured as dissimilarity (sign insensitive measure). (b) Effects of the correlation between environmental variables and z1 diversity on response diversity measured as divergence (sign sensitive measure)."}

dd_plot1 <- rbind(dd1[,c(1,3:4)], dd2[,c(1,3:4)], dd3[,c(1,3:4)],
                  dd4[,c(1,3:4)], dd5[,c(1,3:4)], dd6[,c(1,3:4)], 
                  dd7[,c(1,3:4)], dd8[,c(1,3:4)], dd9[,c(1,3:4)])

theme_set(theme_classic(base_size = 12))

g1.1 <-
  ggplot(dd_plot1, aes(x = cor, y = rdiv, color = z1)) +
   # scale_y_continuous(limits = c(0.99, 1.005), expand = c(0.02, 0.02)) +
    scale_color_uchicago() +
    labs(x = NULL, y = "Dissimilarity (derivatives)") +
    theme(
      legend.position = "none",
      axis.title = element_text(size = 16),
      panel.grid = element_blank()
    )


rdiv1 <- g1.1 +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  stat_summary(fun = mean, geom = "point", size = 5) + labs(tag = "(a)")

dd_plot2 <- rbind(dd1[,c(2,3:4)], dd2[,c(2,3:4)], dd3[,c(2,3:4)],
                  dd4[,c(2,3:4)], dd5[,c(2,3:4)], dd6[,c(2,3:4)], 
                  dd7[,c(2,3:4)], dd8[,c(2,3:4)], dd9[,c(2,3:4)])

g1.2 <-
  ggplot(dd_plot2, aes(x = cor, y = sign, color = z1)) +
    scale_color_uchicago() +
    labs(x = NULL, y = "Divergence (sign sensitive)") +
    theme(
      legend.position = "none",
      axis.title = element_text(size = 16),
      panel.grid = element_blank()
    )

sign1 <- g1.2 +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  stat_summary(fun = mean, geom = "point", size = 5)+ labs(tag = "(b)") +
  ylim(0, 1)

combined <- rdiv1 + sign1 & theme(legend.position = "bottom")
combined + plot_layout(guides = "collect")

```



# Variation in diversity in z1 and z2
Now we do the same, but having also z2 changing together with z1 with positive correlation. So, diversity in z1 and z2 are increasing gradually from low to high in the 3 communities (increasing co-tolerance scenario?).


## High fluctuation in environmental change - negative correlation
Increasing variance in z1 and z2 - negative correlation between environmental variables (E1 and E2) with *high* fluctuations.

We now create 3 communities. Community 1 is characterized by low diversity in z1 and z2, community 2 has medium diversity in z1 and z2, and community 3 has high diversity in z1 and z2. 

E1 and E2 have high fluctuations and *negative* correlation. 

```{r plot7env, fig.cap='Environmental variables with *high* variation and negative correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
# Specify the correlation E1 and E2 
#negative in this example and high variation in E1 and E2 

library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(mean(E1_series),  mean(E2_series))                                   
sample_covariance_matrix <- matrix(c(150, -150,
                                     -150, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "V1", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


#cor(refs)

# plot env change over time
p_E1 <- refs %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  labs(tag = "(a)")

p_E2 <- refs %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
  labs(tag = "(b)")

# Plot environmental change over time
p_E1 + p_E2
detach("package:MASS", unload=TRUE)

```

### Community 1 - low diversity in z1 and z2. 

```{r plotcomm1.2_neg, fig.cap='Community 1, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=6, fig.width=12}
s <- 4
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm1 <- multi_performance_plot(comm)
performance_comm1
# Get directional dreivatives
dir_1 <- get_directionals(comm, new_data, refs)

```


### Community 2 - medium diversity in z1 and z2. 

```{r plotcomm2.1_neg, fig.cap='Community 2, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=6, fig.width=12}

species_pars$z1_range <- 25
species_pars$z2_range <- 25
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm2 <- multi_performance_plot(comm)
performance_comm2
# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs)

```



### Community 3 - high diversity in z1 and z2. 

```{r plotcomm3.2_neg, fig.cap='Community 3, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=6, fig.width=12}
species_pars$z1_range <- 50
species_pars$z2_range <- 50
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm3 <- multi_performance_plot(comm)
performance_comm3
# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs)
```


### Response diversity calculation 

```{r RDplot7, fig.cap='Directional derivatives and response diversity for the three different communities. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}

# community 1  - calculation RD

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sing<-median(rdiv_1$sign)

# community 2  - calculation RD
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sing<-median(rdiv_2$sign)

# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sing<-median(rdiv_3$sign)

plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```

```{r}
dd1 <- data.frame(rdiv_1[, c(8:9)]) 
dd1$cor <- "negative"
dd1$z1 <- "low"

dd2 <- data.frame(rdiv_2[, c(8:9)]) 
dd2$cor <- "negative"
dd2$z1 <- "medium"

dd3 <- data.frame(rdiv_3[, c(8:9)]) 
dd3$cor <- "negative"
dd3$z1 <- "high"
```


## Low fluctuation in environmental change - negative correlation 

Increasing variance in z1 and z2 - negative correlation between env variables (E1 and E2) with *low* fluctuations.

We repeat the same steps as in the previous section, but this time E1 and E2 have a very small variance.

```{r plot8env, fig.cap='Environmental variables with *low* variation and negative correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}

library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(mean(E1_series),  mean(E2_series))                                   
sample_covariance_matrix <- matrix(c(1, -1,
                                     -1, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "V1", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


# plot env change over time
p_E1 <- refs %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  labs(tag = "(a)")

p_E2 <- refs %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
  labs(tag = "(b)")

# Plot environmental change over time
p_E1 + p_E2
detach("package:MASS", unload=TRUE)
```

```{r}
# create communities
s <- 4
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_1 <- get_directionals(comm, new_data, refs)

# community 2 - intermediate variation in z1. 
species_pars$z1_range <- 25
species_pars$z2_range <- 25
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs)

# community 3 - large variation in z1. 
species_pars$z1_range <- 50
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs)

```


### Response diversity calculation 

```{r RDplot8, fig.cap='Directional derivatives and response diversity for the three different communities. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# community 1  - calculation RD

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sing<-median(rdiv_1$sign)

# community 2  - calculation RD
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sing<-median(rdiv_2$sign)

# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sing<-median(rdiv_3$sign)

plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```


```{r}
new_rdiv <- rdiv_1[, c(8)]
new_sign <- rdiv_1[, c(9)]

dd1 <- dd1 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd1$cor <- "negative"
dd1$z1 <- "low"


new_rdiv <- rdiv_2[, c(8)]
new_sign <- rdiv_2[, c(9)]

dd2 <- dd2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd2$cor <- "negative"
dd2$z1 <- "medium"


new_rdiv <- rdiv_3[, c(8)]
new_sign <- rdiv_3[, c(9)]

dd3 <- dd3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd3$cor <- "negative"
dd3$z1 <- "high"
```



## High fluctuation in environmental change - positive correlation
Increasing variance in z1 and z2 - positive correlation between env variables (E1 and E2) with *high* fluctuations

Same steps as before (3 communities with increasing diversity in z1 and z2), but there is positive correlation between E1 and E1

```{r plot9env, fig.cap='Environmental variables with high variation and positive correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(mean(E1_series),  mean(E2_series))                                   
sample_covariance_matrix <- matrix(c(150, 150,
                                     150, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(5655)
refs <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "V1", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))



# plot env change over time
p_E1 <- refs %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  labs(tag = "(a)")

p_E2 <- refs %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
  labs(tag = "(b)")

# Plot environmental change over time
p_E1 + p_E2
detach("package:MASS", unload=TRUE)
```



```{r}

# create communities
s <- 4
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_1 <- get_directionals(comm, new_data, refs)

# community 2 - intermediate variation in z1. 
species_pars$z1_range <- 25
species_pars$z2_range <- 25
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs)

# community 3 - large variation in z1. 
species_pars$z1_range <- 50
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs)


```




### Response diversity calculation 

```{r RDplot9, fig.cap='Directional derivatives and response diversity for the three different communities. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}

# community 1  - calculation RD

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sing<-median(rdiv_1$sign)

# community 2  - calculation RD
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sing<-median(rdiv_2$sign)

# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sing<-median(rdiv_3$sign)

plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```


```{r}
dd4 <- data.frame(rdiv_1[, c(8:9)]) 
dd4$cor <- "positive"
dd4$z1 <- "low"

dd5 <- data.frame(rdiv_2[, c(8:9)]) 
dd5$cor <- "positive"
dd5$z1 <- "medium"

dd6 <- data.frame(rdiv_3[, c(8:9)]) 
dd6$cor <- "positive"
dd6$z1 <- "high"
```

## Low fluctuation in environmental change - positive correlation 
Increasing variance in z1 and z2 - positive correlation between env variables (E1 and E2) with *low* fluctuations

We repeat the same steps as in the previous section, but this time E1 and E2 have a very small variance.

```{r plot10env, fig.cap='Environmental variables with *low* variation and positive correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}

library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(mean(E1_series),  mean(E2_series))                                   
sample_covariance_matrix <- matrix(c(1, 1,
                                     1, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(5655)
refs <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "V1", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

# plot env change over time
p_E1 <- refs %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  labs(tag = "(a)")

p_E2 <- refs %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
  labs(tag = "(b)")

# Plot environmental change over time
p_E1 + p_E2
detach("package:MASS", unload=TRUE)
```


```{r}
# create communities
s <- 4
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_1 <- get_directionals(comm, new_data, refs)

# community 2 - intermediate variation in z1. 
species_pars$z1_range <- 25
species_pars$z2_range <- 25
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs)

# community 3 - large variation in z1. 
species_pars$z1_range <- 50
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs)

```



### Response diversity calculation 
 
```{r RDplot10, fig.cap='Directional derivatives and response diversity for the three different communities. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# community 1  - calculation RD

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sing<-median(rdiv_1$sign)

# community 2  - calculation RD
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sing<-median(rdiv_2$sign)

# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sing<-median(rdiv_3$sign)

plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```



```{r}
new_rdiv <- rdiv_1[, c(8)]
new_sign <- rdiv_1[, c(9)]

dd4 <- dd4 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd4$cor <- "positive"
dd4$z1 <- "low"


new_rdiv <- rdiv_2[, c(8)]
new_sign <- rdiv_2[, c(9)]

dd5 <- dd5 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd5$cor <- "positive"
dd5$z1 <- "medium"


new_rdiv <- rdiv_3[, c(8)]
new_sign <- rdiv_3[, c(9)]

dd6 <- dd6 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd6$cor <- "positive"
dd6$z1 <- "high"
```

## High fluctuation in environmental change - no correlation
Increasing variance in z1 and z2 - no correlation between env variables (E1 and E2) with *high* fluctuations

Same steps as before (3 communities with increasing diversity in z1 and z2), but there is no correlation between E1 and E1.

```{r plot11env, fig.cap='Environmental variables with high variation and no correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(mean(E1_series),  mean(E2_series))                                   
sample_covariance_matrix <- matrix(c(150, 0.0,
                                     0.0, 90),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(5655)
refs <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "V1", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))



# plot env change over time
p_E1 <- refs %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  labs(tag = "(a)")

p_E2 <- refs %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
  labs(tag = "(b)")

# Plot environmental change over time
p_E1 + p_E2
detach("package:MASS", unload=TRUE)
```


```{r}
# create communities
s <- 4
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_1 <- get_directionals(comm, new_data, refs)

# community 2 - intermediate variation in z1. 
species_pars$z1_range <- 25
species_pars$z2_range <- 25
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs)

# community 3 - large variation in z1. 
species_pars$z1_range <- 50
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs)

```


### Response diversity calculation 

```{r RDplot11, fig.cap='Directional derivatives and response diversity for the three different communities. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}

# community 1  - calculation RD

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sing<-median(rdiv_1$sign)

# community 2  - calculation RD
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sing<-median(rdiv_2$sign)

# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sing<-median(rdiv_3$sign)

plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```



```{r}
dd7 <- data.frame(rdiv_1[, c(8:9)]) 
dd7$cor <- "no_cor"
dd7$z1 <- "low"

dd8 <- data.frame(rdiv_2[, c(8:9)]) 
dd8$cor <- "no_cor"
dd8$z1 <- "medium"

dd9 <- data.frame(rdiv_3[, c(8:9)]) 
dd9$cor <- "no_cor"
dd9$z1 <- "high"
```

## Low fluctuation in environmental change - no correlation

Increasing variance in z1 and z2 - no correlation between env variables (E1 and E2) with *low* fluctuations.

We repeat the same steps as in the previous section, but this time E1 and E2 have a very small variance.

```{r plot12env, fig.cap='Environmental variables with *low* variation and negative correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(mean(E1_series),  mean(E2_series))                                   
sample_covariance_matrix <- matrix(c(1, 0.0,
                                     0.0, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(5655)
refs <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "V1", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


# plot env change over time
p_E1 <- refs %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  labs(tag = "(a)")

p_E2 <- refs %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
  labs(tag = "(b)")

# Plot environmental change over time
p_E1 + p_E2
detach("package:MASS", unload=TRUE)
```

```{r}
# create communities
s <- 4
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_1 <- get_directionals(comm, new_data, refs)

# community 2 - intermediate variation in z1. 
species_pars$z1_range <- 25
species_pars$z2_range <- 25
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs)

# community 3 - large variation in z1. 
species_pars$z1_range <- 50
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs)

```

### Response diversity calculation 

```{r RDplot12, fig.cap='Directional derivatives and response diversity for the three different communities. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# community 1  - calculation RD

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sing<-median(rdiv_1$sign)

# community 2  - calculation RD
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sing<-median(rdiv_2$sign)

# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sing<-median(rdiv_3$sign)


plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```


```{r}
new_rdiv <- rdiv_1[, c(8)]
new_sign <- rdiv_1[, c(9)]

dd7 <- dd7 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd7$cor <- "no_cor"
dd7$z1 <- "low"


new_rdiv <- rdiv_2[, c(8)]
new_sign <- rdiv_2[, c(9)]

dd8 <- dd8 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd8$cor <- "no_cor"
dd8$z1 <- "medium"


new_rdiv <- rdiv_3[, c(8)]
new_sign <- rdiv_3[, c(9)]

dd9 <- dd9 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd9$cor <- "no_cor"
dd9$z1 <- "high"
```


## Summary plot - Effects of z1 and z2 diversity and correlation between environmental variables on response diversity 

```{r SummaryPlot2, fig.align="center", fig.height=8, fig.width=10, fig.cap="Influence of the correlation between environmental variables and diversity in z1 and z2 on response diversity. In this scenario, diversity in z1 and z2 increases with positive correlation. (a) Effects of the correlation between environmental variables and z1 diversity on response diversity measured as dissimilarity (sign insensitive measure). (b) Effects of the correlation between environmental variables and z1 diversity on response diversity measured as divergence (sign sensitive measure)."}
dd_plot1 <- rbind(dd1[,c(1,3:4)], dd2[,c(1,3:4)], dd3[,c(1,3:4)],
                  dd4[,c(1,3:4)], dd5[,c(1,3:4)], dd6[,c(1,3:4)], 
                  dd7[,c(1,3:4)], dd8[,c(1,3:4)], dd9[,c(1,3:4)])

theme_set(theme_classic(base_size = 12))

g1.1 <-
  ggplot(dd_plot1, aes(x = cor, y = rdiv, color = z1)) +
   # scale_y_continuous(limits = c(0.99, 1.005), expand = c(0.02, 0.02)) +
    scale_color_uchicago() +
    labs(x = NULL, y = "Dissimilarity (derivatives)") +
    theme(
      legend.position = "none",
      axis.title = element_text(size = 16),
      panel.grid = element_blank()
    )


rdiv2 <- g1.1 +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  stat_summary(fun = mean, geom = "point", size = 5) + labs(tag = "(a)")

dd_plot2 <- rbind(dd1[,c(2,3:4)], dd2[,c(2,3:4)], dd3[,c(2,3:4)],
                  dd4[,c(2,3:4)], dd5[,c(2,3:4)], dd6[,c(2,3:4)], 
                  dd7[,c(2,3:4)], dd8[,c(2,3:4)], dd9[,c(2,3:4)])

g1.2 <-
  ggplot(dd_plot2, aes(x = cor, y = sign, color = z1)) +
    scale_color_uchicago() +
    labs(x = NULL, y = "Divergence (sign sensitive)") +
    theme(
      legend.position = "none",
      axis.title = element_text(size = 16),
      panel.grid = element_blank()
    )

sign2 <- g1.2 +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  stat_summary(fun = mean, geom = "point", size = 5)+ labs(tag = "(b)") +
  ylim(0, 1)

combined <- rdiv2 + sign2 & theme(legend.position = "bottom")
combined + plot_layout(guides = "collect")
```



# Variation in diversity in z1 and z2
Now we do the same, but having also z2 changing together with z1 with negative correlation. So, diversity in z1 is increasing gradually from low to high in the 3 communities, while z2 decreases gradually in the 3 communities (anti-tolerance scenario?).


## High fluctuation in environmental change - negative correlation
Increasing variance in z1 and z2 - negative correlation between env variables (E1 and E2) with *high* fluctuations.

We now create 3 communities. Community 1 is characterized by low diversity in z1 and high diversity in z2, community 2 has medium diversity in z1 and z2, and community 3 has high diversity in z1 and low in z2. 

E1 and E2 have high fluctuations and *negative* correlation. 
 
```{r plot13env, fig.cap='Environmental variables with *high* variation and negative correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(mean(E1_series),  mean(E2_series))                                   
sample_covariance_matrix <- matrix(c(150, -150,
                                     -150, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "V1", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


# plot env change over time
p_E1 <- refs %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  labs(tag = "(a)")

p_E2 <- refs %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
  labs(tag = "(b)")

# Plot environmental change over time
p_E1 + p_E2
detach("package:MASS", unload=TRUE)
```

### Community 1 - low diversity in z1 and high diversity in z2. 

```{r plotcomm1.3_neg, fig.cap='Community 1, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=6, fig.width=12}
s <- 4
# community 1 - low variation in z1 high in z2. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)
# Visualise spp performances 
performance_comm1 <- multi_performance_plot(comm)
performance_comm1

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs)
```


### Community 2 - medium diversity in z1 and z2. 

```{r plotcomm2.3_neg, fig.cap='Community 2, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=6, fig.width=12}
species_pars$z1_range <- 25
species_pars$z2_range <- 25
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualize spp performances 
performance_comm2 <- multi_performance_plot(comm)
performance_comm2
# Get directional derivatives
dir_2 <- get_directionals(comm, new_data, refs)
```

### Community 3 - high diversity in z1 and low in z2. 

```{r plotcomm3.3_neg, fig.cap='Community 3, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=6, fig.width=12}
species_pars$z1_range <- 50
vz2_range <- 1.5
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s,species_pars)

# Visualise spp performances 
performance_comm3 <- multi_performance_plot(comm)
performance_comm3
# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs)
```

### Response diversity calculation 

```{r RDplot13, fig.cap='Directional derivatives and response diversity for the three different communities. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# community 1  - calculation RD

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sing<-median(rdiv_1$sign)

# community 2  - calculation RD
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sing<-median(rdiv_2$sign)

# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sing<-median(rdiv_3$sign)

plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```



```{r}
dd1 <- data.frame(rdiv_1[, c(8:9)]) 
dd1$cor <- "negative"
dd1$z1 <- "low"

dd2 <- data.frame(rdiv_2[, c(8:9)]) 
dd2$cor <- "negative"
dd2$z1 <- "medium"

dd3 <- data.frame(rdiv_3[, c(8:9)]) 
dd3$cor <- "negative"
dd3$z1 <- "high"
```

```{r}
dd1z2 <- data.frame(rdiv_1[, c(8:9)]) 
dd1z2$cor <- "negative"
dd1z2$z2 <- "high"

dd2z2 <- data.frame(rdiv_2[, c(8:9)]) 
dd2z2$cor <- "negative"
dd2z2$z2 <- "medium"

dd3z2 <- data.frame(rdiv_3[, c(8:9)]) 
dd3z2$cor <- "negative"
dd3z2$z2 <- "low"
```

## Low fluctuation in environmental change - negative correlation 
Increasing variance in z1 and z2 - negative correlation between env variables (E1 and E2) with *low* fluctuations

We repeat the same steps as in the previous section, but this time E1 and E2 have a very small variance.

```{r plot14env, fig.cap='Environmental variables with *low* variation and negative correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(mean(E1_series),  mean(E2_series))                                   
sample_covariance_matrix <- matrix(c(1, -1,
                                     -1, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "V1", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


# plot env change over time
p_E1 <- refs %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  labs(tag = "(a)")

p_E2 <- refs %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
  labs(tag = "(b)")

# Plot environmental change over time
p_E1 + p_E2
detach("package:MASS", unload=TRUE)
```



```{r}
# create communities
s <- 4
# community 1 - low variation in z1 high in z2. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)
# Visualise spp performances 
performance_comm1 <- multi_performance_plot(comm)


# Get directional dreivatives
dir_1 <- get_directionals(comm, new_data, refs)


# community 2 - intermediate variation in z1. 
species_pars$z1_range <- 25
species_pars$z2_range <- 25
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs)


# community 3 - large variation in z1. 
species_pars$z1_range <- 50
species_pars$z2_range <- 1.5
# b1_range <- 0.02
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs)
```


### Response diversity calculation 

```{r RDplot14, fig.cap='Directional derivatives and response diversity for the three different communities. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# community 1  - calculation RD

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sing<-median(rdiv_1$sign)

# community 2  - calculation RD
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sing<-median(rdiv_2$sign)
# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sing<-median(rdiv_3$sign)

plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)

```



```{r}
new_rdiv <- rdiv_1[, c(8)]
new_sign <- rdiv_1[, c(9)]

dd1 <- dd1 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd1$cor <- "negative"
dd1$z1 <- "low"


new_rdiv <- rdiv_2[, c(8)]
new_sign <- rdiv_2[, c(9)]

dd2 <- dd2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd2$cor <- "negative"
dd2$z1 <- "medium"


new_rdiv <- rdiv_3[, c(8)]
new_sign <- rdiv_3[, c(9)]

dd3 <- dd3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd3$cor <- "negative"
dd3$z1 <- "high"
```




```{r}
new_rdiv <- rdiv_1[, c(8)]
new_sign <- rdiv_1[, c(9)]

dd1z2 <- dd1z2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd1z2$cor <- "negative"
dd1z2$z2 <- "high"


new_rdiv <- rdiv_2[, c(8)]
new_sign <- rdiv_2[, c(9)]

dd2z2 <- dd2z2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd2z2$cor <- "negative"
dd2z2$z2 <- "medium"


new_rdiv <- rdiv_3[, c(8)]
new_sign <- rdiv_3[, c(9)]

dd3z2 <- dd3z2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd3z2$cor <- "negative"
dd3z2$z2 <- "low"
```
## High fluctuation in environmental change - positive correlation
Increasing variance in z1 and decreasing in z2 - positive correlation between env variables (E1 and E2) with *high* fluctuations

Same steps as before (3 communities with increasing diversity in z1 and z2), but there is positive correlation between E1 and E1

```{r plot15env, fig.cap='Environmental variables with high variation and positive correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(mean(E1_series),  mean(E2_series))                                   
sample_covariance_matrix <- matrix(c(150, 150,
                                     150, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(5655)
refs <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "V1", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


# plot env change over time
p_E1 <- refs %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  labs(tag = "(a)")

p_E2 <- refs %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
  labs(tag = "(b)")

# Plot environmental change over time
p_E1 + p_E2
detach("package:MASS", unload=TRUE)
```


```{r}

# create communities
s <- 4
# community 1 - low variation in z1 high in z2. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)
# Visualise spp performances 
performance_comm1 <- multi_performance_plot(comm)


# Get directional dreivatives
dir_1 <- get_directionals(comm, new_data, refs)


# community 2 - intermediate variation in z1. 
species_pars$z1_range <- 25
species_pars$z2_range <- 25
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs)


# community 3 - large variation in z1. 
species_pars$z1_range <- 50
species_pars$z2_range <- 1.5
# b1_range <- 0.02
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs)

```



### Response diversity calculation 

```{r RDplot15, fig.cap='Directional derivatives and response diversity for the three different communities. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# community 1  - calculation RD

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sing<-median(rdiv_1$sign)

# community 2  - calculation RD
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sing<-median(rdiv_2$sign)

# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sing<-median(rdiv_3$sign)

plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```



```{r}
dd4 <- data.frame(rdiv_1[, c(8:9)]) 
dd4$cor <- "positive"
dd4$z1 <- "low"

dd5 <- data.frame(rdiv_2[, c(8:9)]) 
dd5$cor <- "positive"
dd5$z1 <- "medium"

dd6 <- data.frame(rdiv_3[, c(8:9)]) 
dd6$cor <- "positive"
dd6$z1 <- "high"
```


```{r}
dd4z2 <- data.frame(rdiv_1[, c(8:9)]) 
dd4z2$cor <- "positive"
dd4z2$z2 <- "high"

dd5z2 <- data.frame(rdiv_2[, c(8:9)]) 
dd5z2$cor <- "positive"
dd5z2$z2 <- "medium"

dd6z2 <- data.frame(rdiv_3[, c(8:9)]) 
dd6z2$cor <- "positive"
dd6z2$z2 <- "low"
```
## Low fluctuation in environmental change - positive correlation 
Increasing variance in z1 and decreasing in 2 - positive correlation between env variables (E1 and E2) with *low* fluctuations.

We repeat the same steps as in the previous section, but this time E1 and E2 have a very small variance.

```{r plot16env, fig.cap='Environmental variables with *low* variation and positive correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(mean(E1_series),  mean(E2_series))                                   
sample_covariance_matrix <- matrix(c(1, 1,
                                     1, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(5655)
refs <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "V1", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


# plot env change over time
p_E1 <- refs %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  labs(tag = "(a)")

p_E2 <- refs %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
  labs(tag = "(b)")

# Plot environmental change over time
p_E1 + p_E2
detach("package:MASS", unload=TRUE)
```


```{r}

# create communities
s <- 4
# community 1 - low variation in z1 high in z2. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)
# Visualise spp performances 
performance_comm1 <- multi_performance_plot(comm)


# Get directional dreivatives
dir_1 <- get_directionals(comm, new_data, refs)


# community 2 - intermediate variation in z1. 
species_pars$z1_range <- 25
species_pars$z2_range <- 25
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs)


# community 3 - large variation in z1. 
species_pars$z1_range <- 50
species_pars$z2_range <- 1.5
# b1_range <- 0.02
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs)

```



### Response diversity calculation 

```{r RDplot16, fig.cap=' Directional derivatives and response diversity for the three different communities. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# community 1  - calculation RD

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sing<-median(rdiv_1$sign)

# community 2  - calculation RD
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sing<-median(rdiv_2$sign)

# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sing<-median(rdiv_3$sign)

plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```


```{r}
new_rdiv <- rdiv_1[, c(8)]
new_sign <- rdiv_1[, c(9)]

dd4 <- dd4 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd4$cor <- "positive"
dd4$z1 <- "low"


new_rdiv <- rdiv_2[, c(8)]
new_sign <- rdiv_2[, c(9)]

dd5 <- dd5 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd5$cor <- "positive"
dd5$z1 <- "medium"


new_rdiv <- rdiv_3[, c(8)]
new_sign <- rdiv_3[, c(9)]

dd6 <- dd6 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd6$cor <- "positive"
dd6$z1 <- "high"
```


```{r}
new_rdiv <- rdiv_1[, c(8)]
new_sign <- rdiv_1[, c(9)]

dd4z2 <- dd4z2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd4z2$cor <- "positive"
dd4z2$z2 <- "high"


new_rdiv <- rdiv_2[, c(8)]
new_sign <- rdiv_2[, c(9)]

dd5z2 <- dd5z2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd5z2$cor <- "positive"
dd5z2$z2 <- "medium"


new_rdiv <- rdiv_3[, c(8)]
new_sign <- rdiv_3[, c(9)]

dd6z2 <- dd6z2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd6z2$cor <- "positive"
dd6z2$z2 <- "low"
```
## High fluctuation in environmental change - no correlation
Increasing variance in z1 and decreasing in z2 - no correlation between env variables (E1 and E2) with *high* fluctuations

Same steps as before (3 communities with increasing diversity in z1 and z2), but there is no correlation between E1 and E1

```{r plot17env, fig.cap='Environmental variables with high variation and no correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(mean(E1_series),  mean(E2_series))                                   
sample_covariance_matrix <- matrix(c(150, 0.0,
                                     0.0, 90),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(5655)
refs <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "V1", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

# plot env change over time
p_E1 <- refs %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  labs(tag = "(a)")

p_E2 <- refs %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
  labs(tag = "(b)")

# Plot environmental change over time
p_E1 + p_E2
detach("package:MASS", unload=TRUE)
```


```{r}
# create communities
s <- 4
# community 1 - low variation in z1 high in z2. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)
# Visualise spp performances 
performance_comm1 <- multi_performance_plot(comm)


# Get directional dreivatives
dir_1 <- get_directionals(comm, new_data, refs)


# community 2 - intermediate variation in z1. 
species_pars$z1_range <- 25
species_pars$z2_range <- 25
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs)


# community 3 - large variation in z1. 
species_pars$z1_range <- 50
species_pars$z2_range <- 1.5
# b1_range <- 0.02
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_3 <- get_directionals(comm, new_data, refs)

```

### Response diversity calculation 
 
```{r RDplot17, fig.cap='Directional derivatives and response diversity for the three different communities. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# community 1  - calculation RD

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sing<-median(rdiv_1$sign)

# community 2  - calculation RD
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sing<-median(rdiv_2$sign)

# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sing<-median(rdiv_3$sign)

plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```


```{r}
dd7 <- data.frame(rdiv_1[, c(8:9)]) 
dd7$cor <- "no_cor"
dd7$z1 <- "low"

dd8 <- data.frame(rdiv_2[, c(8:9)]) 
dd8$cor <- "positive"
dd8$z1 <- "medium"

dd9 <- data.frame(rdiv_3[, c(8:9)]) 
dd9$cor <- "positive"
dd9$z1 <- "high"
```


```{r}
dd7z2 <- data.frame(rdiv_1[, c(8:9)]) 
dd7z2$cor <- "no_cor"
dd7z2$z2 <- "high"

dd8z2 <- data.frame(rdiv_2[, c(8:9)]) 
dd8z2$cor <- "positive"
dd8z2$z2 <- "medium"

dd9z2 <- data.frame(rdiv_3[, c(8:9)]) 
dd9z2$cor <- "positive"
dd9z2$z2 <- "low"
```
## Low fluctuation in environmental change - no correlation
Increasing variance in z1 and decreasing in z2 - no correlation between env variables (E1 and E2) with *low* fluctuations

We repeat the same steps as in the previous section, but this time E1 and E2 have a very small variance.

```{r plot18env, fig.cap='Environmental variables with *low* variation and negative correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(mean(E1_series),  mean(E2_series))                                   
sample_covariance_matrix <- matrix(c(1, 0.0,
                                     0.0, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(5655)
refs <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "V1", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

# plot env change over time
p_E1 <- refs %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  labs(tag = "(a)")

p_E2 <- refs %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
  labs(tag = "(b)")

# Plot environmental change over time
p_E1 + p_E2
detach("package:MASS", unload=TRUE)
```


```{r}
# create communities
s <- 4
# community 1 - low variation in z1 high in z2. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)
# Visualise spp performances 
performance_comm1 <- multi_performance_plot(comm)


# Get directional dreivatives
dir_1 <- get_directionals(comm, new_data, refs)


# community 2 - intermediate variation in z1. 
species_pars$z1_range <- 25
species_pars$z2_range <- 25
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs)


# community 3 - large variation in z1. 
species_pars$z1_range <- 50
species_pars$z2_range <- 1.5
# b1_range <- 0.02
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs)

```




### Response diversity calculation 

```{r RDplot18, fig.cap='Directional derivatives and response diversity for the three different communities. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# community 1  - calculation RD

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sing<-median(rdiv_1$sign)

# community 2  - calculation RD
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sing<-median(rdiv_2$sign)

# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sing<-median(rdiv_3$sign)

plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)

```


```{r}
new_rdiv <- rdiv_1[, c(8)]
new_sign <- rdiv_1[, c(9)]

dd7 <- dd7 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd7$cor <- "no_cor"
dd7$z1 <- "low"


new_rdiv <- rdiv_2[, c(8)]
new_sign <- rdiv_2[, c(9)]

dd8 <- dd8 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd8$cor <- "no_cor"
dd8$z1 <- "medium"


new_rdiv <- rdiv_3[, c(8)]
new_sign <- rdiv_3[, c(9)]

dd9 <- dd9 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd9$cor <- "no_cor"
dd9$z1 <- "high"
```

```{r}
new_rdiv <- rdiv_1[, c(8)]
new_sign <- rdiv_1[, c(9)]

dd7z2 <- dd7z2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd7z2$cor <- "no_cor"
dd7z2$z2 <- "high"


new_rdiv <- rdiv_2[, c(8)]
new_sign <- rdiv_2[, c(9)]

dd8z2 <- dd8z2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd8z2$cor <- "no_cor"
dd8z2$z2 <- "medium"


new_rdiv <- rdiv_3[, c(8)]
new_sign <- rdiv_3[, c(9)]

dd9z2 <- dd9z2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd9z2$cor <- "no_cor"
dd9z2$z2 <- "low"
```

## Summary plot - Effects of z1 and z2 diversity and correlation between environmental variables on response diversity 

```{r SummaryPlot3,fig.align="center", fig.height=8, fig.width=10, fig.cap="Influence of the correlation between environmental variables and diversity in z1 and z2 on response diversity. In this scenario, diversity in z1 increases with negative correlation with respect to diversity in z2. (a) Effects of the correlation between environmental variables and z1 diversity on response diversity measured as dissimilarity (sign insensitive measure). (b) Effects of the correlation between environmental variables and z1 diversity on response diversity measured as divergence (sign sensitive measure)."}
dd_plot1 <- rbind(dd1[,c(1,3:4)], dd2[,c(1,3:4)], dd3[,c(1,3:4)],
                  dd4[,c(1,3:4)], dd5[,c(1,3:4)], dd6[,c(1,3:4)], 
                  dd7[,c(1,3:4)], dd8[,c(1,3:4)], dd9[,c(1,3:4)])

theme_set(theme_classic(base_size = 12))

g1.1 <-
  ggplot(dd_plot1, aes(x = cor, y = rdiv, color = z1)) +
   # scale_y_continuous(limits = c(0.99, 1.005), expand = c(0.02, 0.02)) +
    scale_color_uchicago() +
    labs(x = NULL, y = "Dissimilarity (derivatives)") +
    theme(
      legend.position = "none",
      axis.title = element_text(size = 16),
      panel.grid = element_blank()
    )


rdiv3 <- g1.1 +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  stat_summary(fun = mean, geom = "point", size = 5) + labs(tag = "(a)")

dd_plot2 <- rbind(dd1[,c(2,3:4)], dd2[,c(2,3:4)], dd3[,c(2,3:4)],
                  dd4[,c(2,3:4)], dd5[,c(2,3:4)], dd6[,c(2,3:4)], 
                  dd7[,c(2,3:4)], dd8[,c(2,3:4)], dd9[,c(2,3:4)])

g1.2 <-
  ggplot(dd_plot2, aes(x = cor, y = sign, color = z1)) +
    scale_color_uchicago() +
    labs(x = NULL, y = "Divergence (sign sensitive)") +
    theme(
      legend.position = "none",
      axis.title = element_text(size = 16),
      panel.grid = element_blank()
    )

sign3 <- g1.2 +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  stat_summary(fun = mean, geom = "point", size = 5)+ labs(tag = "(b)") +
  ylim(0, 1)

combined <- rdiv3 + sign3 & theme(legend.position = "bottom")
combined + plot_layout(guides = "collect")
```


### Focus on z2 
```{r SummaryPlotz2,fig.align="center", fig.height=8, fig.width=10, fig.cap="Focusing on z2. (a) Effects of the correlation between environmental variables and z1 diversity on response diversity measured as dissimilarity (sign insensitive measure). (b) Effects of the correlation between environmental variables and z1 diversity on response diversity measured as divergence (sign sensitive measure)."}
dd_plot1 <- rbind(dd1z2[,c(1,3:4)], dd2z2[,c(1,3:4)], dd3z2[,c(1,3:4)],
                  dd4z2[,c(1,3:4)], dd5z2[,c(1,3:4)], dd6z2[,c(1,3:4)], 
                  dd7z2[,c(1,3:4)], dd8z2[,c(1,3:4)], dd9z2[,c(1,3:4)])

theme_set(theme_classic(base_size = 12))

g1.1 <-
  ggplot(dd_plot1, aes(x = cor, y = rdiv, color = z2)) +
   # scale_y_continuous(limits = c(0.99, 1.005), expand = c(0.02, 0.02)) +
    scale_color_uchicago() +
    labs(x = NULL, y = "Dissimilarity (derivatives)") +
    theme(
      legend.position = "none",
      axis.title = element_text(size = 16),
      panel.grid = element_blank()
    )


rdiv3z2 <- g1.1 +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  stat_summary(fun = mean, geom = "point", size = 5) + labs(tag = "(a)")

dd_plot2 <- rbind(dd1z2[,c(2,3:4)], dd2z2[,c(2,3:4)], dd3z2[,c(2,3:4)],
                  dd4z2[,c(2,3:4)], dd5z2[,c(2,3:4)], dd6z2[,c(2,3:4)], 
                  dd7z2[,c(2,3:4)], dd8z2[,c(2,3:4)], dd9z2[,c(2,3:4)])

g1.2 <-
  ggplot(dd_plot2, aes(x = cor, y = sign, color = z2)) +
    scale_color_uchicago() +
    labs(x = NULL, y = "Divergence (sign sensitive)") +
    theme(
      legend.position = "none",
      axis.title = element_text(size = 16),
      panel.grid = element_blank()
    )

sign3z2 <- g1.2 +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  stat_summary(fun = mean, geom = "point", size = 5)+ labs(tag = "(b)") +
  ylim(0, 1)

combined <- rdiv3z2 + sign3z2 & theme(legend.position = "bottom")
combined + plot_layout(guides = "collect")
```

# Overall Summary plot - Effects of z1 and z2 diversity and correlation between environmental variables on response diversity 

```{r CorrSummary,  fig.height=10, fig.width=12, fig.cap="Influence of the correlation between environmental variables and diversity in z1 and z2 on response diversity. All data across all scenarios pooled together. (a), (b), and (c) Effects of the correlation between environmental variables and z1 diversity on response diversity measured as dissimilarity (sign insensitive measure). (d), (e), and (f) Effects of the correlation between environmental variables and z1 diversity on response diversity measured as divergence (sign sensitive measure).", fig.align="center"}
rdiv1 <- rdiv1 + ggtitle("Only variation in z1") + labs(tag = "(a)")
rdiv2 <- rdiv2 + ggtitle("Variation in z1 and z2\npositive correlation") + labs(tag = "(b)")
rdiv3 <- rdiv3 + ggtitle("Variation in z1 and z2\nnegative correlation") + labs(tag = "(c)")

sign1 <- sign1 + ggtitle("Only variation in z1") + labs(tag = "(d)")
sign2 <- sign2 + ggtitle("Variation in z1 and z2\npositive correlation") + labs(tag = "(e)")
sign3 <- sign3 + ggtitle("Variation in z1 and z2\nnegative correlation") + labs(tag = "(e)")

combined <- rdiv1 + rdiv2 + rdiv3 + sign1 + sign2 +sign3 & theme(legend.position = "bottom")
combined + plot_layout(guides = "collect")
```







# Reducing mean z2 

```{r}
## Set species parameters
species_pars <- list(a1_mean = 1e-9,
  b1_mean = 0.063,
  z1_mean = 285,
  w1_mean = 60,
  a2_mean = 1e-3,
  b2_mean = 0.02,
  z2_mean = 5,
  w2_mean = 10,
  zint_mean = 0,
  sd_rate_mean = 0,
  z1_range = NA,
  z2_range = NA)

```


# Variation in diversity in z1 and z2
Now we do the same, but having also z2 changing together with z1 with negative correlation. So, diversity in z1 is increasing gradually from low to high in the 3 communities, while z2 decreases gradually in the 3 communities (anti-tolerance scenario?).


## High fluctuation in environmental change - negative correlation
Increasing variance in z1 and z2 - negative correlation between env variables (E1 and E2) with *high* fluctuations.

We now create 3 communities. Community 1 is characterized by low diversity in z1 and high diversity in z2, community 2 has medium diversity in z1 and z2, and community 3 has high diversity in z1 and low in z2. 

E1 and E2 have high fluctuations and *negative* correlation. 
 
```{r plot19env, fig.cap='Environmental variables with *high* variation and negative correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(mean(E1_series),  mean(E2_series))                                   
sample_covariance_matrix <- matrix(c(150, -150,
                                     -150, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "V1", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


# plot env change over time
p_E1 <- refs %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  labs(tag = "(a)")

p_E2 <- refs %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
  labs(tag = "(b)")

# Plot environmental change over time
p_E1 + p_E2
detach("package:MASS", unload=TRUE)
```

### Community 1 - low diversity in z1 and high diversity in z2. 

```{r plotcomm1.3_negz2, fig.cap='Community 1, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=6, fig.width=12}
s <- 4
# community 1 - low variation in z1 high in z2. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)
# Visualise spp performances 
performance_comm1 <- multi_performance_plot(comm)
performance_comm1

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs)
```


### Community 2 - medium diversity in z1 and z2. 

```{r plotcomm2.3_negz2, fig.cap='Community 2, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=6, fig.width=12}
species_pars$z1_range <- 25
species_pars$z2_range <- 25
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualize spp performances 
performance_comm2 <- multi_performance_plot(comm)
performance_comm2
# Get directional derivatives
dir_2 <- get_directionals(comm, new_data, refs)
```

### Community 3 - high diversity in z1 and low in z2. 

```{r plotcomm3.3_negz2, fig.cap='Community 3, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=6, fig.width=12}
species_pars$z1_range <- 50
vz2_range <- 1.5
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s,species_pars)

# Visualise spp performances 
performance_comm3 <- multi_performance_plot(comm)
performance_comm3
# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs)
```

### Response diversity calculation 

```{r RDplot20, fig.cap='Directional derivatives and response diversity for the three different communities. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# community 1  - calculation RD

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sing<-median(rdiv_1$sign)

# community 2  - calculation RD
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sing<-median(rdiv_2$sign)

# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sing<-median(rdiv_3$sign)

plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```



```{r}
dd1 <- data.frame(rdiv_1[, c(8:9)]) 
dd1$cor <- "negative"
dd1$z1 <- "low"

dd2 <- data.frame(rdiv_2[, c(8:9)]) 
dd2$cor <- "negative"
dd2$z1 <- "medium"

dd3 <- data.frame(rdiv_3[, c(8:9)]) 
dd3$cor <- "negative"
dd3$z1 <- "high"
```

```{r}
dd1z2 <- data.frame(rdiv_1[, c(8:9)]) 
dd1z2$cor <- "negative"
dd1z2$z2 <- "high"

dd2z2 <- data.frame(rdiv_2[, c(8:9)]) 
dd2z2$cor <- "negative"
dd2z2$z2 <- "medium"

dd3z2 <- data.frame(rdiv_3[, c(8:9)]) 
dd3z2$cor <- "negative"
dd3z2$z2 <- "low"
```

## Low fluctuation in environmental change - negative correlation 
Increasing variance in z1 and z2 - negative correlation between env variables (E1 and E2) with *low* fluctuations

We repeat the same steps as in the previous section, but this time E1 and E2 have a very small variance.

```{r plot21env, fig.cap='Environmental variables with *low* variation and negative correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(mean(E1_series),  mean(E2_series))                                   
sample_covariance_matrix <- matrix(c(1, -1,
                                     -1, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "V1", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


# plot env change over time
p_E1 <- refs %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  labs(tag = "(a)")

p_E2 <- refs %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
  labs(tag = "(b)")

# Plot environmental change over time
p_E1 + p_E2
detach("package:MASS", unload=TRUE)
```



```{r}
# create communities
s <- 4
# community 1 - low variation in z1 high in z2. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)
# Visualise spp performances 
performance_comm1 <- multi_performance_plot(comm)


# Get directional dreivatives
dir_1 <- get_directionals(comm, new_data, refs)


# community 2 - intermediate variation in z1. 
species_pars$z1_range <- 25
species_pars$z2_range <- 25
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs)


# community 3 - large variation in z1. 
species_pars$z1_range <- 50
species_pars$z2_range <- 1.5
# b1_range <- 0.02
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs)
```


### Response diversity calculation 

```{r RDplot14z2, fig.cap='Directional derivatives and response diversity for the three different communities. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# community 1  - calculation RD

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sing<-median(rdiv_1$sign)

# community 2  - calculation RD
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sing<-median(rdiv_2$sign)
# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sing<-median(rdiv_3$sign)

plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)

```



```{r}
new_rdiv <- rdiv_1[, c(8)]
new_sign <- rdiv_1[, c(9)]

dd1 <- dd1 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd1$cor <- "negative"
dd1$z1 <- "low"


new_rdiv <- rdiv_2[, c(8)]
new_sign <- rdiv_2[, c(9)]

dd2 <- dd2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd2$cor <- "negative"
dd2$z1 <- "medium"


new_rdiv <- rdiv_3[, c(8)]
new_sign <- rdiv_3[, c(9)]

dd3 <- dd3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd3$cor <- "negative"
dd3$z1 <- "high"
```




```{r}
new_rdiv <- rdiv_1[, c(8)]
new_sign <- rdiv_1[, c(9)]

dd1z2 <- dd1z2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd1z2$cor <- "negative"
dd1z2$z2 <- "high"


new_rdiv <- rdiv_2[, c(8)]
new_sign <- rdiv_2[, c(9)]

dd2z2 <- dd2z2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd2z2$cor <- "negative"
dd2z2$z2 <- "medium"


new_rdiv <- rdiv_3[, c(8)]
new_sign <- rdiv_3[, c(9)]

dd3z2 <- dd3z2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd3z2$cor <- "negative"
dd3z2$z2 <- "low"
```
## High fluctuation in environmental change - positive correlation
Increasing variance in z1 and decreasing in z2 - positive correlation between env variables (E1 and E2) with *high* fluctuations

Same steps as before (3 communities with increasing diversity in z1 and z2), but there is positive correlation between E1 and E1

```{r plot22env, fig.cap='Environmental variables with high variation and positive correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(mean(E1_series),  mean(E2_series))                                   
sample_covariance_matrix <- matrix(c(150, 150,
                                     150, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(5655)
refs <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "V1", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


# plot env change over time
p_E1 <- refs %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  labs(tag = "(a)")

p_E2 <- refs %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
  labs(tag = "(b)")

# Plot environmental change over time
p_E1 + p_E2
detach("package:MASS", unload=TRUE)
```


```{r}

# create communities
s <- 4
# community 1 - low variation in z1 high in z2. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)
# Visualise spp performances 
performance_comm1 <- multi_performance_plot(comm)


# Get directional dreivatives
dir_1 <- get_directionals(comm, new_data, refs)


# community 2 - intermediate variation in z1. 
species_pars$z1_range <- 25
species_pars$z2_range <- 25
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs)


# community 3 - large variation in z1. 
species_pars$z1_range <- 50
species_pars$z2_range <- 1.5
# b1_range <- 0.02
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs)

```



### Response diversity calculation 

```{r RDplot15z2, fig.cap='Directional derivatives and response diversity for the three different communities. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# community 1  - calculation RD

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sing<-median(rdiv_1$sign)

# community 2  - calculation RD
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sing<-median(rdiv_2$sign)

# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sing<-median(rdiv_3$sign)

plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```



```{r}
dd4 <- data.frame(rdiv_1[, c(8:9)]) 
dd4$cor <- "positive"
dd4$z1 <- "low"

dd5 <- data.frame(rdiv_2[, c(8:9)]) 
dd5$cor <- "positive"
dd5$z1 <- "medium"

dd6 <- data.frame(rdiv_3[, c(8:9)]) 
dd6$cor <- "positive"
dd6$z1 <- "high"
```


```{r}
dd4z2 <- data.frame(rdiv_1[, c(8:9)]) 
dd4z2$cor <- "positive"
dd4z2$z2 <- "high"

dd5z2 <- data.frame(rdiv_2[, c(8:9)]) 
dd5z2$cor <- "positive"
dd5z2$z2 <- "medium"

dd6z2 <- data.frame(rdiv_3[, c(8:9)]) 
dd6z2$cor <- "positive"
dd6z2$z2 <- "low"
```
## Low fluctuation in environmental change - positive correlation 
Increasing variance in z1 and decreasing in 2 - positive correlation between env variables (E1 and E2) with *low* fluctuations.

We repeat the same steps as in the previous section, but this time E1 and E2 have a very small variance.

```{r plot23env, fig.cap='Environmental variables with *low* variation and positive correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(mean(E1_series),  mean(E2_series))                                   
sample_covariance_matrix <- matrix(c(1, 1,
                                     1, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(5655)
refs <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "V1", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))


# plot env change over time
p_E1 <- refs %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  labs(tag = "(a)")

p_E2 <- refs %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
  labs(tag = "(b)")

# Plot environmental change over time
p_E1 + p_E2
detach("package:MASS", unload=TRUE)
```


```{r}

# create communities
s <- 4
# community 1 - low variation in z1 high in z2. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)
# Visualise spp performances 
performance_comm1 <- multi_performance_plot(comm)


# Get directional dreivatives
dir_1 <- get_directionals(comm, new_data, refs)


# community 2 - intermediate variation in z1. 
species_pars$z1_range <- 25
species_pars$z2_range <- 25
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs)


# community 3 - large variation in z1. 
species_pars$z1_range <- 50
species_pars$z2_range <- 1.5
# b1_range <- 0.02
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs)

```



### Response diversity calculation 

```{r RDplot16z2, fig.cap=' Directional derivatives and response diversity for the three different communities. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# community 1  - calculation RD

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sing<-median(rdiv_1$sign)

# community 2  - calculation RD
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sing<-median(rdiv_2$sign)

# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sing<-median(rdiv_3$sign)

plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```


```{r}
new_rdiv <- rdiv_1[, c(8)]
new_sign <- rdiv_1[, c(9)]

dd4 <- dd4 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd4$cor <- "positive"
dd4$z1 <- "low"


new_rdiv <- rdiv_2[, c(8)]
new_sign <- rdiv_2[, c(9)]

dd5 <- dd5 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd5$cor <- "positive"
dd5$z1 <- "medium"


new_rdiv <- rdiv_3[, c(8)]
new_sign <- rdiv_3[, c(9)]

dd6 <- dd6 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd6$cor <- "positive"
dd6$z1 <- "high"
```


```{r}
new_rdiv <- rdiv_1[, c(8)]
new_sign <- rdiv_1[, c(9)]

dd4z2 <- dd4z2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd4z2$cor <- "positive"
dd4z2$z2 <- "high"


new_rdiv <- rdiv_2[, c(8)]
new_sign <- rdiv_2[, c(9)]

dd5z2 <- dd5z2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd5z2$cor <- "positive"
dd5z2$z2 <- "medium"


new_rdiv <- rdiv_3[, c(8)]
new_sign <- rdiv_3[, c(9)]

dd6z2 <- dd6z2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd6z2$cor <- "positive"
dd6z2$z2 <- "low"
```
## High fluctuation in environmental change - no correlation
Increasing variance in z1 and decreasing in z2 - no correlation between env variables (E1 and E2) with *high* fluctuations

Same steps as before (3 communities with increasing diversity in z1 and z2), but there is no correlation between E1 and E1

```{r plot24env, fig.cap='Environmental variables with high variation and no correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(mean(E1_series),  mean(E2_series))                                   
sample_covariance_matrix <- matrix(c(150, 0.0,
                                     0.0, 90),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(5655)
refs <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "V1", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

# plot env change over time
p_E1 <- refs %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  labs(tag = "(a)")

p_E2 <- refs %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
  labs(tag = "(b)")

# Plot environmental change over time
p_E1 + p_E2
detach("package:MASS", unload=TRUE)
```


```{r}
# create communities
s <- 4
# community 1 - low variation in z1 high in z2. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)
# Visualise spp performances 
performance_comm1 <- multi_performance_plot(comm)


# Get directional dreivatives
dir_1 <- get_directionals(comm, new_data, refs)


# community 2 - intermediate variation in z1. 
species_pars$z1_range <- 25
species_pars$z2_range <- 25
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs)


# community 3 - large variation in z1. 
species_pars$z1_range <- 50
species_pars$z2_range <- 1.5
# b1_range <- 0.02
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_3 <- get_directionals(comm, new_data, refs)

```

### Response diversity calculation 
 
```{r RDplot17z2, fig.cap='Directional derivatives and response diversity for the three different communities. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# community 1  - calculation RD

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sing<-median(rdiv_1$sign)

# community 2  - calculation RD
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sing<-median(rdiv_2$sign)

# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sing<-median(rdiv_3$sign)

plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```


```{r}
dd7 <- data.frame(rdiv_1[, c(8:9)]) 
dd7$cor <- "no_cor"
dd7$z1 <- "low"

dd8 <- data.frame(rdiv_2[, c(8:9)]) 
dd8$cor <- "positive"
dd8$z1 <- "medium"

dd9 <- data.frame(rdiv_3[, c(8:9)]) 
dd9$cor <- "positive"
dd9$z1 <- "high"
```


```{r}
dd7z2 <- data.frame(rdiv_1[, c(8:9)]) 
dd7z2$cor <- "no_cor"
dd7z2$z2 <- "high"

dd8z2 <- data.frame(rdiv_2[, c(8:9)]) 
dd8z2$cor <- "positive"
dd8z2$z2 <- "medium"

dd9z2 <- data.frame(rdiv_3[, c(8:9)]) 
dd9z2$cor <- "positive"
dd9z2$z2 <- "low"
```
## Low fluctuation in environmental change - no correlation
Increasing variance in z1 and decreasing in z2 - no correlation between env variables (E1 and E2) with *low* fluctuations

We repeat the same steps as in the previous section, but this time E1 and E2 have a very small variance.

```{r plot24envz2, fig.cap='Environmental variables with *low* variation and negative correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(mean(E1_series),  mean(E2_series))                                   
sample_covariance_matrix <- matrix(c(1, 0.0,
                                     0.0, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(5655)
refs <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "V1", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

# plot env change over time
p_E1 <- refs %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  labs(tag = "(a)")

p_E2 <- refs %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
  labs(tag = "(b)")

# Plot environmental change over time
p_E1 + p_E2
detach("package:MASS", unload=TRUE)
```


```{r}
# create communities
s <- 4
# community 1 - low variation in z1 high in z2. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)
# Visualise spp performances 
performance_comm1 <- multi_performance_plot(comm)


# Get directional dreivatives
dir_1 <- get_directionals(comm, new_data, refs)


# community 2 - intermediate variation in z1. 
species_pars$z1_range <- 25
species_pars$z2_range <- 25
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs)


# community 3 - large variation in z1. 
species_pars$z1_range <- 50
species_pars$z2_range <- 1.5
# b1_range <- 0.02
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs)

```




### Response diversity calculation 

```{r RDplot18z2, fig.cap='Directional derivatives and response diversity for the three different communities. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# community 1  - calculation RD

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sing<-median(rdiv_1$sign)

# community 2  - calculation RD
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sing<-median(rdiv_2$sign)

# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sing<-median(rdiv_3$sign)

plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)

```


```{r}
new_rdiv <- rdiv_1[, c(8)]
new_sign <- rdiv_1[, c(9)]

dd7 <- dd7 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd7$cor <- "no_cor"
dd7$z1 <- "low"


new_rdiv <- rdiv_2[, c(8)]
new_sign <- rdiv_2[, c(9)]

dd8 <- dd8 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd8$cor <- "no_cor"
dd8$z1 <- "medium"


new_rdiv <- rdiv_3[, c(8)]
new_sign <- rdiv_3[, c(9)]

dd9 <- dd9 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd9$cor <- "no_cor"
dd9$z1 <- "high"
```

```{r}
new_rdiv <- rdiv_1[, c(8)]
new_sign <- rdiv_1[, c(9)]

dd7z2 <- dd7z2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd7z2$cor <- "no_cor"
dd7z2$z2 <- "high"


new_rdiv <- rdiv_2[, c(8)]
new_sign <- rdiv_2[, c(9)]

dd8z2 <- dd8z2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd8z2$cor <- "no_cor"
dd8z2$z2 <- "medium"


new_rdiv <- rdiv_3[, c(8)]
new_sign <- rdiv_3[, c(9)]

dd9z2 <- dd9z2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd9z2$cor <- "no_cor"
dd9z2$z2 <- "low"
```

## Summary plot - Effects of z1 and z2 diversity and correlation between environmental variables on response diversity 

```{r SummaryPlot3z2,fig.align="center", fig.height=8, fig.width=10, fig.cap="Influence of the correlation between environmental variables and diversity in z1 and z2 on response diversity. In this scenario, diversity in z1 increases with negative correlation with respect to diversity in z2. (a) Effects of the correlation between environmental variables and z1 diversity on response diversity measured as dissimilarity (sign insensitive measure). (b) Effects of the correlation between environmental variables and z1 diversity on response diversity measured as divergence (sign sensitive measure)."}
dd_plot1 <- rbind(dd1[,c(1,3:4)], dd2[,c(1,3:4)], dd3[,c(1,3:4)],
                  dd4[,c(1,3:4)], dd5[,c(1,3:4)], dd6[,c(1,3:4)], 
                  dd7[,c(1,3:4)], dd8[,c(1,3:4)], dd9[,c(1,3:4)])

theme_set(theme_classic(base_size = 12))

g1.1 <-
  ggplot(dd_plot1, aes(x = cor, y = rdiv, color = z1)) +
   # scale_y_continuous(limits = c(0.99, 1.005), expand = c(0.02, 0.02)) +
    scale_color_uchicago() +
    labs(x = NULL, y = "Dissimilarity (derivatives)") +
    theme(
      legend.position = "none",
      axis.title = element_text(size = 16),
      panel.grid = element_blank()
    )


rdiv3 <- g1.1 +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  stat_summary(fun = mean, geom = "point", size = 5) + labs(tag = "(a)")

dd_plot2 <- rbind(dd1[,c(2,3:4)], dd2[,c(2,3:4)], dd3[,c(2,3:4)],
                  dd4[,c(2,3:4)], dd5[,c(2,3:4)], dd6[,c(2,3:4)], 
                  dd7[,c(2,3:4)], dd8[,c(2,3:4)], dd9[,c(2,3:4)])

g1.2 <-
  ggplot(dd_plot2, aes(x = cor, y = sign, color = z1)) +
    scale_color_uchicago() +
    labs(x = NULL, y = "Divergence (sign sensitive)") +
    theme(
      legend.position = "none",
      axis.title = element_text(size = 16),
      panel.grid = element_blank()
    )

sign3 <- g1.2 +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  stat_summary(fun = mean, geom = "point", size = 5)+ labs(tag = "(b)") +
  ylim(0, 1)

combined <- rdiv3 + sign3 & theme(legend.position = "bottom")
combined + plot_layout(guides = "collect")
```



```{r SummaryPlotz2reduced,fig.align="center", fig.height=8, fig.width=10, fig.cap="Focusing on z2. (a) Effects of the correlation between environmental variables and z1 diversity on response diversity measured as dissimilarity (sign insensitive measure). (b) Effects of the correlation between environmental variables and z1 diversity on response diversity measured as divergence (sign sensitive measure)."}
dd_plot1 <- rbind(dd1z2[,c(1,3:4)], dd2z2[,c(1,3:4)], dd3z2[,c(1,3:4)],
                  dd4z2[,c(1,3:4)], dd5z2[,c(1,3:4)], dd6z2[,c(1,3:4)], 
                  dd7z2[,c(1,3:4)], dd8z2[,c(1,3:4)], dd9z2[,c(1,3:4)])

theme_set(theme_classic(base_size = 12))

g1.1 <-
  ggplot(dd_plot1, aes(x = cor, y = rdiv, color = z2)) +
   # scale_y_continuous(limits = c(0.99, 1.005), expand = c(0.02, 0.02)) +
    scale_color_uchicago() +
    labs(x = NULL, y = "Dissimilarity (derivatives)") +
    theme(
      legend.position = "none",
      axis.title = element_text(size = 16),
      panel.grid = element_blank()
    )


rdiv3z2 <- g1.1 +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  stat_summary(fun = mean, geom = "point", size = 5) + labs(tag = "(a)")

dd_plot2 <- rbind(dd1z2[,c(2,3:4)], dd2z2[,c(2,3:4)], dd3z2[,c(2,3:4)],
                  dd4z2[,c(2,3:4)], dd5z2[,c(2,3:4)], dd6z2[,c(2,3:4)], 
                  dd7z2[,c(2,3:4)], dd8z2[,c(2,3:4)], dd9z2[,c(2,3:4)])

g1.2 <-
  ggplot(dd_plot2, aes(x = cor, y = sign, color = z2)) +
    scale_color_uchicago() +
    labs(x = NULL, y = "Divergence (sign sensitive)") +
    theme(
      legend.position = "none",
      axis.title = element_text(size = 16),
      panel.grid = element_blank()
    )

sign3z2 <- g1.2 +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  stat_summary(fun = mean, geom = "point", size = 5)+ labs(tag = "(b)") +
  ylim(0, 1)

combined <- rdiv3z2 + sign3z2 & theme(legend.position = "bottom")
combined + plot_layout(guides = "collect")
```
