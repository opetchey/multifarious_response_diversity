---
title: "Variation in z"
author: "Francesco Polazzo"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    fig_caption: yes
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    code_folding: hide
---

```{r include = FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      include = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE)
```

```{r results='hide'}
rm(list = ls())
library(plotly)
library(tidyverse)
library(here)
library(patchwork)
library(DT)
library(mgcv)
library(gratia)
library(rlang)
library(vctrs)
library(scales)
library(broom)
library(reshape2)
library(ggtext)
library(ggsci)
source.files <- list.files(here("r"), full.names = TRUE)
sapply(source.files, source, .GlobalEnv)
```

# Intention

In this document, we are going to explore how diversity in species responses to one or both environmental variables, and different scenarios of correlation between them, may influence multifarious response diversity. Additionally, we are going to look at how different correlation between the environmental variables influence the calculated response diversity.

Within the project "response diversity in the context of multifarious environmental change", we have been simulating species response curves using the Eppley performance curve.

With one environmental variable, the performance (i.e., rate) is given by:

-   $rate(E) = ae^{bE}(1 - (\frac{E - z}{w/2})^2)$
-   $E$ is the values of the environmental factor.
-   $z$ controls location of maximum.
-   $w$ controls range of $E$ over which the rate is positive.
-   $a$ scaling constant.
-   $b$ controls rate of increase towards the maximum rate, as $E$ increases.

Adding a second environmental variable gives:

$rate(E_1, E_2) = a_1e^{b_1E_1}(1 - (\frac{E_1 - z_1}{w_1/2})^2) + a_2e^{b_2E_2}(1 - (\frac{E_2 - z_2}{w_2/2})^2)$

We now want to assess the role of diversity in response to one (or both) environmental variable(s), and investigate how different covariances in diversity of responses to E1 and E2 influence response diversity.

To do that, we are going to manipulate amount of diversity in responses to one or both env variables among the species, and also the correlation in the tolerances (position of optima, determine by the terms z1 and z2 in the above formula). We will make scenarios of communities with diversity in response to only E1, or both E1 and E2, with diversity in both that is positively correlated (co-tolerance) or negatively (anti-tolerance).

\# Variation in diversity in z1

## High fluctuation in environmental change - negative correlation Increasing variance in z1 - negative correlation between env variables (E1 and E2) with *high* fluctuations.

We now create 3 communities. Community 1 is characterized by low diversity in z1, community 2 has medium diversity in z1, and community 3 has high diversity in z1. z2 is constant in the 3 communities and fixed to a medium level of diversity.

E1 and E2 have *high* fluctuations and *negative* correlation. We create 3 scenarios where we keep the variation of E1 and E2 fixed, but we change the mean so that in the first scenario E1 and E2 have low mean value, in the second medium, and high in the third.

```{r}
## define the series of values of the environmental variables
E1_series <- 273.15 + seq(0, 50, 1)
E2_series <- seq(0, 50, 1)

## define new_data for following GAM fitting

new_data <- tibble(E1 = 273.15 + seq(0, 50, 0.2),
                   E2 = seq(0, 50, 0.2))
```

```{r plot1env, fig.cap='Environmental variables with high variation and negative correlation. Different scenarios of E1 and E2 changing over time (a) low mean value of E1. (b) low mean value of E2. (c) medium mean value of E1. (d) medium mean value of E2. (e) high mean value of E1. (f) high mean value of E2', fig.align="center", fig.height=6, fig.width=12}
# Specify the correlation E1 and E2 
#negative in this example and high variation in E1 and E2 
E1max<-350; E1min<-250
E2max<- 80; E2min<- -20

# Scenario 1 - low mean vakues of E1 and E2
theme_set(theme_classic(base_size = 12))
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(150, -150,
                                     -150, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p_E1 <- refs1 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  geom_hline(yintercept = mean(refs1$E1),lty=2)+ 
  labs(tag = "(a)") +
  lims(y = c(E1min, E1max))

p_E2 <- refs1 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs1$E2),lty=2)+ 
  labs(tag = "(b)") +
     lims(y = c(E2min, E2max))





### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(150, -150,
                                     -150, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p2_E1 <- refs2 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E1),lty=2)+ 
  labs(tag = "(c)") +
   lims(y = c(E1min, E1max))

p2_E2 <- refs2 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E2),lty=2)+ 
  labs(tag = "(d)") +
      lims(y = c(E2min, E2max))



### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(150, -150,
                                     -150, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p3_E1 <- refs3 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E1),lty=2)+ 
  labs(tag = "(e)") +
    lims(y = c(E1min, E1max))

p3_E2 <- refs3 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E2),lty=2)+ 
  labs(tag = "(f)") +
   lims(y = c(E2min, E2max))


(p_E1 + p_E2)/(p2_E1 + p2_E2)/(p3_E1 + p3_E2)



detach("package:MASS", unload=TRUE)

```

### Community 1 - low diversity in z1.

```{r}
## Set species parameters
species_pars <- list(a1_mean = 1e-9,
  b1_mean = 0.063,
  z1_mean = 285,
  w1_mean = 60,
  a2_mean = 1e-3,
  b2_mean = 0.02,
  z2_mean = 20,
  w2_mean = 10,
  zint_mean = 0,
  sd_rate_mean = 0,
  z1_range = NA,
  z2_range = NA)

```

```{r plotcomm1_neg, fig.cap='Community 1, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=20, fig.width=12}
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm1 <- multi_performance_plot(comm)
performance_comm1

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)
```

```{r}
# Find optimum for E1 and E1 for each sp 
optima_com1 <- get_optima(comm, new_data)
optima_com1$community <- 1
```

### Community 2 - medium diversity in z1.

```{r plotcomm2_neg, fig.cap='Community 2, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=20, fig.width=12}
species_pars$z1_range <- 25
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm2 <- multi_performance_plot(comm)
performance_comm2
# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)

```

```{r}
# Find optimum for E1 and E1 for each sp 
optima_com2 <- get_optima(comm, new_data)
optima_com2$community <- 2
```

### Community 3 - high diversity in z1.

```{r plotcomm3_neg, fig.cap=' Community 3, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=20, fig.width=12}
species_pars$z1_range <- 50
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm3 <- multi_performance_plot(comm)
performance_comm3
# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)
```

```{r}
# Find optimum for E1 and E1 for each sp 
optima_com3 <- get_optima(comm, new_data)
optima_com3$community <- 3
```

### Position of the optimum

Here and elsewhere in this document, the position of the optima has been estimated as the environmental location (E1 and E2 values) for which the rate is maximum.

```{r plotoptimum3, fig.cap='Position of the optimum for E1 and E2 in the 3 different communities', fig.align="center", fig.height=6, fig.width=8}
optima <- rbind(optima_com1, optima_com2, optima_com3)
optima %>%  ggplot(aes(x = E1, y = E2, col = as.factor(community))) +
  geom_point() +
  labs(x = "Optimum E1", y = "Optimum E2")
```

### Response diversity calculation - first scenario (low mean values of E1 and E2)

```{r RDplot1, fig.cap='Directional derivatives and response diversity for the three different communities. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```

Low mean values of E1 and E2 scenario

```{r RDplot1.1, fig.cap='Directional derivatives and response diversity for the three different communities - Low mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```

Intermediate mean values of E1 and E2 scenario

```{r RDplot1.2, fig.cap='Directional derivatives and response diversity for the three different communities - Intermediate mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.2, dir_2.2, dir_3.2, rdiv_1.2, rdiv_2.2, rdiv_3.2)
```

High mean values of E1 and E2 scenario

```{r RDplot1.3, fig.cap='Directional derivatives and response diversity for the three different communities - high mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.3, dir_2.3, dir_3.3, rdiv_1.3, rdiv_2.3, rdiv_3.3)
```

```{r}
dd1 <- data.frame(rdiv_1[, c("rdiv", "sign")]) 
dd1$cor <- "negative"
dd1$z1 <- "low"
dd1$E1_mean <- "low"

dd1.2 <- data.frame(rdiv_1.2[, c("rdiv", "sign")]) 
dd1.2$cor <- "negative"
dd1.2$z1 <- "low"
dd1.2$E1_mean <- "medium"

dd1.3 <- data.frame(rdiv_1.3[, c("rdiv", "sign")]) 
dd1.3$cor <- "negative"
dd1.3$z1 <- "low"
dd1.3$E1_mean <- "high"


dd2 <- data.frame(rdiv_2[, c("rdiv", "sign")]) 
dd2$cor <- "negative"
dd2$z1 <- "medium"
dd2$E1_mean <- "low"

dd2.2 <- data.frame(rdiv_2.2[, c("rdiv", "sign")]) 
dd2.2$cor <- "negative"
dd2.2$z1 <- "medium"
dd2.2$E1_mean <- "medium"

dd2.3 <- data.frame(rdiv_2.3[, c("rdiv", "sign")]) 
dd2.3$cor <- "negative"
dd2.3$z1 <- "medium"
dd2.3$E1_mean <- "high"

dd3 <- data.frame(rdiv_3[, c("rdiv", "sign")]) 
dd3$cor <- "negative"
dd3$z1 <- "high"
dd3$E1_mean <-"low"


dd3.2 <- data.frame(rdiv_3.2[, c("rdiv", "sign")]) 
dd3.2$cor <- "negative"
dd3.2$z1 <- "high"
dd3.2$E1_mean <- "medium"

dd3.3 <- data.frame(rdiv_3.3[, c("rdiv", "sign")]) 
dd3.3$cor <- "negative"
dd3.3$z1 <- "high"
dd3.3$E1_mean <- "high"
```

## Low fluctuation in environmental change - negative correlation

Increasing variance in z1 - negative correlation between env variables (E1 and E2) with *low* fluctuations

We repeat the same steps as in the previous section, but this time E1 and E2 have a very small variance.

```{r plot2env, fig.cap='Environmental variables with high variation and negative correlation. Different scenarios of E1 and E2 changing over time (a) low mean value of E1. (b) low mean value of E2. (c) medium mean value of E1. (d) medium mean value of E2. (e) high mean value of E1. (f) high mean value of E2', fig.align="center", fig.height=6, fig.width=12}
# Specify the correlation E1 and E2 
#negative in this example and high variation in E1 and E2 
E1max<-320; E1min<-275
E2max<-35; E2min<- -5

# Scenario 1 - low mean vakues of E1 and E2
theme_set(theme_classic(base_size = 12))
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(1, -1,
                                     -1, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p_E1 <- refs1 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  geom_hline(yintercept = mean(refs1$E1),lty=2)+ 
  labs(tag = "(a)") +
  lims(y = c(E1min, E1max))

p_E2 <- refs1 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs1$E2),lty=2)+ 
  labs(tag = "(b)") +
     lims(y = c(E2min, E2max))





### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(1, -1,
                                     -1, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p2_E1 <- refs2 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E1),lty=2)+ 
  labs(tag = "(c)") +
   lims(y = c(E1min, E1max))

p2_E2 <- refs2 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E2),lty=2)+ 
  labs(tag = "(d)") +
      lims(y = c(E2min, E2max))



### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(1, -1,
                                     -1, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p3_E1 <- refs3 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E1),lty=2)+ 
  labs(tag = "(e)") +
    lims(y = c(E1min, E1max))

p3_E2 <- refs3 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E2),lty=2)+ 
  labs(tag = "(f)") +
   lims(y = c(E2min, E2max))


(p_E1 + p_E2)/(p2_E1 + p2_E2)/(p3_E1 + p3_E2)



detach("package:MASS", unload=TRUE)

```

```{r }
### Community 1 - low diversity in z1.
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)


species_pars$z1_range <- 25
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)


### Community 3 - high diversity in z1. 

species_pars$z1_range <- 50
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)

```

### Response diversity calculation

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```

Low mean values of E1 and E2 scenario

```{r RDplot2, fig.cap='Directional derivatives and response diversity for the three different communities - Low mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```

Intermediate mean values of E1 and E2 scenario

```{r RDplot2.2, fig.cap='Directional derivatives and response diversity for the three different communities - Intermediate mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.2, dir_2.2, dir_3.2, rdiv_1.2, rdiv_2.2, rdiv_3.2)
```

High mean values of E1 and E2 scenario

```{r RDplot2.3, fig.cap='Directional derivatives and response diversity for the three different communities - high mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.3, dir_2.3, dir_3.3, rdiv_1.3, rdiv_2.3, rdiv_3.3)
```

```{r}
new_rdiv <- rdiv_1[, c("rdiv")]
new_sign <- rdiv_1[, c("sign")]

dd1 <- dd1 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd1$cor <- "negative"
dd1$z1 <- "low"
dd1$E1_mean <- "low"

new_rdiv <- rdiv_1.2[, c("rdiv")]
new_sign <- rdiv_1.2[, c("sign")]

dd1.2 <- dd1.2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd1.2$cor <- "negative"
dd1.2$z1 <- "low"
dd1.2$E1_mean <- "medium"

new_rdiv <- rdiv_1.3[, c("rdiv")]
new_sign <- rdiv_1.3[, c("sign")]

dd1.3 <- dd1.3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd1.3$cor <- "negative"
dd1.3$z1 <- "low"
dd1.3$E1_mean <- "high"


new_rdiv <- rdiv_2[, c("rdiv")]
new_sign <- rdiv_2[, c("sign")]

dd2 <- dd2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd2$cor <- "negative"
dd2$z1 <- "medium"
dd2$E1_mean <- "low"

new_rdiv <- rdiv_2.2[, c("rdiv")]
new_sign <- rdiv_2.2[, c("sign")]

dd2.2 <- dd2.2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd2.2$cor <- "negative"
dd2.2$z1 <- "medium"
dd2.2$E1_mean <- "medium"

new_rdiv <- rdiv_2.3[, c("rdiv")]
new_sign <- rdiv_2.3[, c("sign")]

dd2.3 <- dd2.3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd2.3$cor <- "negative"
dd2.3$z1 <- "medium"
dd2.3$E1_mean <- "high"


new_rdiv <- rdiv_3[, c("rdiv")]
new_sign <- rdiv_3[, c("sign")]

dd3 <- dd3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign), conflict = "ignore")
dd3$cor <- "negative"
dd3$z1 <- "high"
dd3$E1_mean <- "low"

new_rdiv <- rdiv_3.2[, c("rdiv")]
new_sign <- rdiv_3.2[, c("sign")]

dd3.2 <- dd3.2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd3.2$cor <- "negative"
dd3.2$z1 <- "high"
dd3.2$E1_mean <- "medium"

new_rdiv <- rdiv_3.3[, c("rdiv")]
new_sign <- rdiv_3.3[, c("sign")]

dd3.3 <- dd3.3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd3.3$cor <- "negative"
dd3.3$z1 <- "high"
dd3.3$E1_mean <- "high"
```

## High fluctuation in environmental change - positive correlation

Increasing variance in z1 - positive correlation between env variables (E1 and E2) with *high* fluctuations

Same steps as before (3 communities with increasing diversity ib z1 while z2 is fixed), but the correlation between E1 and E1 is negative.

```{r plot3env, fig.cap='Environmental variables with high variation and positive correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
E1max<-350; E1min<-250
E2max<-75; E2min<- -20
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(150, 150,
                                     150, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p_E1 <- refs1 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  geom_hline(yintercept = mean(refs1$E1),lty=2)+ 
  labs(tag = "(a)") +
  lims(y = c(E1min, E1max))

p_E2 <- refs1 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs1$E2),lty=2)+ 
  labs(tag = "(b)") +
     lims(y = c(E2min, E2max))





### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(150, 150,
                                     150, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p2_E1 <- refs2 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E1),lty=2)+ 
  labs(tag = "(c)") +
   lims(y = c(E1min, E1max))

p2_E2 <- refs2 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E2),lty=2)+ 
  labs(tag = "(d)") +
      lims(y = c(E2min, E2max))



### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(150, 150,
                                     150, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p3_E1 <- refs3 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E1),lty=2)+ 
  labs(tag = "(e)") +
    lims(y = c(E1min, E1max))

p3_E2 <- refs3 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E2),lty=2)+ 
  labs(tag = "(f)") +
   lims(y = c(E2min, E2max))


(p_E1 + p_E2)/(p2_E1 + p2_E2)/(p3_E1 + p3_E2)



detach("package:MASS", unload=TRUE)

```

```{r}
# create reproducible community
set.seed(2456)
### Community 1 - low diversity in z1.
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)


species_pars$z1_range <- 25
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)

### Community 3 - high diversity in z1. 

species_pars$z1_range <- 50
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)

```

### Response diversity calculation

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```

Low mean values of E1 and E2 scenario

```{r RDplot3, fig.cap='Directional derivatives and response diversity for the three different communities - Low mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```

Intermediate mean values of E1 and E2 scenario

```{r RDplot3.2_a, fig.cap='Directional derivatives and response diversity for the three different communities - Intermediate mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.2, dir_2.2, dir_3.2, rdiv_1.2, rdiv_2.2, rdiv_3.2)
```

High mean values of E1 and E2 scenario

```{r RDplot3.3_c, fig.cap='Directional derivatives and response diversity for the three different communities - high mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.3, dir_2.3, dir_3.3, rdiv_1.3, rdiv_2.3, rdiv_3.3)
```

```{r}
dd4 <- data.frame(rdiv_1[, c("rdiv", "sign")]) 
dd4$cor <- "positive"
dd4$z1 <- "low"
dd4$E1_mean <- "low"

dd4.2 <- data.frame(rdiv_1.2[, c("rdiv", "sign")]) 
dd4.2$cor <- "positive"
dd4.2$z1 <- "low"
dd4.2$E1_mean <- "medium"

dd4.3 <- data.frame(rdiv_1.3[, c("rdiv", "sign")]) 
dd4.3$cor <- "positive"
dd4.3$z1 <- "low"
dd4.3$E1_mean <- "high"


dd5 <- data.frame(rdiv_2[, c("rdiv", "sign")]) 
dd5$cor <- "positive"
dd5$z1 <- "medium"
dd5$E1_mean <- "low"

dd5.2 <- data.frame(rdiv_2.2[, c("rdiv", "sign")]) 
dd5.2$cor <- "positive"
dd5.2$z1 <- "medium"
dd5.2$E1_mean <- "medium"

dd5.3 <- data.frame(rdiv_2.3[, c("rdiv", "sign")]) 
dd5.3$cor <- "positive"
dd5.3$z1 <- "medium"
dd5.3$E1_mean <- "high"

dd6 <- data.frame(rdiv_3[, c("rdiv", "sign")]) 
dd6$cor <- "positive"
dd6$z1 <- "high"
dd6$E1_mean <-"low"


dd6.2 <- data.frame(rdiv_3.2[, c("rdiv", "sign")]) 
dd6.2$cor <- "positive"
dd6.2$z1 <- "high"
dd6.2$E1_mean <- "medium"

dd6.3 <- data.frame(rdiv_3.3[, c("rdiv", "sign")]) 
dd6.3$cor <- "positive"
dd6.3$z1 <- "high"
dd6.3$E1_mean <- "high"
```

## Low fluctuation in environmental change - positive correlation

Increasing variance in z1 - positive correlation between env variables (E1 and E2) with *low* fluctuations

We repeat the same steps as in the previous section, but this time E1 and E2 have a very small variance.

```{r plot4env, fig.cap='Environmental variables with *low* variation and negative correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
E1max<-320; E1min<-275
E2max<-50; E2min<- -5

# Scenario 1 - low mean vakues of E1 and E2
theme_set(theme_classic(base_size = 12))
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(1, 1,
                                     1, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p_E1 <- refs1 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  geom_hline(yintercept = mean(refs1$E1),lty=2)+ 
  labs(tag = "(a)") +
  lims(y = c(E1min, E1max))

p_E2 <- refs1 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs1$E2),lty=2)+ 
  labs(tag = "(b)") +
     lims(y = c(E2min, E2max))





### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(1, 1,
                                     1, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p2_E1 <- refs2 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E1),lty=2)+ 
  labs(tag = "(c)") +
   lims(y = c(E1min, E1max))

p2_E2 <- refs2 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E2),lty=2)+ 
  labs(tag = "(d)") +
      lims(y = c(E2min, E2max))



### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(1, 1,
                                     1, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p3_E1 <- refs3 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E1),lty=2)+ 
  labs(tag = "(e)") +
    lims(y = c(E1min, E1max))

p3_E2 <- refs3 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E2),lty=2)+ 
  labs(tag = "(f)") +
   lims(y = c(E2min, E2max))


(p_E1 + p_E2)/(p2_E1 + p2_E2)/(p3_E1 + p3_E2)



detach("package:MASS", unload=TRUE)
```

```{r }
### Community 1 - low diversity in z1.
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)


species_pars$z1_range <- 25
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)


### Community 3 - high diversity in z1. 

species_pars$z1_range <- 50
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)

```

### Response diversity calculation

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```

Low mean values of E1 and E2 scenario

```{r RDplot3.1, fig.cap='Directional derivatives and response diversity for the three different communities - Low mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```

Intermediate mean values of E1 and E2 scenario

```{r RDplot3.2.7, fig.cap='Directional derivatives and response diversity for the three different communities - Intermediate mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.2, dir_2.2, dir_3.2, rdiv_1.2, rdiv_2.2, rdiv_3.2)
```

High mean values of E1 and E2 scenario

```{r RDplot3.3.8, fig.cap='Directional derivatives and response diversity for the three different communities - high mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.3, dir_2.3, dir_3.3, rdiv_1.3, rdiv_2.3, rdiv_3.3)
```

```{r}
new_rdiv <- rdiv_1[, c("rdiv")]
new_sign <- rdiv_1[, c("sign")]

dd4 <- dd4 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd4$cor <- "negative"
dd4$z1 <- "low"
dd4$E1_mean <- "low"

new_rdiv <- rdiv_1.2[, c("rdiv")]
new_sign <- rdiv_1.2[, c("sign")]

dd4.2 <- dd4.2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd4.2$cor <- "negative"
dd4.2$z1 <- "low"
dd4.2$E1_mean <- "medium"

new_rdiv <- rdiv_1.3[, c("rdiv")]
new_sign <- rdiv_1.3[, c("sign")]

dd4.3 <- dd4.3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd4.3$cor <- "negative"
dd4.3$z1 <- "low"
dd4.3$E1_mean <- "high"


new_rdiv <- rdiv_2[, c("rdiv")]
new_sign <- rdiv_2[, c("sign")]

dd5 <- dd5 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd5$cor <- "negative"
dd5$z1 <- "medium"
dd5$E1_mean <- "low"

new_rdiv <- rdiv_2.2[, c("rdiv")]
new_sign <- rdiv_2.2[, c("sign")]

dd5.2 <- dd5.2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd5.2$cor <- "negative"
dd5.2$z1 <- "medium"
dd5.2$E1_mean <- "medium"

new_rdiv <- rdiv_2.3[, c("rdiv")]
new_sign <- rdiv_2.3[, c("sign")]

dd5.3 <- dd5.3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd5.3$cor <- "negative"
dd5.3$z1 <- "medium"
dd5.3$E1_mean <- "high"


new_rdiv <- rdiv_3[, c("rdiv")]
new_sign <- rdiv_3[, c("sign")]

dd6 <- dd6 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign), conflict = "ignore")
dd6$cor <- "negative"
dd6$z1 <- "high"
dd6$E1_mean <- "low"

new_rdiv <- rdiv_3.2[, c("rdiv")]
new_sign <- rdiv_3.2[, c("sign")]

rdiv_6.2 <- rdiv_3.2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign), conflict = "ignore")
rdiv_6.2$cor <- "negative"
rdiv_6.2$z1 <- "high"
rdiv_6.2$E1_mean <- "medium"

new_rdiv <- rdiv_3.3[, c("rdiv")]
new_sign <- rdiv_3.3[, c("sign")]

dd6.3 <- dd6.3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd6.3$cor <- "negative"
dd6.3$z1 <- "high"
dd6.3$E1_mean <- "high"
```

## High fluctuation in environmental change - no correlation

Increasing variance in z1 - no correlation between env variables (E1 and E2) with *high* fluctuations

Same steps as before (3 communities with increasing diversity in z1 while z2 is fixed), but there is no correlation between E1 and E1

```{r plot5env, fig.cap='Environmental variables with high variation and no correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
E1max<-350; E1min<-250
E2max<-75; E2min<- -20
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(150, 0.0,
                                     0.0, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p_E1 <- refs1 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  geom_hline(yintercept = mean(refs1$E1),lty=2)+ 
  labs(tag = "(a)") +
  lims(y = c(E1min, E1max))

p_E2 <- refs1 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs1$E2),lty=2)+ 
  labs(tag = "(b)") +
     lims(y = c(E2min, E2max))





### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(150, 0.0,
                                     0.0, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p2_E1 <- refs2 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E1),lty=2)+ 
  labs(tag = "(c)") +
   lims(y = c(E1min, E1max))

p2_E2 <- refs2 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E2),lty=2)+ 
  labs(tag = "(d)") +
      lims(y = c(E2min, E2max))



### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(150, 0.0,
                                     0.0, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p3_E1 <- refs3 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E1),lty=2)+ 
  labs(tag = "(e)") +
    lims(y = c(E1min, E1max))

p3_E2 <- refs3 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E2),lty=2)+ 
  labs(tag = "(f)") +
   lims(y = c(E2min, E2max))


(p_E1 + p_E2)/(p2_E1 + p2_E2)/(p3_E1 + p3_E2)



detach("package:MASS", unload=TRUE)

```

```{r}
# create reproducible community
set.seed(2456)
### Community 1 - low diversity in z1.
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)


species_pars$z1_range <- 25
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)

### Community 3 - high diversity in z1. 

species_pars$z1_range <- 50
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)

```

### Response diversity calculation

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```

Low mean values of E1 and E2 scenario

```{r RDplot3_aver, fig.cap='Directional derivatives and response diversity for the three different communities - Low mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```

Intermediate mean values of E1 and E2 scenario

```{r RDplot3.2.2_b, fig.cap='Directional derivatives and response diversity for the three different communities - Intermediate mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.2, dir_2.2, dir_3.2, rdiv_1.2, rdiv_2.2, rdiv_3.2)
```

High mean values of E1 and E2 scenario

```{r RDplot3.3_d, fig.cap='Directional derivatives and response diversity for the three different communities - high mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.3, dir_2.3, dir_3.3, rdiv_1.3, rdiv_2.3, rdiv_3.3)
```

```{r}
dd7 <- data.frame(rdiv_1[, c("rdiv", "sign")]) 
dd7$cor <- "no cor"
dd7$z1 <- "low"
dd7$E1_mean <- "low"

dd7.2 <- data.frame(rdiv_1.2[, c("rdiv", "sign")]) 
dd7.2$cor <- "no cor"
dd7.2$z1 <- "low"
dd7.2$E1_mean <- "medium"

dd7.3 <- data.frame(rdiv_1.3[, c("rdiv", "sign")]) 
dd7.3$cor <- "no cor"
dd7.3$z1 <- "low"
dd7.3$E1_mean <- "high"


dd8 <- data.frame(rdiv_2[, c("rdiv", "sign")]) 
dd8$cor <- "no cor"
dd8$z1 <- "medium"
dd8$E1_mean <- "low"

dd8.2 <- data.frame(rdiv_2.2[, c("rdiv", "sign")]) 
dd8.2$cor <- "no cor"
dd8.2$z1 <- "medium"
dd8.2$E1_mean <- "medium"

dd8.3 <- data.frame(rdiv_2.3[, c("rdiv", "sign")]) 
dd8.3$cor <- "no cor"
dd8.3$z1 <- "medium"
dd8.3$E1_mean <- "high"

dd9 <- data.frame(rdiv_3[, c("rdiv", "sign")]) 
dd9$cor <- "no cor"
dd9$z1 <- "high"
dd9$E1_mean <-"low"


dd9.2 <- data.frame(rdiv_3.2[, c("rdiv", "sign")]) 
dd9.2$cor <- "no cor"
dd9.2$z1 <- "high"
dd9.2$E1_mean <- "medium"

dd9.3 <- data.frame(rdiv_3.3[, c("rdiv", "sign")]) 
dd9.3$cor <- "no cor"
dd9.3$z1 <- "high"
dd9.3$E1_mean <- "high"
```

## Low fluctuation in environmental change - no correlation

Increasing variance in z1 - no correlation between env variables (E1 and E2) with *low* fluctuations

We repeat the same steps as in the previous section, but this time E1 and E2 have a very small variance.

```{r plot6env_b, fig.cap='Environmental variables with *low* variation and negative correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
E1max<-320; E1min<-275
E2max<-35; E2min<- 5

# Scenario 1 - low mean vakues of E1 and E2
theme_set(theme_classic(base_size = 12))
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(1, 0.0,
                                     0.0, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p_E1 <- refs1 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  geom_hline(yintercept = mean(refs1$E1),lty=2)+ 
  labs(tag = "(a)") +
  lims(y = c(E1min, E1max))

p_E2 <- refs1 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs1$E2),lty=2)+ 
  labs(tag = "(b)") +
     lims(y = c(E2min, E2max))





### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(1, 0.0,
                                     0.0, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p2_E1 <- refs2 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E1),lty=2)+ 
  labs(tag = "(c)") +
   lims(y = c(E1min, E1max))

p2_E2 <- refs2 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E2),lty=2)+ 
  labs(tag = "(d)") +
      lims(y = c(E2min, E2max))



### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(1, 0.0,
                                     0.0, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p3_E1 <- refs3 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E1),lty=2)+ 
  labs(tag = "(e)") +
    lims(y = c(E1min, E1max))

p3_E2 <- refs3 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E2),lty=2)+ 
  labs(tag = "(f)") +
   lims(y = c(E2min, E2max))


(p_E1 + p_E2)/(p2_E1 + p2_E2)/(p3_E1 + p3_E2)



detach("package:MASS", unload=TRUE)
```

```{r }
### Community 1 - low diversity in z1.
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)


species_pars$z1_range <- 25
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)


### Community 3 - high diversity in z1. 

species_pars$z1_range <- 50
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)

```

### Response diversity calculation

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```

Low mean values of E1 and E2 scenario

```{r RDplot3_b, fig.cap='Directional derivatives and response diversity for the three different communities - Low mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```

Intermediate mean values of E1 and E2 scenario

```{r RDplot3.2_b, fig.cap='Directional derivatives and response diversity for the three different communities - Intermediate mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.2, dir_2.2, dir_3.2, rdiv_1.2, rdiv_2.2, rdiv_3.2)
```

High mean values of E1 and E2 scenario

```{r RDplot3.3_se, fig.cap='Directional derivatives and response diversity for the three different communities - high mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.3, dir_2.3, dir_3.3, rdiv_1.3, rdiv_2.3, rdiv_3.3)
```

```{r}
new_rdiv <- rdiv_1[, c("rdiv")]
new_sign <- rdiv_1[, c("sign")]

dd7 <- dd7 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd7$cor <- "negative"
dd7$z1 <- "low"
dd7$E1_mean <- "low"

new_rdiv <- rdiv_1.2[, c("rdiv")]
new_sign <- rdiv_1.2[, c("sign")]

dd7.2 <- dd7.2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd7.2$cor <- "negative"
dd7.2$z1 <- "low"
dd7.2$E1_mean <- "medium"

new_rdiv <- rdiv_1.3[, c("rdiv")]
new_sign <- rdiv_1.3[, c("sign")]

dd7.3 <- dd7.3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd7.3$cor <- "negative"
dd7.3$z1 <- "low"
dd7.3$E1_mean <- "high"


new_rdiv <- rdiv_2[, c("rdiv")]
new_sign <- rdiv_2[, c("sign")]

dd8 <- dd8 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd8$cor <- "negative"
dd8$z1 <- "medium"
dd8$E1_mean <- "low"

new_rdiv <- rdiv_2.2[, c("rdiv")]
new_sign <- rdiv_2.2[, c("sign")]

dd8.2 <- dd8.2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd8.2$cor <- "negative"
dd8.2$z1 <- "medium"
dd8.2$E1_mean <- "medium"

new_rdiv <- rdiv_2.3[, c("rdiv")]
new_sign <- rdiv_2.3[, c("sign")]

dd8.3 <- dd8.3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd8.3$cor <- "negative"
dd8.3$z1 <- "medium"
dd8.3$E1_mean <- "high"


new_rdiv <- rdiv_3[, c("rdiv")]
new_sign <- rdiv_3[, c("sign")]

dd9 <- dd9 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign), conflict = "ignore")
dd9$cor <- "negative"
dd9$z1 <- "high"
dd9$E1_mean <- "low"

new_rdiv <- rdiv_3.2[, c("rdiv")]
new_sign <- rdiv_3.2[, c("sign")]

rdiv_9.2 <- rdiv_3.2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign), conflict = "ignore")
rdiv_9.2$cor <- "negative"
rdiv_9.2$z1 <- "high"
rdiv_9.2$E1_mean <- "medium"

new_rdiv <- rdiv_3.3[, c("rdiv")]
new_sign <- rdiv_3.3[, c("sign")]

dd9.3 <- dd9.3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign), conflict = "ignore")
dd9.3$cor <- "negative"
dd9.3$z1 <- "high"
dd9.3$E1_mean <- "high"
```

## Summary plot - Effects of z1 diversity and correlation between environmental variables on response diversity

```{r SummaryPlot1, fig.align="center", fig.height=8, fig.width=10, fig.cap="Influence of the correlation between environmental variables and z1 diversity on response diversity. (a) Effects of the correlation between environmental variables and z1 diversity on response diversity measured as dissimilarity (sign insensitive measure). (b) Effects of the correlation between environmental variables and z1 diversity on response diversity measured as divergence (sign sensitive measure)."}

dd_plot1 <- rbind(dd1[,c(1,3:5)], dd1.2[,c(1,3:5)],dd1.3[,c(1,3:5)],
                  dd2[,c(1,3:5)], dd2.2[,c(1,3:5)],dd2.3[,c(1,3:5)],
                  dd3[,c(1,3:5)], dd3.2[,c(1,3:5)],dd3.3[,c(1,3:5)],
                  dd4[,c(1,3:5)], dd4.2[,c(1,3:5)],dd4.3[,c(1,3:5)],
                  dd5[,c(1,3:5)], dd5.2[,c(1,3:5)],dd5.3[,c(1,3:5)], 
                  dd6[,c(1,3:5)], dd6.2[,c(1,3:5)],dd6.3[,c(1,3:5)],
                  dd7[,c(1,3:5)], dd7.2[,c(1,3:5)],dd7.3[,c(1,3:5)],
                  dd8[,c(1,3:5)], dd8.2[,c(1,3:5)],dd8.3[,c(1,3:5)],
                  dd9[,c(1,3:5)], dd9.2[,c(1,3:5)],dd9.3[,c(1,3:5)])
dd_plot1$z1 <- factor(dd_plot1$z1, levels = c("low", "medium", "high"))
theme_set(theme_classic(base_size = 12))

g1.1 <-
  ggplot(dd_plot1, aes(x = z1, y = rdiv, color = E1_mean)) +
   # scale_y_continuous(limits = c(0.99, 1.005), expand = c(0.02, 0.02)) +
    scale_color_uchicago() +
    labs(x = "z1 diversity", y = "Dissimilarity (derivatives)") +
    theme(
      legend.position = "none",
      axis.title = element_text(size = 16),
      panel.grid = element_blank()
    )


rdiv1 <- g1.1 +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  stat_summary(fun = mean, geom = "point", size = 5) + labs(tag = "(a)")

dd_plot2 <- rbind(dd1[,c(2,3:5)], dd1.2[,c(2,3:5)],dd1.3[,c(2,3:5)],
                  dd2[,c(2,3:5)], dd2.2[,c(2,3:5)],dd2.3[,c(2,3:5)],
                  dd3[,c(2,3:5)], dd3.2[,c(2,3:5)],dd3.3[,c(2,3:5)],
                  dd4[,c(2,3:5)], dd4.2[,c(2,3:5)],dd4.3[,c(2,3:5)],
                  dd5[,c(2,3:5)], dd5.2[,c(2,3:5)],dd5.3[,c(2,3:5)], 
                  dd6[,c(2,3:5)], dd6.2[,c(2,3:5)],dd6.3[,c(2,3:5)],
                  dd7[,c(2,3:5)], dd7.2[,c(2,3:5)],dd7.3[,c(2,3:5)],
                  dd8[,c(2,3:5)], dd8.2[,c(2,3:5)],dd8.3[,c(2,3:5)],
                  dd9[,c(2,3:5)], dd9.2[,c(2,3:5)],dd9.3[,c(2,3:5)])
dd_plot2$z1 <- factor(dd_plot2$z1, levels = c("low", "medium", "high"))
g1.2 <-
  ggplot(dd_plot2, aes(x = z1, y = sign, color = E1_mean)) +
    scale_color_uchicago() +
    labs(x = "z1 diveristy", y = "Divergence (sign sensitive)") +
    theme(
      legend.position = "none",
      axis.title = element_text(size = 16),
      panel.grid = element_blank()
    )

sign1 <- g1.2 +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  stat_summary(fun = mean, geom = "point", size = 5)+ labs(tag = "(b)") +
  ylim(0, 1)

combined <- rdiv1 + sign1 & theme(legend.position = "bottom")
combined + plot_layout(guides = "collect")

```

# Variation in diversity in z1 and z2

Now we do the same, but having also z2 changing together with z1 with positive correlation. So, diversity in z1 and z2 are increasing gradually from low to high in the 3 communities (increasing co-tolerance scenario?).

## High fluctuation in environmental change - negative correlation

Increasing variance in z1 and z2 - negative correlation between environmental variables (E1 and E2) with *high* fluctuations.

We now create 3 communities. Community 1 is characterized by low diversity in z1 and z2, community 2 has medium diversity in z1 and z2, and community 3 has high diversity in z1 and z2.

E1 and E2 have high fluctuations and *negative* correlation.

```{r plot7env, fig.cap='Environmental variables with high variation and negative correlation. Different scenarios of E1 and E2 changing over time (a) low mean value of E1. (b) low mean value of E2. (c) medium mean value of E1. (d) medium mean value of E2. (e) high mean value of E1. (f) high mean value of E2', fig.align="center", fig.height=6, fig.width=12}
# Specify the correlation E1 and E2 
#negative in this example and high variation in E1 and E2 
E1max<-350; E1min<-250
E2max<- 80; E2min<- -30

# Scenario 1 - low mean vakues of E1 and E2
theme_set(theme_classic(base_size = 12))
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(150, -150,
                                     -150, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p_E1 <- refs1 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  geom_hline(yintercept = mean(refs1$E1),lty=2)+ 
  labs(tag = "(a)") +
  lims(y = c(E1min, E1max))

p_E2 <- refs1 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs1$E2),lty=2)+ 
  labs(tag = "(b)") +
     lims(y = c(E2min, E2max))





### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(150, -150,
                                     -150, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p2_E1 <- refs2 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E1),lty=2)+ 
  labs(tag = "(c)") +
   lims(y = c(E1min, E1max))

p2_E2 <- refs2 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E2),lty=2)+ 
  labs(tag = "(d)") +
      lims(y = c(E2min, E2max))



### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(150, -150,
                                     -150, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p3_E1 <- refs3 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E1),lty=2)+ 
  labs(tag = "(e)") +
    lims(y = c(E1min, E1max))

p3_E2 <- refs3 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E2),lty=2)+ 
  labs(tag = "(f)") +
   lims(y = c(E2min, E2max))


(p_E1 + p_E2)/(p2_E1 + p2_E2)/(p3_E1 + p3_E2)



detach("package:MASS", unload=TRUE)

```

### Community 1 - low diversity in z1.

```{r}
## Set species parameters
species_pars <- list(a1_mean = 1e-9,
  b1_mean = 0.063,
  z1_mean = 285,
  w1_mean = 60,
  a2_mean = 1e-3,
  b2_mean = 0.02,
  z2_mean = 20,
  w2_mean = 10,
  zint_mean = 0,
  sd_rate_mean = 0,
  z1_range = NA,
  z2_range = NA)

```

```{r plotcomm1_pos, fig.cap='Community 1, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=20, fig.width=12}
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm1 <- multi_performance_plot(comm)
performance_comm1

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)
```

```{r}
# Find optimum for E1 and E1 for each sp 
optima_com1 <- get_optima(comm, new_data)
optima_com1$community <- 1
```

### Community 2 - medium diversity in z1.

```{r plotcomm2_pos, fig.cap='Community 2, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=20, fig.width=12}
species_pars$z1_range <- 25
species_pars$z2_range <- 25

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm2 <- multi_performance_plot(comm)
performance_comm2
# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)

```

```{r}
# Find optimum for E1 and E1 for each sp 
optima_com2 <- get_optima(comm, new_data)
optima_com2$community <- 2
```

### Community 3 - high diversity in z1.

```{r plotcomm3_pos, fig.cap=' Community 3, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=20, fig.width=12}
species_pars$z1_range <- 50
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm3 <- multi_performance_plot(comm)
performance_comm3
# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)
```

```{r}
# Find optimum for E1 and E1 for each sp 
optima_com3 <- get_optima(comm, new_data)
optima_com3$community <- 3
```

### Position of the optimum

Here and elsewhere in this document, the position of the optima has been estimated as the environmental location (E1 and E2 values) for which the rate is maximum.

```{r plotoptimum2, fig.cap='Position of the optimum for E1 and E2 in the 3 different communities', fig.align="center", fig.height=6, fig.width=8}
optima <- rbind(optima_com1, optima_com2, optima_com3)
optima %>%  ggplot(aes(x = E1, y = E2, col = as.factor(community))) +
  geom_point() +
  labs(x = "Optimum E1", y = "Optimum E2")
```

### Response diversity calculation - first scenario (low mean values of E1 and E2)

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```

Low mean values of E1 and E2 scenario

```{r RDplot2.1, fig.cap='Directional derivatives and response diversity for the three different communities - Low mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```

Intermediate mean values of E1 and E2 scenario

```{r RDplot2.1.2, fig.cap='Directional derivatives and response diversity for the three different communities - Intermediate mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.2, dir_2.2, dir_3.2, rdiv_1.2, rdiv_2.2, rdiv_3.2)
```

High mean values of E1 and E2 scenario

```{r RDplot2.1.3, fig.cap='Directional derivatives and response diversity for the three different communities - high mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.3, dir_2.3, dir_3.3, rdiv_1.3, rdiv_2.3, rdiv_3.3)
```

```{r}
dd1 <- data.frame(rdiv_1[, c("rdiv", "sign")]) 
dd1$cor <- "negative"
dd1$z1 <- "low"
dd1$E1_mean <- "low"

dd1.2 <- data.frame(rdiv_1.2[, c("rdiv", "sign")]) 
dd1.2$cor <- "negative"
dd1.2$z1 <- "low"
dd1.2$E1_mean <- "medium"

dd1.3 <- data.frame(rdiv_1.3[, c("rdiv", "sign")]) 
dd1.3$cor <- "negative"
dd1.3$z1 <- "low"
dd1.3$E1_mean <- "high"


dd2 <- data.frame(rdiv_2[, c("rdiv", "sign")]) 
dd2$cor <- "negative"
dd2$z1 <- "medium"
dd2$E1_mean <- "low"

dd2.2 <- data.frame(rdiv_2.2[, c("rdiv", "sign")]) 
dd2.2$cor <- "negative"
dd2.2$z1 <- "medium"
dd2.2$E1_mean <- "medium"

dd2.3 <- data.frame(rdiv_2.3[, c("rdiv", "sign")]) 
dd2.3$cor <- "negative"
dd2.3$z1 <- "medium"
dd2.3$E1_mean <- "high"

dd3 <- data.frame(rdiv_3[, c("rdiv", "sign")]) 
dd3$cor <- "negative"
dd3$z1 <- "high"
dd3$E1_mean <-"low"


dd3.2 <- data.frame(rdiv_3.2[, c("rdiv", "sign")]) 
dd3.2$cor <- "negative"
dd3.2$z1 <- "high"
dd3.2$E1_mean <- "medium"

dd3.3 <- data.frame(rdiv_3.3[, c("rdiv", "sign")]) 
dd3.3$cor <- "negative"
dd3.3$z1 <- "high"
dd3.3$E1_mean <- "high"
```

## Low fluctuation in environmental change - negative correlation

Increasing variance in z1 and z2 - negative correlation between env variables (E1 and E2) with *low* fluctuations

We repeat the same steps as in the previous section, but this time E1 and E2 have a very small variance.

```{r plot2.2env, fig.cap='Environmental variables with high variation and negative correlation. Different scenarios of E1 and E2 changing over time (a) low mean value of E1. (b) low mean value of E2. (c) medium mean value of E1. (d) medium mean value of E2. (e) high mean value of E1. (f) high mean value of E2', fig.align="center", fig.height=6, fig.width=12}
# Specify the correlation E1 and E2 
#negative in this example and high variation in E1 and E2 
E1max<-330; E1min<-275
E2max<-60; E2min<- -5

# Scenario 1 - low mean vakues of E1 and E2
theme_set(theme_classic(base_size = 12))
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(1, -1,
                                     -1, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p_E1 <- refs1 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  geom_hline(yintercept = mean(refs1$E1),lty=2)+ 
  labs(tag = "(a)") +
  lims(y = c(E1min, E1max))

p_E2 <- refs1 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs1$E2),lty=2)+ 
  labs(tag = "(b)") +
     lims(y = c(E2min, E2max))





### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(1, -1,
                                     -1, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p2_E1 <- refs2 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E1),lty=2)+ 
  labs(tag = "(c)") +
   lims(y = c(E1min, E1max))

p2_E2 <- refs2 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E2),lty=2)+ 
  labs(tag = "(d)") +
      lims(y = c(E2min, E2max))



### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(1, -1,
                                     -1, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p3_E1 <- refs3 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E1),lty=2)+ 
  labs(tag = "(e)") +
    lims(y = c(E1min, E1max))

p3_E2 <- refs3 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E2),lty=2)+ 
  labs(tag = "(f)") +
   lims(y = c(E2min, E2max))


(p_E1 + p_E2)/(p2_E1 + p2_E2)/(p3_E1 + p3_E2)



detach("package:MASS", unload=TRUE)

```

```{r }
### Community 1 - low diversity in z1.
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)


species_pars$z1_range <- 25
species_pars$z2_range <- 25

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)


### Community 3 - high diversity in z1. 

species_pars$z1_range <- 50
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)

```

### Response diversity calculation

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```

Low mean values of E1 and E2 scenario

```{r RDplot1.2.2, fig.cap='Directional derivatives and response diversity for the three different communities - Low mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```

Intermediate mean values of E1 and E2 scenario

```{r RDplot2.2.2, fig.cap='Directional derivatives and response diversity for the three different communities - Intermediate mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.2, dir_2.2, dir_3.2, rdiv_1.2, rdiv_2.2, rdiv_3.2)
```

High mean values of E1 and E2 scenario

```{r RDplot2.2.3, fig.cap='Directional derivatives and response diversity for the three different communities - high mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.3, dir_2.3, dir_3.3, rdiv_1.3, rdiv_2.3, rdiv_3.3)
```

```{r}
new_rdiv <- rdiv_1[, c("rdiv")]
new_sign <- rdiv_1[, c("sign")]

dd1 <- dd1 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd1$cor <- "negative"
dd1$z1 <- "low"
dd1$E1_mean <- "low"

new_rdiv <- rdiv_1.2[, c("rdiv")]
new_sign <- rdiv_1.2[, c("sign")]

dd1.2 <- dd1.2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd1.2$cor <- "negative"
dd1.2$z1 <- "low"
dd1.2$E1_mean <- "medium"

new_rdiv <- rdiv_1.3[, c("rdiv")]
new_sign <- rdiv_1.3[, c("sign")]

dd1.3 <- dd1.3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd1.3$cor <- "negative"
dd1.3$z1 <- "low"
dd1.3$E1_mean <- "high"


new_rdiv <- rdiv_2[, c("rdiv")]
new_sign <- rdiv_2[, c("sign")]

dd2 <- dd2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd2$cor <- "negative"
dd2$z1 <- "medium"
dd2$E1_mean <- "low"

new_rdiv <- rdiv_2.2[, c("rdiv")]
new_sign <- rdiv_2.2[, c("sign")]

dd2.2 <- dd2.2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd2.2$cor <- "negative"
dd2.2$z1 <- "medium"
dd2.2$E1_mean <- "medium"

new_rdiv <- rdiv_2.3[, c("rdiv")]
new_sign <- rdiv_2.3[, c("sign")]

dd2.3 <- dd2.3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd2.3$cor <- "negative"
dd2.3$z1 <- "medium"
dd2.3$E1_mean <- "high"


new_rdiv <- rdiv_3[, c("rdiv")]
new_sign <- rdiv_3[, c("sign")]

dd3 <- dd3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign), conflict = "ignore")
dd3$cor <- "negative"
dd3$z1 <- "high"
dd3$E1_mean <- "low"

new_rdiv <- rdiv_3.2[, c("rdiv")]
new_sign <- rdiv_3.2[, c("sign")]

dd3.2 <- dd3.2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd3.2$cor <- "negative"
dd3.2$z1 <- "high"
dd3.2$E1_mean <- "medium"

new_rdiv <- rdiv_3.3[, c("rdiv")]
new_sign <- rdiv_3.3[, c("sign")]

dd3.3 <- dd3.3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd3.3$cor <- "negative"
dd3.3$z1 <- "high"
dd3.3$E1_mean <- "high"
```

## High fluctuation in environmental change - positive correlation

Increasing variance in z1 and z2 - positive correlation between env variables (E1 and E2) with *high* fluctuations

Same steps as before (3 communities with increasing diversity ib z1 while z2 is fixed), but the correlation between E1 and E1 is negative.

```{r plot2.3env, fig.cap='Environmental variables with high variation and positive correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
E1max<-350; E1min<-250
E2max<-75; E2min<- -30
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(150, 150,
                                     150, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p_E1 <- refs1 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  geom_hline(yintercept = mean(refs1$E1),lty=2)+ 
  labs(tag = "(a)") +
  lims(y = c(E1min, E1max))

p_E2 <- refs1 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs1$E2),lty=2)+ 
  labs(tag = "(b)") +
     lims(y = c(E2min, E2max))





### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(150, 150,
                                     150, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p2_E1 <- refs2 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E1),lty=2)+ 
  labs(tag = "(c)") +
   lims(y = c(E1min, E1max))

p2_E2 <- refs2 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E2),lty=2)+ 
  labs(tag = "(d)") +
      lims(y = c(E2min, E2max))



### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(150, 150,
                                     150, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p3_E1 <- refs3 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E1),lty=2)+ 
  labs(tag = "(e)") +
    lims(y = c(E1min, E1max))

p3_E2 <- refs3 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E2),lty=2)+ 
  labs(tag = "(f)") +
   lims(y = c(E2min, E2max))


(p_E1 + p_E2)/(p2_E1 + p2_E2)/(p3_E1 + p3_E2)



detach("package:MASS", unload=TRUE)

```

```{r}
# create reproducible community
set.seed(2456)
### Community 1 - low diversity in z1.
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)


species_pars$z1_range <- 25
species_pars$z2_range <- 25

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)

### Community 3 - high diversity in z1. 

species_pars$z1_range <- 50
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)

```

### Response diversity calculation

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```

Low mean values of E1 and E2 scenario

```{r RDplot1.2.3_a, fig.cap='Directional derivatives and response diversity for the three different communities - Low mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```

Intermediate mean values of E1 and E2 scenario

```{r RDplot2.3.2_c, fig.cap='Directional derivatives and response diversity for the three different communities - Intermediate mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.2, dir_2.2, dir_3.2, rdiv_1.2, rdiv_2.2, rdiv_3.2)
```

High mean values of E1 and E2 scenario

```{r RDplot2.3.3_y, fig.cap='Directional derivatives and response diversity for the three different communities - high mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.3, dir_2.3, dir_3.3, rdiv_1.3, rdiv_2.3, rdiv_3.3)
```

```{r}
dd4 <- data.frame(rdiv_1[, c("rdiv", "sign")]) 
dd4$cor <- "positive"
dd4$z1 <- "low"
dd4$E1_mean <- "low"

dd4.2 <- data.frame(rdiv_1.2[, c("rdiv", "sign")]) 
dd4.2$cor <- "positive"
dd4.2$z1 <- "low"
dd4.2$E1_mean <- "medium"

dd4.3 <- data.frame(rdiv_1.3[, c("rdiv", "sign")]) 
dd4.3$cor <- "positive"
dd4.3$z1 <- "low"
dd4.3$E1_mean <- "high"


dd5 <- data.frame(rdiv_2[, c("rdiv", "sign")]) 
dd5$cor <- "positive"
dd5$z1 <- "medium"
dd5$E1_mean <- "low"

dd5.2 <- data.frame(rdiv_2.2[, c("rdiv", "sign")]) 
dd5.2$cor <- "positive"
dd5.2$z1 <- "medium"
dd5.2$E1_mean <- "medium"

dd5.3 <- data.frame(rdiv_2.3[, c("rdiv", "sign")]) 
dd5.3$cor <- "positive"
dd5.3$z1 <- "medium"
dd5.3$E1_mean <- "high"

dd6 <- data.frame(rdiv_3[, c("rdiv", "sign")]) 
dd6$cor <- "positive"
dd6$z1 <- "high"
dd6$E1_mean <-"low"


dd6.2 <- data.frame(rdiv_3.2[, c("rdiv", "sign")]) 
dd6.2$cor <- "positive"
dd6.2$z1 <- "high"
dd6.2$E1_mean <- "medium"

dd6.3 <- data.frame(rdiv_3.3[, c("rdiv", "sign")]) 
dd6.3$cor <- "positive"
dd6.3$z1 <- "high"
dd6.3$E1_mean <- "high"
```

## Low fluctuation in environmental change - positive correlation

Increasing variance in z1 and z2 - positive correlation between env variables (E1 and E2) with *low* fluctuations

We repeat the same steps as in the previous section, but this time E1 and E2 have a very small variance.

```{r plot2.4env, fig.cap='Environmental variables with *low* variation and negative correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
E1max<-320; E1min<-275
E2max<-50; E2min<- -5

# Scenario 1 - low mean vakues of E1 and E2
theme_set(theme_classic(base_size = 12))
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(1, 1,
                                     1, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p_E1 <- refs1 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  geom_hline(yintercept = mean(refs1$E1),lty=2)+ 
  labs(tag = "(a)") +
  lims(y = c(E1min, E1max))

p_E2 <- refs1 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs1$E2),lty=2)+ 
  labs(tag = "(b)") +
     lims(y = c(E2min, E2max))





### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(1, 1,
                                     1, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p2_E1 <- refs2 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E1),lty=2)+ 
  labs(tag = "(c)") +
   lims(y = c(E1min, E1max))

p2_E2 <- refs2 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E2),lty=2)+ 
  labs(tag = "(d)") +
      lims(y = c(E2min, E2max))



### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(1, 1,
                                     1, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p3_E1 <- refs3 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E1),lty=2)+ 
  labs(tag = "(e)") +
    lims(y = c(E1min, E1max))

p3_E2 <- refs3 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E2),lty=2)+ 
  labs(tag = "(f)") +
   lims(y = c(E2min, E2max))


(p_E1 + p_E2)/(p2_E1 + p2_E2)/(p3_E1 + p3_E2)



detach("package:MASS", unload=TRUE)
```

```{r }
### Community 1 - low diversity in z1.
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)


species_pars$z1_range <- 25
species_pars$z2_range <- 25

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)


### Community 3 - high diversity in z1. 

species_pars$z1_range <- 50
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)

```

### Response diversity calculation

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```

Low mean values of E1 and E2 scenario

```{r RDplot1.2.3_b, fig.cap='Directional derivatives and response diversity for the three different communities - Low mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```

Intermediate mean values of E1 and E2 scenario

```{r RDplot2.3.2_a, fig.cap='Directional derivatives and response diversity for the three different communities - Intermediate mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.2, dir_2.2, dir_3.2, rdiv_1.2, rdiv_2.2, rdiv_3.2)
```

High mean values of E1 and E2 scenario

```{r RDplot2.3.3_a, fig.cap='Directional derivatives and response diversity for the three different communities - high mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.3, dir_2.3, dir_3.3, rdiv_1.3, rdiv_2.3, rdiv_3.3)
```

```{r}
new_rdiv <- rdiv_1[, c("rdiv")]
new_sign <- rdiv_1[, c("sign")]

dd4 <- dd4 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd4$cor <- "negative"
dd4$z1 <- "low"
dd4$E1_mean <- "low"

new_rdiv <- rdiv_1.2[, c("rdiv")]
new_sign <- rdiv_1.2[, c("sign")]

dd4.2 <- dd4.2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd4.2$cor <- "negative"
dd4.2$z1 <- "low"
dd4.2$E1_mean <- "medium"

new_rdiv <- rdiv_1.3[, c("rdiv")]
new_sign <- rdiv_1.3[, c("sign")]

dd4.3 <- dd4.3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd4.3$cor <- "negative"
dd4.3$z1 <- "low"
dd4.3$E1_mean <- "high"


new_rdiv <- rdiv_2[, c("rdiv")]
new_sign <- rdiv_2[, c("sign")]

dd5 <- dd5 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd5$cor <- "negative"
dd5$z1 <- "medium"
dd5$E1_mean <- "low"

new_rdiv <- rdiv_2.2[, c("rdiv")]
new_sign <- rdiv_2.2[, c("sign")]

dd5.2 <- dd5.2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd5.2$cor <- "negative"
dd5.2$z1 <- "medium"
dd5.2$E1_mean <- "medium"

new_rdiv <- rdiv_2.3[, c("rdiv")]
new_sign <- rdiv_2.3[, c("sign")]

dd5.3 <- dd5.3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd5.3$cor <- "negative"
dd5.3$z1 <- "medium"
dd5.3$E1_mean <- "high"


new_rdiv <- rdiv_3[, c("rdiv")]
new_sign <- rdiv_3[, c("sign")]

dd6 <- dd6 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign), conflict = "ignore")
dd6$cor <- "negative"
dd6$z1 <- "high"
dd6$E1_mean <- "low"

new_rdiv <- rdiv_3.2[, c("rdiv")]
new_sign <- rdiv_3.2[, c("sign")]

rdiv_6.2 <- rdiv_3.2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign), conflict = "ignore")
rdiv_6.2$cor <- "negative"
rdiv_6.2$z1 <- "high"
rdiv_6.2$E1_mean <- "medium"

new_rdiv <- rdiv_3.3[, c("rdiv")]
new_sign <- rdiv_3.3[, c("sign")]

dd6.3 <- dd6.3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd6.3$cor <- "negative"
dd6.3$z1 <- "high"
dd6.3$E1_mean <- "high"
```

## High fluctuation in environmental change - no correlation

Increasing variance in z1 - no correlation between env variables (E1 and E2) with *high* fluctuations

Same steps as before (3 communities with increasing diversity in z1 while z2 is fixed), but there is no correlation between E1 and E1

```{r plot2.5env, fig.cap='Environmental variables with high variation and no correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
E1max<-350; E1min<-250
E2max<-75; E2min<- -20
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(150, 0.0,
                                     0.0, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p_E1 <- refs1 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  geom_hline(yintercept = mean(refs1$E1),lty=2)+ 
  labs(tag = "(a)") +
  lims(y = c(E1min, E1max))

p_E2 <- refs1 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs1$E2),lty=2)+ 
  labs(tag = "(b)") +
     lims(y = c(E2min, E2max))





### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(150, 0.0,
                                     0.0, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p2_E1 <- refs2 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E1),lty=2)+ 
  labs(tag = "(c)") +
   lims(y = c(E1min, E1max))

p2_E2 <- refs2 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E2),lty=2)+ 
  labs(tag = "(d)") +
      lims(y = c(E2min, E2max))



### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(150, 0.0,
                                     0.0, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p3_E1 <- refs3 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E1),lty=2)+ 
  labs(tag = "(e)") +
    lims(y = c(E1min, E1max))

p3_E2 <- refs3 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E2),lty=2)+ 
  labs(tag = "(f)") +
   lims(y = c(E2min, E2max))


(p_E1 + p_E2)/(p2_E1 + p2_E2)/(p3_E1 + p3_E2)



detach("package:MASS", unload=TRUE)

```

```{r}
# create reproducible community
set.seed(2456)
### Community 1 - low diversity in z1.
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)


species_pars$z1_range <- 25
species_pars$z2_range <- 25

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)

### Community 3 - high diversity in z1. 

species_pars$z1_range <- 50
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)

```

### Response diversity calculation

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```

Low mean values of E1 and E2 scenario

```{r RDplot3_se, fig.cap='Directional derivatives and response diversity for the three different communities - Low mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```

Intermediate mean values of E1 and E2 scenario

```{r RDplot3.2.0, fig.cap='Directional derivatives and response diversity for the three different communities - Intermediate mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.2, dir_2.2, dir_3.2, rdiv_1.2, rdiv_2.2, rdiv_3.2)
```

High mean values of E1 and E2 scenario

```{r RDplot3.3_ter, fig.cap='Directional derivatives and response diversity for the three different communities - high mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.3, dir_2.3, dir_3.3, rdiv_1.3, rdiv_2.3, rdiv_3.3)
```

```{r}
dd7 <- data.frame(rdiv_1[, c("rdiv", "sign")]) 
dd7$cor <- "no cor"
dd7$z1 <- "low"
dd7$E1_mean <- "low"

dd7.2 <- data.frame(rdiv_1.2[, c("rdiv", "sign")]) 
dd7.2$cor <- "no cor"
dd7.2$z1 <- "low"
dd7.2$E1_mean <- "medium"

dd7.3 <- data.frame(rdiv_1.3[, c("rdiv", "sign")]) 
dd7.3$cor <- "no cor"
dd7.3$z1 <- "low"
dd7.3$E1_mean <- "high"


dd8 <- data.frame(rdiv_2[, c("rdiv", "sign")]) 
dd8$cor <- "no cor"
dd8$z1 <- "medium"
dd8$E1_mean <- "low"

dd8.2 <- data.frame(rdiv_2.2[, c("rdiv", "sign")]) 
dd8.2$cor <- "no cor"
dd8.2$z1 <- "medium"
dd8.2$E1_mean <- "medium"

dd8.3 <- data.frame(rdiv_2.3[, c("rdiv", "sign")]) 
dd8.3$cor <- "no cor"
dd8.3$z1 <- "medium"
dd8.3$E1_mean <- "high"

dd9 <- data.frame(rdiv_3[, c("rdiv", "sign")]) 
dd9$cor <- "no cor"
dd9$z1 <- "high"
dd9$E1_mean <-"low"


dd9.2 <- data.frame(rdiv_3.2[, c("rdiv", "sign")]) 
dd9.2$cor <- "no cor"
dd9.2$z1 <- "high"
dd9.2$E1_mean <- "medium"

dd9.3 <- data.frame(rdiv_3.3[, c("rdiv", "sign")]) 
dd9.3$cor <- "no cor"
dd9.3$z1 <- "high"
dd9.3$E1_mean <- "high"
```

## Low fluctuation in environmental change - no correlation

Increasing variance in z1 - no correlation between env variables (E1 and E2) with *low* fluctuations

We repeat the same steps as in the previous section, but this time E1 and E2 have a very small variance.

```{r plot6env_a, fig.cap='Environmental variables with *low* variation and negative correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
E1max<-320; E1min<-275
E2max<-60; E2min<- -10

# Scenario 1 - low mean vakues of E1 and E2
theme_set(theme_classic(base_size = 12))
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(1, 0.0,
                                     0.0, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p_E1 <- refs1 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  geom_hline(yintercept = mean(refs1$E1),lty=2)+ 
  labs(tag = "(a)") +
  lims(y = c(E1min, E1max))

p_E2 <- refs1 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs1$E2),lty=2)+ 
  labs(tag = "(b)") +
     lims(y = c(E2min, E2max))





### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(1, 0.0,
                                     0.0, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p2_E1 <- refs2 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E1),lty=2)+ 
  labs(tag = "(c)") +
   lims(y = c(E1min, E1max))

p2_E2 <- refs2 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E2),lty=2)+ 
  labs(tag = "(d)") +
      lims(y = c(E2min, E2max))



### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(1, 0.0,
                                     0.0, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p3_E1 <- refs3 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E1),lty=2)+ 
  labs(tag = "(e)") +
    lims(y = c(E1min, E1max))

p3_E2 <- refs3 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E2),lty=2)+ 
  labs(tag = "(f)") +
   lims(y = c(E2min, E2max))


(p_E1 + p_E2)/(p2_E1 + p2_E2)/(p3_E1 + p3_E2)



detach("package:MASS", unload=TRUE)
```

```{r }
### Community 1 - low diversity in z1.
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)


species_pars$z1_range <- 25
species_pars$z2_range <- 25

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)


### Community 3 - high diversity in z1. 

species_pars$z1_range <- 50
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)

```

### Response diversity calculation

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```

Low mean values of E1 and E2 scenario

```{r RDplot3_ter, fig.cap='Directional derivatives and response diversity for the three different communities - Low mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```

Intermediate mean values of E1 and E2 scenario

```{r RDplot3.2.3_p, fig.cap='Directional derivatives and response diversity for the three different communities - Intermediate mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.2, dir_2.2, dir_3.2, rdiv_1.2, rdiv_2.2, rdiv_3.2)
```

High mean values of E1 and E2 scenario

```{r RDplot3.3.6, fig.cap='Directional derivatives and response diversity for the three different communities - high mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.3, dir_2.3, dir_3.3, rdiv_1.3, rdiv_2.3, rdiv_3.3)
```

```{r}
new_rdiv <- rdiv_1[, c("rdiv")]
new_sign <- rdiv_1[, c("sign")]

dd7 <- dd7 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd7$cor <- "negative"
dd7$z1 <- "low"
dd7$E1_mean <- "low"

new_rdiv <- rdiv_1.2[, c("rdiv")]
new_sign <- rdiv_1.2[, c("sign")]

dd7.2 <- dd7.2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd7.2$cor <- "negative"
dd7.2$z1 <- "low"
dd7.2$E1_mean <- "medium"

new_rdiv <- rdiv_1.3[, c("rdiv")]
new_sign <- rdiv_1.3[, c("sign")]

dd7.3 <- dd7.3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd7.3$cor <- "negative"
dd7.3$z1 <- "low"
dd7.3$E1_mean <- "high"


new_rdiv <- rdiv_2[, c("rdiv")]
new_sign <- rdiv_2[, c("sign")]

dd8 <- dd8 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd8$cor <- "negative"
dd8$z1 <- "medium"
dd8$E1_mean <- "low"

new_rdiv <- rdiv_2.2[, c("rdiv")]
new_sign <- rdiv_2.2[, c("sign")]

dd8.2 <- dd8.2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd8.2$cor <- "negative"
dd8.2$z1 <- "medium"
dd8.2$E1_mean <- "medium"

new_rdiv <- rdiv_2.3[, c("rdiv")]
new_sign <- rdiv_2.3[, c("sign")]

dd8.3 <- dd8.3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd8.3$cor <- "negative"
dd8.3$z1 <- "medium"
dd8.3$E1_mean <- "high"


new_rdiv <- rdiv_3[, c("rdiv")]
new_sign <- rdiv_3[, c("sign")]

dd9 <- dd9 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign), conflict = "ignore")
dd9$cor <- "negative"
dd9$z1 <- "high"
dd9$E1_mean <- "low"

new_rdiv <- rdiv_3.2[, c("rdiv")]
new_sign <- rdiv_3.2[, c("sign")]

rdiv_9.2 <- rdiv_3.2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign), conflict = "ignore")
rdiv_9.2$cor <- "negative"
rdiv_9.2$z1 <- "high"
rdiv_9.2$E1_mean <- "medium"

new_rdiv <- rdiv_3.3[, c("rdiv")]
new_sign <- rdiv_3.3[, c("sign")]

dd9.3 <- dd9.3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign), conflict = "ignore")
dd9.3$cor <- "negative"
dd9.3$z1 <- "high"
dd9.3$E1_mean <- "high"
```

## Summary plot - Effects of z1 diversity and correlation between environmental variables on response diversity

```{r SummaryPlot2, fig.align="center", fig.height=8, fig.width=10, fig.cap="Influence of the correlation between environmental variables and z1 diversity on response diversity. (a) Effects of the correlation between environmental variables and z1 diversity on response diversity measured as dissimilarity (sign insensitive measure). (b) Effects of the correlation between environmental variables and z1 diversity on response diversity measured as divergence (sign sensitive measure)."}

dd_plot1 <- rbind(dd1[,c(1,3:5)], dd1.2[,c(1,3:5)],dd1.3[,c(1,3:5)],
                  dd2[,c(1,3:5)], dd2.2[,c(1,3:5)],dd2.3[,c(1,3:5)],
                  dd3[,c(1,3:5)], dd3.2[,c(1,3:5)],dd3.3[,c(1,3:5)],
                  dd4[,c(1,3:5)], dd4.2[,c(1,3:5)],dd4.3[,c(1,3:5)],
                  dd5[,c(1,3:5)], dd5.2[,c(1,3:5)],dd5.3[,c(1,3:5)], 
                  dd6[,c(1,3:5)], dd6.2[,c(1,3:5)],dd6.3[,c(1,3:5)],
                  dd7[,c(1,3:5)], dd7.2[,c(1,3:5)],dd7.3[,c(1,3:5)],
                  dd8[,c(1,3:5)], dd8.2[,c(1,3:5)],dd8.3[,c(1,3:5)],
                  dd9[,c(1,3:5)], dd9.2[,c(1,3:5)],dd9.3[,c(1,3:5)])
dd_plot1$z1 <- factor(dd_plot1$z1, levels = c("low", "medium", "high"))
theme_set(theme_classic(base_size = 12))

g1.1 <-
  ggplot(dd_plot1, aes(x = z1, y = rdiv, color = E1_mean)) +
   # scale_y_continuous(limits = c(0.99, 1.005), expand = c(0.02, 0.02)) +
    scale_color_uchicago() +
    labs(x = "z1 diversity", y = "Dissimilarity (derivatives)") +
    theme(
      legend.position = "none",
      axis.title = element_text(size = 16),
      panel.grid = element_blank()
    )


rdiv2 <- g1.1 +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  stat_summary(fun = mean, geom = "point", size = 5) + labs(tag = "(a)")

dd_plot2 <- rbind(dd1[,c(2,3:5)], dd1.2[,c(2,3:5)],dd1.3[,c(2,3:5)],
                  dd2[,c(2,3:5)], dd2.2[,c(2,3:5)],dd2.3[,c(2,3:5)],
                  dd3[,c(2,3:5)], dd3.2[,c(2,3:5)],dd3.3[,c(2,3:5)],
                  dd4[,c(2,3:5)], dd4.2[,c(2,3:5)],dd4.3[,c(2,3:5)],
                  dd5[,c(2,3:5)], dd5.2[,c(2,3:5)],dd5.3[,c(2,3:5)], 
                  dd6[,c(2,3:5)], dd6.2[,c(2,3:5)],dd6.3[,c(2,3:5)],
                  dd7[,c(2,3:5)], dd7.2[,c(2,3:5)],dd7.3[,c(2,3:5)],
                  dd8[,c(2,3:5)], dd8.2[,c(2,3:5)],dd8.3[,c(2,3:5)],
                  dd9[,c(2,3:5)], dd9.2[,c(2,3:5)],dd9.3[,c(2,3:5)])
dd_plot2$z1 <- factor(dd_plot2$z1, levels = c("low", "medium", "high"))
g1.2 <-
  ggplot(dd_plot2, aes(x = z1, y = sign, color = E1_mean)) +
    scale_color_uchicago() +
    labs(x = "z1 diveristy", y = "Divergence (sign sensitive)") +
    theme(
      legend.position = "none",
      axis.title = element_text(size = 16),
      panel.grid = element_blank()
    )

sign2 <- g1.2 +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  stat_summary(fun = mean, geom = "point", size = 5)+ labs(tag = "(b)") +
  ylim(0, 1)

combined <- rdiv1 + sign1 & theme(legend.position = "bottom")
combined + plot_layout(guides = "collect")

```
# Variation in diversity in z1 and z2

Now we do the same, but having also z2 changing together with z1 with negative correlation. So, diversity in z1 is increasing gradually from low to high in the 3 communities, while z2 decreases gradually in the 3 communities (anti-tolerance scenario?).

## High fluctuation in environmental change - negative correlation

Increasing variance in z1 and z2 - negative correlation between env variables (E1 and E2) with *high* fluctuations.

We now create 3 communities. Community 1 is characterized by low diversity in z1 and high diversity in z2, community 2 has medium diversity in z1 and z2, and community 3 has high diversity in z1 and low in z2.

E1 and E2 have high fluctuations and *negative* correlation.

```{r plot13env, fig.cap='Environmental variables with *high* variation and negative correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
# Specify the correlation E1 and E2 
#negative in this example and high variation in E1 and E2 
E1max<-350; E1min<-250
E2max<- 90; E2min<- -20

# Scenario 1 - low mean vakues of E1 and E2
theme_set(theme_classic(base_size = 12))
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(150, -150,
                                     -150, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p_E1 <- refs1 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  geom_hline(yintercept = mean(refs1$E1),lty=2)+ 
  labs(tag = "(a)") +
  lims(y = c(E1min, E1max))

p_E2 <- refs1 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs1$E2),lty=2)+ 
  labs(tag = "(b)") +
     lims(y = c(E2min, E2max))





### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(150, -150,
                                     -150, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p2_E1 <- refs2 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E1),lty=2)+ 
  labs(tag = "(c)") +
   lims(y = c(E1min, E1max))

p2_E2 <- refs2 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E2),lty=2)+ 
  labs(tag = "(d)") +
      lims(y = c(E2min, E2max))



### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(150, -150,
                                     -150, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p3_E1 <- refs3 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E1),lty=2)+ 
  labs(tag = "(e)") +
    lims(y = c(E1min, E1max))

p3_E2 <- refs3 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E2),lty=2)+ 
  labs(tag = "(f)") +
   lims(y = c(E2min, E2max))


(p_E1 + p_E2)/(p2_E1 + p2_E2)/(p3_E1 + p3_E2)



detach("package:MASS", unload=TRUE)

```

### Community 1 - low diversity in z1.

```{r}
## Set species parameters
species_pars <- list(a1_mean = 1e-9,
  b1_mean = 0.063,
  z1_mean = 285,
  w1_mean = 60,
  a2_mean = 1e-3,
  b2_mean = 0.02,
  z2_mean = 20,
  w2_mean = 10,
  zint_mean = 0,
  sd_rate_mean = 0,
  z1_range = NA,
  z2_range = NA)

```

```{r plotcomm1_mix, fig.cap='Community 1, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=20, fig.width=12}
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm1 <- multi_performance_plot(comm)
performance_comm1

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)
```

```{r}
# Find optimum for E1 and E1 for each sp 
optima_com1 <- get_optima(comm, new_data)
optima_com1$community <- 1
```

### Community 2 - medium diversity in z1.

```{r plotcomm2_mix, fig.cap='Community 2, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=20, fig.width=12}
species_pars$z1_range <- 25
species_pars$z2_range <- 25

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm2 <- multi_performance_plot(comm)
performance_comm2
# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)

```

```{r}
# Find optimum for E1 and E1 for each sp 
optima_com2 <- get_optima(comm, new_data)
optima_com2$community <- 2
```

### Community 3 - high diversity in z1.

```{r plotcomm3_mix, fig.cap=' Community 3, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).', fig.align="center", fig.height=20, fig.width=12}
species_pars$z1_range <- 50
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm3 <- multi_performance_plot(comm)
performance_comm3
# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)
```

```{r}
# Find optimum for E1 and E1 for each sp 
optima_com3 <- get_optima(comm, new_data)
optima_com3$community <- 3
```

### Position of the optimum

Here and elsewhere in this document, the position of the optima has been estimated as the environmental location (E1 and E2 values) for which the rate is maximum.

```{r plotoptimum3.1, fig.cap='Position of the optimum for E1 and E2 in the 3 different communities', fig.align="center", fig.height=6, fig.width=8}
optima <- rbind(optima_com1, optima_com2, optima_com3)
optima %>%  ggplot(aes(x = E1, y = E2, col = as.factor(community))) +
  geom_point() +
  labs(x = "Optimum E1", y = "Optimum E2")
```

### Response diversity calculation - first scenario (low mean values of E1 and E2)

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```

Low mean values of E1 and E2 scenario

```{r RDplot3.2.1_b, fig.cap='Directional derivatives and response diversity for the three different communities - Low mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```

Intermediate mean values of E1 and E2 scenario

```{r RDplot3.1.2_a, fig.cap='Directional derivatives and response diversity for the three different communities - Intermediate mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.2, dir_2.2, dir_3.2, rdiv_1.2, rdiv_2.2, rdiv_3.2)
```

High mean values of E1 and E2 scenario

```{r RDplot3.1.3, fig.cap='Directional derivatives and response diversity for the three different communities - high mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.3, dir_2.3, dir_3.3, rdiv_1.3, rdiv_2.3, rdiv_3.3)
```

```{r}
dd1 <- data.frame(rdiv_1[, c("rdiv", "sign")]) 
dd1$cor <- "negative"
dd1$z1 <- "low"
dd1$E1_mean <- "low"

dd1.2 <- data.frame(rdiv_1.2[, c("rdiv", "sign")]) 
dd1.2$cor <- "negative"
dd1.2$z1 <- "low"
dd1.2$E1_mean <- "medium"

dd1.3 <- data.frame(rdiv_1.3[, c("rdiv", "sign")]) 
dd1.3$cor <- "negative"
dd1.3$z1 <- "low"
dd1.3$E1_mean <- "high"


dd2 <- data.frame(rdiv_2[, c("rdiv", "sign")]) 
dd2$cor <- "negative"
dd2$z1 <- "medium"
dd2$E1_mean <- "low"

dd2.2 <- data.frame(rdiv_2.2[, c("rdiv", "sign")]) 
dd2.2$cor <- "negative"
dd2.2$z1 <- "medium"
dd2.2$E1_mean <- "medium"

dd2.3 <- data.frame(rdiv_2.3[, c("rdiv", "sign")]) 
dd2.3$cor <- "negative"
dd2.3$z1 <- "medium"
dd2.3$E1_mean <- "high"

dd3 <- data.frame(rdiv_3[, c("rdiv", "sign")]) 
dd3$cor <- "negative"
dd3$z1 <- "high"
dd3$E1_mean <-"low"


dd3.2 <- data.frame(rdiv_3.2[, c("rdiv", "sign")]) 
dd3.2$cor <- "negative"
dd3.2$z1 <- "high"
dd3.2$E1_mean <- "medium"

dd3.3 <- data.frame(rdiv_3.3[, c("rdiv", "sign")]) 
dd3.3$cor <- "negative"
dd3.3$z1 <- "high"
dd3.3$E1_mean <- "high"
```

## Low fluctuation in environmental change - negative correlation

Increasing variance in z1 and z2 - negative correlation between env variables (E1 and E2) with *low* fluctuations

We repeat the same steps as in the previous section, but this time E1 and E2 have a very small variance.

```{r plot3.2env, fig.cap='Environmental variables with high variation and negative correlation. Different scenarios of E1 and E2 changing over time (a) low mean value of E1. (b) low mean value of E2. (c) medium mean value of E1. (d) medium mean value of E2. (e) high mean value of E1. (f) high mean value of E2', fig.align="center", fig.height=6, fig.width=12}
# Specify the correlation E1 and E2 
#negative in this example and high variation in E1 and E2 
E1max<-330; E1min<-275
E2max<-60; E2min<- -5

# Scenario 1 - low mean vakues of E1 and E2
theme_set(theme_classic(base_size = 12))
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(1, -1,
                                     -1, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p_E1 <- refs1 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  geom_hline(yintercept = mean(refs1$E1),lty=2)+ 
  labs(tag = "(a)") +
  lims(y = c(E1min, E1max))

p_E2 <- refs1 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs1$E2),lty=2)+ 
  labs(tag = "(b)") +
     lims(y = c(E2min, E2max))





### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(1, -1,
                                     -1, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p2_E1 <- refs2 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E1),lty=2)+ 
  labs(tag = "(c)") +
   lims(y = c(E1min, E1max))

p2_E2 <- refs2 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E2),lty=2)+ 
  labs(tag = "(d)") +
      lims(y = c(E2min, E2max))



### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(1, -1,
                                     -1, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p3_E1 <- refs3 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E1),lty=2)+ 
  labs(tag = "(e)") +
    lims(y = c(E1min, E1max))

p3_E2 <- refs3 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E2),lty=2)+ 
  labs(tag = "(f)") +
   lims(y = c(E2min, E2max))


(p_E1 + p_E2)/(p2_E1 + p2_E2)/(p3_E1 + p3_E2)



detach("package:MASS", unload=TRUE)

```

```{r }
### Community 1 - low diversity in z1.
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)


species_pars$z1_range <- 25
species_pars$z2_range <- 25

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)


### Community 3 - high diversity in z1. 

species_pars$z1_range <- 50
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)

```

### Response diversity calculation

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```

Low mean values of E1 and E2 scenario

```{r RDplot3.2.2_a, fig.cap='Directional derivatives and response diversity for the three different communities - Low mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```

Intermediate mean values of E1 and E2 scenario

```{r RDplot3.2.d, fig.cap='Directional derivatives and response diversity for the three different communities - Intermediate mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.2, dir_2.2, dir_3.2, rdiv_1.2, rdiv_2.2, rdiv_3.2)
```

High mean values of E1 and E2 scenario

```{r RDplot3.2.3_a, fig.cap='Directional derivatives and response diversity for the three different communities - high mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.3, dir_2.3, dir_3.3, rdiv_1.3, rdiv_2.3, rdiv_3.3)
```

```{r}
new_rdiv <- rdiv_1[, c("rdiv")]
new_sign <- rdiv_1[, c("sign")]

dd1 <- dd1 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd1$cor <- "negative"
dd1$z1 <- "low"
dd1$E1_mean <- "low"

new_rdiv <- rdiv_1.2[, c("rdiv")]
new_sign <- rdiv_1.2[, c("sign")]

dd1.2 <- dd1.2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd1.2$cor <- "negative"
dd1.2$z1 <- "low"
dd1.2$E1_mean <- "medium"

new_rdiv <- rdiv_1.3[, c("rdiv")]
new_sign <- rdiv_1.3[, c("sign")]

dd1.3 <- dd1.3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd1.3$cor <- "negative"
dd1.3$z1 <- "low"
dd1.3$E1_mean <- "high"


new_rdiv <- rdiv_2[, c("rdiv")]
new_sign <- rdiv_2[, c("sign")]

dd2 <- dd2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd2$cor <- "negative"
dd2$z1 <- "medium"
dd2$E1_mean <- "low"

new_rdiv <- rdiv_2.2[, c("rdiv")]
new_sign <- rdiv_2.2[, c("sign")]

dd2.2 <- dd2.2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd2.2$cor <- "negative"
dd2.2$z1 <- "medium"
dd2.2$E1_mean <- "medium"

new_rdiv <- rdiv_2.3[, c("rdiv")]
new_sign <- rdiv_2.3[, c("sign")]

dd2.3 <- dd2.3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd2.3$cor <- "negative"
dd2.3$z1 <- "medium"
dd2.3$E1_mean <- "high"


new_rdiv <- rdiv_3[, c("rdiv")]
new_sign <- rdiv_3[, c("sign")]

dd3 <- dd3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign), conflict = "ignore")
dd3$cor <- "negative"
dd3$z1 <- "high"
dd3$E1_mean <- "low"

new_rdiv <- rdiv_3.2[, c("rdiv")]
new_sign <- rdiv_3.2[, c("sign")]

dd3.2 <- dd3.2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd3.2$cor <- "negative"
dd3.2$z1 <- "high"
dd3.2$E1_mean <- "medium"

new_rdiv <- rdiv_3.3[, c("rdiv")]
new_sign <- rdiv_3.3[, c("sign")]

dd3.3 <- dd3.3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd3.3$cor <- "negative"
dd3.3$z1 <- "high"
dd3.3$E1_mean <- "high"
```

## High fluctuation in environmental change - positive correlation

Increasing variance in z1 and z2 - positive correlation between env variables (E1 and E2) with *high* fluctuations

Same steps as before (3 communities with increasing diversity ib z1 while z2 is fixed), but the correlation between E1 and E1 is negative.

```{r plot3.3env, fig.cap='Environmental variables with high variation and positive correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
E1max<-350; E1min<-250
E2max<-75; E2min<- -30
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(150, 150,
                                     150, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p_E1 <- refs1 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  geom_hline(yintercept = mean(refs1$E1),lty=2)+ 
  labs(tag = "(a)") +
  lims(y = c(E1min, E1max))

p_E2 <- refs1 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs1$E2),lty=2)+ 
  labs(tag = "(b)") +
     lims(y = c(E2min, E2max))





### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(150, 150,
                                     150, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p2_E1 <- refs2 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E1),lty=2)+ 
  labs(tag = "(c)") +
   lims(y = c(E1min, E1max))

p2_E2 <- refs2 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E2),lty=2)+ 
  labs(tag = "(d)") +
      lims(y = c(E2min, E2max))



### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(150, 150,
                                     150, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p3_E1 <- refs3 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E1),lty=2)+ 
  labs(tag = "(e)") +
    lims(y = c(E1min, E1max))

p3_E2 <- refs3 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E2),lty=2)+ 
  labs(tag = "(f)") +
   lims(y = c(E2min, E2max))


(p_E1 + p_E2)/(p2_E1 + p2_E2)/(p3_E1 + p3_E2)



detach("package:MASS", unload=TRUE)

```

```{r}
# create reproducible community
set.seed(2456)
### Community 1 - low diversity in z1.
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)


species_pars$z1_range <- 25
species_pars$z2_range <- 25

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)

### Community 3 - high diversity in z1. 

species_pars$z1_range <- 50
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)

```

### Response diversity calculation

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```

Low mean values of E1 and E2 scenario

```{r RDplot3.2.3_n, fig.cap='Directional derivatives and response diversity for the three different communities - Low mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```

Intermediate mean values of E1 and E2 scenario

```{r RDplot3.3.2_a, fig.cap='Directional derivatives and response diversity for the three different communities - Intermediate mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.2, dir_2.2, dir_3.2, rdiv_1.2, rdiv_2.2, rdiv_3.2)
```

High mean values of E1 and E2 scenario

```{r RDplot3.3.3_a, fig.cap='Directional derivatives and response diversity for the three different communities - high mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.3, dir_2.3, dir_3.3, rdiv_1.3, rdiv_2.3, rdiv_3.3)
```

```{r}
dd4 <- data.frame(rdiv_1[, c("rdiv", "sign")]) 
dd4$cor <- "positive"
dd4$z1 <- "low"
dd4$E1_mean <- "low"

dd4.2 <- data.frame(rdiv_1.2[, c("rdiv", "sign")]) 
dd4.2$cor <- "positive"
dd4.2$z1 <- "low"
dd4.2$E1_mean <- "medium"

dd4.3 <- data.frame(rdiv_1.3[, c("rdiv", "sign")]) 
dd4.3$cor <- "positive"
dd4.3$z1 <- "low"
dd4.3$E1_mean <- "high"


dd5 <- data.frame(rdiv_2[, c("rdiv", "sign")]) 
dd5$cor <- "positive"
dd5$z1 <- "medium"
dd5$E1_mean <- "low"

dd5.2 <- data.frame(rdiv_2.2[, c("rdiv", "sign")]) 
dd5.2$cor <- "positive"
dd5.2$z1 <- "medium"
dd5.2$E1_mean <- "medium"

dd5.3 <- data.frame(rdiv_2.3[, c("rdiv", "sign")]) 
dd5.3$cor <- "positive"
dd5.3$z1 <- "medium"
dd5.3$E1_mean <- "high"

dd6 <- data.frame(rdiv_3[, c("rdiv", "sign")]) 
dd6$cor <- "positive"
dd6$z1 <- "high"
dd6$E1_mean <-"low"


dd6.2 <- data.frame(rdiv_3.2[, c("rdiv", "sign")]) 
dd6.2$cor <- "positive"
dd6.2$z1 <- "high"
dd6.2$E1_mean <- "medium"

dd6.3 <- data.frame(rdiv_3.3[, c("rdiv", "sign")]) 
dd6.3$cor <- "positive"
dd6.3$z1 <- "high"
dd6.3$E1_mean <- "high"
```

## Low fluctuation in environmental change - positive correlation

Increasing variance in z1 and z2 - positive correlation between env variables (E1 and E2) with *low* fluctuations

We repeat the same steps as in the previous section, but this time E1 and E2 have a very small variance.

```{r plot3.4env, fig.cap='Environmental variables with *low* variation and negative correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
E1max<-320; E1min<-275
E2max<-50; E2min<- -5

# Scenario 1 - low mean vakues of E1 and E2
theme_set(theme_classic(base_size = 12))
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(1, 1,
                                     1, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p_E1 <- refs1 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  geom_hline(yintercept = mean(refs1$E1),lty=2)+ 
  labs(tag = "(a)") +
  lims(y = c(E1min, E1max))

p_E2 <- refs1 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs1$E2),lty=2)+ 
  labs(tag = "(b)") +
     lims(y = c(E2min, E2max))





### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(1, 1,
                                     1, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p2_E1 <- refs2 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E1),lty=2)+ 
  labs(tag = "(c)") +
   lims(y = c(E1min, E1max))

p2_E2 <- refs2 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E2),lty=2)+ 
  labs(tag = "(d)") +
      lims(y = c(E2min, E2max))



### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(1, 1,
                                     1, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p3_E1 <- refs3 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E1),lty=2)+ 
  labs(tag = "(e)") +
    lims(y = c(E1min, E1max))

p3_E2 <- refs3 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E2),lty=2)+ 
  labs(tag = "(f)") +
   lims(y = c(E2min, E2max))


(p_E1 + p_E2)/(p2_E1 + p2_E2)/(p3_E1 + p3_E2)



detach("package:MASS", unload=TRUE)
```

```{r }
### Community 1 - low diversity in z1.
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)


species_pars$z1_range <- 25
species_pars$z2_range <- 25

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)


### Community 3 - high diversity in z1. 

species_pars$z1_range <- 50
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)

```

### Response diversity calculation

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```

Low mean values of E1 and E2 scenario

```{r RDplot3.2.3_e, fig.cap='Directional derivatives and response diversity for the three different communities - Low mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```

Intermediate mean values of E1 and E2 scenario

```{r RDplot3.3.2_b, fig.cap='Directional derivatives and response diversity for the three different communities - Intermediate mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.2, dir_2.2, dir_3.2, rdiv_1.2, rdiv_2.2, rdiv_3.2)
```

High mean values of E1 and E2 scenario

```{r RDplot3.3.3_b, fig.cap='Directional derivatives and response diversity for the three different communities - high mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.3, dir_2.3, dir_3.3, rdiv_1.3, rdiv_2.3, rdiv_3.3)
```

```{r}
new_rdiv <- rdiv_1[, c("rdiv")]
new_sign <- rdiv_1[, c("sign")]

dd4 <- dd4 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd4$cor <- "negative"
dd4$z1 <- "low"
dd4$E1_mean <- "low"

new_rdiv <- rdiv_1.2[, c("rdiv")]
new_sign <- rdiv_1.2[, c("sign")]

dd4.2 <- dd4.2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd4.2$cor <- "negative"
dd4.2$z1 <- "low"
dd4.2$E1_mean <- "medium"

new_rdiv <- rdiv_1.3[, c("rdiv")]
new_sign <- rdiv_1.3[, c("sign")]

dd4.3 <- dd4.3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd4.3$cor <- "negative"
dd4.3$z1 <- "low"
dd4.3$E1_mean <- "high"


new_rdiv <- rdiv_2[, c("rdiv")]
new_sign <- rdiv_2[, c("sign")]

dd5 <- dd5 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd5$cor <- "negative"
dd5$z1 <- "medium"
dd5$E1_mean <- "low"

new_rdiv <- rdiv_2.2[, c("rdiv")]
new_sign <- rdiv_2.2[, c("sign")]

dd5.2 <- dd5.2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd5.2$cor <- "negative"
dd5.2$z1 <- "medium"
dd5.2$E1_mean <- "medium"

new_rdiv <- rdiv_2.3[, c("rdiv")]
new_sign <- rdiv_2.3[, c("sign")]

dd5.3 <- dd5.3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd5.3$cor <- "negative"
dd5.3$z1 <- "medium"
dd5.3$E1_mean <- "high"


new_rdiv <- rdiv_3[, c("rdiv")]
new_sign <- rdiv_3[, c("sign")]

dd6 <- dd6 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign), conflict = "ignore")
dd6$cor <- "negative"
dd6$z1 <- "high"
dd6$E1_mean <- "low"

new_rdiv <- rdiv_3.2[, c("rdiv")]
new_sign <- rdiv_3.2[, c("sign")]

rdiv_6.2 <- rdiv_3.2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign), conflict = "ignore")
rdiv_6.2$cor <- "negative"
rdiv_6.2$z1 <- "high"
rdiv_6.2$E1_mean <- "medium"

new_rdiv <- rdiv_3.3[, c("rdiv")]
new_sign <- rdiv_3.3[, c("sign")]

dd6.3 <- dd6.3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd6.3$cor <- "negative"
dd6.3$z1 <- "high"
dd6.3$E1_mean <- "high"
```

## High fluctuation in environmental change - no correlation

Increasing variance in z1 - no correlation between env variables (E1 and E2) with *high* fluctuations

Same steps as before (3 communities with increasing diversity in z1 while z2 is fixed), but there is no correlation between E1 and E1

```{r plot3.5env, fig.cap='Environmental variables with high variation and no correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
E1max<-350; E1min<-250
E2max<-75; E2min<- -25
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(150, 0.0,
                                     0.0, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p_E1 <- refs1 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  geom_hline(yintercept = mean(refs1$E1),lty=2)+ 
  labs(tag = "(a)") +
  lims(y = c(E1min, E1max))

p_E2 <- refs1 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs1$E2),lty=2)+ 
  labs(tag = "(b)") +
     lims(y = c(E2min, E2max))





### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(150, 0.0,
                                     0.0, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p2_E1 <- refs2 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E1),lty=2)+ 
  labs(tag = "(c)") +
   lims(y = c(E1min, E1max))

p2_E2 <- refs2 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E2),lty=2)+ 
  labs(tag = "(d)") +
      lims(y = c(E2min, E2max))



### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(150, 0.0,
                                     0.0, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p3_E1 <- refs3 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E1),lty=2)+ 
  labs(tag = "(e)") +
    lims(y = c(E1min, E1max))

p3_E2 <- refs3 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E2),lty=2)+ 
  labs(tag = "(f)") +
   lims(y = c(E2min, E2max))


(p_E1 + p_E2)/(p2_E1 + p2_E2)/(p3_E1 + p3_E2)



detach("package:MASS", unload=TRUE)

```

```{r}
# create reproducible community
set.seed(2456)
### Community 1 - low diversity in z1.
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)


species_pars$z1_range <- 25
species_pars$z2_range <- 25

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)

### Community 3 - high diversity in z1. 

species_pars$z1_range <- 50
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)

```

### Response diversity calculation

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```

Low mean values of E1 and E2 scenario

```{r RDplot3.3.3.3, fig.cap='Directional derivatives and response diversity for the three different communities - Low mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```

Intermediate mean values of E1 and E2 scenario

```{r RDplot3.2.1_a, fig.cap='Directional derivatives and response diversity for the three different communities - Intermediate mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.2, dir_2.2, dir_3.2, rdiv_1.2, rdiv_2.2, rdiv_3.2)
```

High mean values of E1 and E2 scenario

```{r RDplot3.3.2_c, fig.cap='Directional derivatives and response diversity for the three different communities - high mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.3, dir_2.3, dir_3.3, rdiv_1.3, rdiv_2.3, rdiv_3.3)
```

```{r}
dd7 <- data.frame(rdiv_1[, c("rdiv", "sign")]) 
dd7$cor <- "no cor"
dd7$z1 <- "low"
dd7$E1_mean <- "low"

dd7.2 <- data.frame(rdiv_1.2[, c("rdiv", "sign")]) 
dd7.2$cor <- "no cor"
dd7.2$z1 <- "low"
dd7.2$E1_mean <- "medium"

dd7.3 <- data.frame(rdiv_1.3[, c("rdiv", "sign")]) 
dd7.3$cor <- "no cor"
dd7.3$z1 <- "low"
dd7.3$E1_mean <- "high"


dd8 <- data.frame(rdiv_2[, c("rdiv", "sign")]) 
dd8$cor <- "no cor"
dd8$z1 <- "medium"
dd8$E1_mean <- "low"

dd8.2 <- data.frame(rdiv_2.2[, c("rdiv", "sign")]) 
dd8.2$cor <- "no cor"
dd8.2$z1 <- "medium"
dd8.2$E1_mean <- "medium"

dd8.3 <- data.frame(rdiv_2.3[, c("rdiv", "sign")]) 
dd8.3$cor <- "no cor"
dd8.3$z1 <- "medium"
dd8.3$E1_mean <- "high"

dd9 <- data.frame(rdiv_3[, c("rdiv", "sign")]) 
dd9$cor <- "no cor"
dd9$z1 <- "high"
dd9$E1_mean <-"low"


dd9.2 <- data.frame(rdiv_3.2[, c("rdiv", "sign")]) 
dd9.2$cor <- "no cor"
dd9.2$z1 <- "high"
dd9.2$E1_mean <- "medium"

dd9.3 <- data.frame(rdiv_3.3[, c("rdiv", "sign")]) 
dd9.3$cor <- "no cor"
dd9.3$z1 <- "high"
dd9.3$E1_mean <- "high"
```

## Low fluctuation in environmental change - no correlation

Increasing variance in z1 - no correlation between env variables (E1 and E2) with *low* fluctuations

We repeat the same steps as in the previous section, but this time E1 and E2 have a very small variance.

```{r plot2.6env, fig.cap='Environmental variables with *low* variation and negative correlation. (a) E1 changing over time. (b) E2 changing over time.', fig.align="center", fig.height=6, fig.width=12}
E1max<-320; E1min<-275
E2max<-80; E2min<- -15

# Scenario 1 - low mean vakues of E1 and E2
theme_set(theme_classic(base_size = 12))
library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .1),  quantile(E2_series, .1))                                   
sample_covariance_matrix <- matrix(c(1, 0.0,
                                     0.0, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs1 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "10%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p_E1 <- refs1 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  geom_hline(yintercept = mean(refs1$E1),lty=2)+ 
  labs(tag = "(a)") +
  lims(y = c(E1min, E1max))

p_E2 <- refs1 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs1$E2),lty=2)+ 
  labs(tag = "(b)") +
     lims(y = c(E2min, E2max))





### scenario 2 - medium mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .5),  quantile(E2_series, .5))                                   
sample_covariance_matrix <- matrix(c(1, 0.0,
                                     0.0, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs2 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "50%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p2_E1 <- refs2 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E1),lty=2)+ 
  labs(tag = "(c)") +
   lims(y = c(E1min, E1max))

p2_E2 <- refs2 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs2$E2),lty=2)+ 
  labs(tag = "(d)") +
      lims(y = c(E2min, E2max))



### scenario 3 - high mean values E1 E2
sample_size <- 15                                       
sample_meanvector <- c(quantile(E1_series, .9),  quantile(E2_series, .9))                                   
sample_covariance_matrix <- matrix(c(1, 0.0,
                                     0.0, 1),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs3 <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "90%", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

#cor(refs)

# plot env change over time
p3_E1 <- refs3 %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E1),lty=2)+ 
  labs(tag = "(e)") +
    lims(y = c(E1min, E1max))

p3_E2 <- refs3 %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
   geom_hline(yintercept = mean(refs3$E2),lty=2)+ 
  labs(tag = "(f)") +
   lims(y = c(E2min, E2max))


(p_E1 + p_E2)/(p2_E1 + p2_E2)/(p3_E1 + p3_E2)



detach("package:MASS", unload=TRUE)
```

```{r }
### Community 1 - low diversity in z1.
s <- 10
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 50

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional derivatives
dir_1 <- get_directionals(comm, new_data, refs1)
dir_1.2 <- get_directionals(comm, new_data, refs2)
dir_1.3 <- get_directionals(comm, new_data, refs3)


species_pars$z1_range <- 25
species_pars$z2_range <- 25

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs1)
dir_2.2 <- get_directionals(comm, new_data, refs2)
dir_2.3 <- get_directionals(comm, new_data, refs3)


### Community 3 - high diversity in z1. 

species_pars$z1_range <- 50
species_pars$z2_range <- 1.5

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs1)
dir_3.2 <- get_directionals(comm, new_data, refs2)
dir_3.3 <- get_directionals(comm, new_data, refs3)

```

### Response diversity calculation

```{r}
# community 1  - calculation RD - scenario 1

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1$Med<-median(rdiv_1$rdiv)
rdiv_1$Med_sign<-median(rdiv_1$sign)

# community 1  - calculation RD - scenario 2

# from long to wide
rdiv_1.2 <- dir_1.2 %>%
  spread( sp, dir_deriv)
rdiv_1.2[is.na(rdiv_1.2)] <- 0

# actual calculation for only the same species used above
rdiv_1.2$rdiv<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.2$sign<-apply(dplyr:: select(rdiv_1.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.2$Med<-median(rdiv_1.2$rdiv)
rdiv_1.2$Med_sign<-median(rdiv_1.2$sign)

# community 1  - calculation RD - scenario 3

# from long to wide
rdiv_1.3 <- dir_1.3 %>%
  spread( sp, dir_deriv)
rdiv_1.3[is.na(rdiv_1.3)] <- 0

# actual calculation for only the same species used above
rdiv_1.3$rdiv<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_1.3$sign<-apply(dplyr:: select(rdiv_1.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_1.3$Med<-median(rdiv_1.3$rdiv)
rdiv_1.3$Med_sign<-median(rdiv_1.3$sign)

# community 2  - calculation RD - scenario 1
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(dplyr:: select(rdiv_2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2$Med<-median(rdiv_2$rdiv)
rdiv_2$Med_sign<-median(rdiv_2$sign)

# community 2  - calculation RD - scenario 2

# from long to wide
rdiv_2.2 <- dir_2.2 %>%
  spread( sp, dir_deriv)
rdiv_2.2[is.na(rdiv_2.2)] <- 0

# actual calculation for only the same species used above
rdiv_2.2$rdiv<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.2$sign<-apply(dplyr:: select(rdiv_2.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.2$Med<-median(rdiv_2.2$rdiv)
rdiv_2.2$Med_sign<-median(rdiv_2.2$sign)

# community 2  - calculation RD - scenario 3

# from long to wide
rdiv_2.3 <- dir_2.3 %>%
  spread( sp, dir_deriv)
rdiv_2.3[is.na(rdiv_2.3)] <- 0

# actual calculation for only the same species used above
rdiv_2.3$rdiv<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_2.3$sign<-apply(dplyr:: select(rdiv_2.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_2.3$Med<-median(rdiv_2.3$rdiv)
rdiv_2.3$Med_sign<-median(rdiv_2.3$sign)


# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(dplyr:: select(rdiv_3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3$Med<-median(rdiv_3$rdiv)
rdiv_3$Med_sign<-median(rdiv_3$sign)

# community 3  - calculation RD - scenario 2

# from long to wide
rdiv_3.2 <- dir_3.2 %>%
  spread( sp, dir_deriv)
rdiv_3.2[is.na(rdiv_3.2)] <- 0

# actual calculation for only the same species used above
rdiv_3.2$rdiv<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.2$sign<-apply(dplyr:: select(rdiv_3.2, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.2$Med<-median(rdiv_3.2$rdiv)
rdiv_3.2$Med_sign<-median(rdiv_3.2$sign)

# community 3  - calculation RD - scenario 3

# from long to wide
rdiv_3.3 <- dir_3.3 %>%
  spread( sp, dir_deriv)
rdiv_3.3[is.na(rdiv_3.3)] <- 0

# actual calculation for only the same species used above
rdiv_3.3$rdiv<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = F)
rdiv_3.3$sign<-apply(dplyr:: select(rdiv_3.3, starts_with("s")), 1, resp_div, sign_sens = T)                  
rdiv_3.3$Med<-median(rdiv_3.3$rdiv)
rdiv_3.3$Med_sign<-median(rdiv_3.3$sign)


```

Low mean values of E1 and E2 scenario

```{r RDplot3.1.2_b, fig.cap='Directional derivatives and response diversity for the three different communities - Low mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```

Intermediate mean values of E1 and E2 scenario

```{r RDplot2.3.2_b, fig.cap='Directional derivatives and response diversity for the three different communities - Intermediate mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.2, dir_2.2, dir_3.2, rdiv_1.2, rdiv_2.2, rdiv_3.2)
```

High mean values of E1 and E2 scenario

```{r RDplot2.3.3_b, fig.cap='Directional derivatives and response diversity for the three different communities - high mean values of E1 and E2 scenario. a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). Dashed lines indicate zero in panels a, b and c, and the median value of response diversity along the X-axis in panels d, e, f, g, h and i.', fig.align="center", fig.height=10, fig.width=16}
# Plotting
plot_RD(dir_1.3, dir_2.3, dir_3.3, rdiv_1.3, rdiv_2.3, rdiv_3.3)
```

```{r}
new_rdiv <- rdiv_1[, c("rdiv")]
new_sign <- rdiv_1[, c("sign")]

dd7 <- dd7 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd7$cor <- "negative"
dd7$z1 <- "low"
dd7$E1_mean <- "low"

new_rdiv <- rdiv_1.2[, c("rdiv")]
new_sign <- rdiv_1.2[, c("sign")]

dd7.2 <- dd7.2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd7.2$cor <- "negative"
dd7.2$z1 <- "low"
dd7.2$E1_mean <- "medium"

new_rdiv <- rdiv_1.3[, c("rdiv")]
new_sign <- rdiv_1.3[, c("sign")]

dd7.3 <- dd7.3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd7.3$cor <- "negative"
dd7.3$z1 <- "low"
dd7.3$E1_mean <- "high"


new_rdiv <- rdiv_2[, c("rdiv")]
new_sign <- rdiv_2[, c("sign")]

dd8 <- dd8 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd8$cor <- "negative"
dd8$z1 <- "medium"
dd8$E1_mean <- "low"

new_rdiv <- rdiv_2.2[, c("rdiv")]
new_sign <- rdiv_2.2[, c("sign")]

dd8.2 <- dd8.2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd8.2$cor <- "negative"
dd8.2$z1 <- "medium"
dd8.2$E1_mean <- "medium"

new_rdiv <- rdiv_2.3[, c("rdiv")]
new_sign <- rdiv_2.3[, c("sign")]

dd8.3 <- dd8.3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign))
dd8.3$cor <- "negative"
dd8.3$z1 <- "medium"
dd8.3$E1_mean <- "high"


new_rdiv <- rdiv_3[, c("rdiv")]
new_sign <- rdiv_3[, c("sign")]

dd9 <- dd9 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign), conflict = "ignore")
dd9$cor <- "negative"
dd9$z1 <- "high"
dd9$E1_mean <- "low"

new_rdiv <- rdiv_3.2[, c("rdiv")]
new_sign <- rdiv_3.2[, c("sign")]

rdiv_9.2 <- rdiv_3.2 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign), conflict = "ignore")
rdiv_9.2$cor <- "negative"
rdiv_9.2$z1 <- "high"
rdiv_9.2$E1_mean <- "medium"

new_rdiv <- rdiv_3.3[, c("rdiv")]
new_sign <- rdiv_3.3[, c("sign")]

dd9.3 <- dd9.3 %>% rows_insert(tibble(rdiv = new_rdiv,
                        sign = new_sign), conflict = "ignore")
dd9.3$cor <- "negative"
dd9.3$z1 <- "high"
dd9.3$E1_mean <- "high"
```

## Summary plot - Effects of z1 diversity and correlation between environmental variables on response diversity

```{r SummaryPlot3, fig.align="center", fig.height=8, fig.width=10, fig.cap="Influence of the correlation between environmental variables and z1 diversity on response diversity. (a) Effects of the correlation between environmental variables and z1 diversity on response diversity measured as dissimilarity (sign insensitive measure). (b) Effects of the correlation between environmental variables and z1 diversity on response diversity measured as divergence (sign sensitive measure)."}

dd_plot1 <- rbind(dd1[,c(1,3:5)], dd1.2[,c(1,3:5)],dd1.3[,c(1,3:5)],
                  dd2[,c(1,3:5)], dd2.2[,c(1,3:5)],dd2.3[,c(1,3:5)],
                  dd3[,c(1,3:5)], dd3.2[,c(1,3:5)],dd3.3[,c(1,3:5)],
                  dd4[,c(1,3:5)], dd4.2[,c(1,3:5)],dd4.3[,c(1,3:5)],
                  dd5[,c(1,3:5)], dd5.2[,c(1,3:5)],dd5.3[,c(1,3:5)], 
                  dd6[,c(1,3:5)], dd6.2[,c(1,3:5)],dd6.3[,c(1,3:5)],
                  dd7[,c(1,3:5)], dd7.2[,c(1,3:5)],dd7.3[,c(1,3:5)],
                  dd8[,c(1,3:5)], dd8.2[,c(1,3:5)],dd8.3[,c(1,3:5)],
                  dd9[,c(1,3:5)], dd9.2[,c(1,3:5)],dd9.3[,c(1,3:5)])
dd_plot1$z1 <- factor(dd_plot1$z1, levels = c("low", "medium", "high"))
theme_set(theme_classic(base_size = 12))

g1.1 <-
  ggplot(dd_plot1, aes(x = z1, y = rdiv, color = E1_mean)) +
   # scale_y_continuous(limits = c(0.99, 1.005), expand = c(0.02, 0.02)) +
    scale_color_uchicago() +
    labs(x = "z1 diversity", y = "Dissimilarity (derivatives)") +
    theme(
      legend.position = "none",
      axis.title = element_text(size = 16),
      panel.grid = element_blank()
    )


rdiv3 <- g1.1 +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  stat_summary(fun = mean, geom = "point", size = 5) + labs(tag = "(a)")

dd_plot2 <- rbind(dd1[,c(2,3:5)], dd1.2[,c(2,3:5)],dd1.3[,c(2,3:5)],
                  dd2[,c(2,3:5)], dd2.2[,c(2,3:5)],dd2.3[,c(2,3:5)],
                  dd3[,c(2,3:5)], dd3.2[,c(2,3:5)],dd3.3[,c(2,3:5)],
                  dd4[,c(2,3:5)], dd4.2[,c(2,3:5)],dd4.3[,c(2,3:5)],
                  dd5[,c(2,3:5)], dd5.2[,c(2,3:5)],dd5.3[,c(2,3:5)], 
                  dd6[,c(2,3:5)], dd6.2[,c(2,3:5)],dd6.3[,c(2,3:5)],
                  dd7[,c(2,3:5)], dd7.2[,c(2,3:5)],dd7.3[,c(2,3:5)],
                  dd8[,c(2,3:5)], dd8.2[,c(2,3:5)],dd8.3[,c(2,3:5)],
                  dd9[,c(2,3:5)], dd9.2[,c(2,3:5)],dd9.3[,c(2,3:5)])
dd_plot2$z1 <- factor(dd_plot2$z1, levels = c("low", "medium", "high"))
g1.2 <-
  ggplot(dd_plot2, aes(x = z1, y = sign, color = E1_mean)) +
    scale_color_uchicago() +
    labs(x = "z1 diveristy", y = "Divergence (sign sensitive)") +
    theme(
      legend.position = "none",
      axis.title = element_text(size = 16),
      panel.grid = element_blank()
    )

sign3 <- g1.2 +
  geom_jitter(size = 2, alpha = 0.25, width = 0.2) +
  stat_summary(fun = mean, geom = "point", size = 5)+ labs(tag = "(b)") +
  ylim(0, 1)

combined <- rdiv1 + sign1 & theme(legend.position = "bottom")
combined + plot_layout(guides = "collect")

```
# Overall Summary plot - Effects of z1 and z2 diversity and correlation between environmental variables on response diversity

```{r CorrSummary,  fig.height=10, fig.width=12, fig.cap="Influence of the correlation between environmental variables and diversity in z1 and z2 on response diversity. All data across all scenarios pooled together. (a), (b), and (c) Effects of the correlation between environmental variables and z1 diversity on response diversity measured as dissimilarity (sign insensitive measure). (d), (e), and (f) Effects of the correlation between environmental variables and z1 diversity on response diversity measured as divergence (sign sensitive measure).", fig.align="center"}
rdiv1 <- rdiv1 + ggtitle("Only variation in z1") + labs(tag = "(a)")
rdiv2 <- rdiv2 + ggtitle("Variation in z1 and z2\npositive correlation") + labs(tag = "(b)")
rdiv3 <- rdiv3 + ggtitle("Variation in z1 and z2\nnegative correlation") + labs(tag = "(c)")

sign1 <- sign1 + ggtitle("Only variation in z1") + labs(tag = "(d)")
sign2 <- sign2 + ggtitle("Variation in z1 and z2\npositive correlation") + labs(tag = "(e)")
sign3 <- sign3 + ggtitle("Variation in z1 and z2\nnegative correlation") + labs(tag = "(e)")

combined <- rdiv1 + rdiv2 + rdiv3 + sign1 + sign2 +sign3 & theme(legend.position = "bottom")
combined + plot_layout(guides = "collect")
```

