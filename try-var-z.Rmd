---
title: "Variation in z"
author: "Francesco Polazzo"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    fig_caption: yes
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    code_folding: hide
---


```{r include = FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      include = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE)
```



```{r results='hide'}
library(plotly)
library(tidyverse)
library(here)
library(patchwork)
library(DT)
library(mgcv)
library(gratia)
library(rlang)
library(vctrs)
library(scales)
library(broom)
library(reshape2)
library(ggtext)
library(ggsci)
source.files <- list.files(here("r"), full.names = TRUE)
sapply(source.files, source, .GlobalEnv)
```

# Intention
In this document, we are going to explore how diversity in species responses to one or both environmental variables, and different scenarios of correlation between them, may influence multifarious response diversity.
Additionally, we are going to look how different correlation between the environmental variables influence the calculated response diversity.



Within the project "response diversity in the context of multifarious environmental change", we have been simulating species response curves using the Eppley performance curve.

With one environmental variable, the performance (i.e., rate) is given by:

* $rate(E) = ae^{bE}(1 - (\frac{E - z}{w/2})^2)$
* $E$ is the values of the environmental factor.
* $z$ controls location of maximum.
* $w$ controls range of $E$ over which the rate is positive.
* $a$ scaling constant.
* $b$ controls rate of increase towards the maximum rate, as $E$ increases.

Adding a second environmental variable gives:

$rate(E_1, E_2) = a_1e^{b_1E_1}(1 - (\frac{E_1 - z_1}{w_1/2})^2) + a_2e^{b_2E_2}(1 - (\frac{E_2 - z_2}{w_2/2})^2)$

We now want to assess the role of diversity in response to on (or both) environmental variable(s), and investigate how different covariances in diversity of responses to E1 and E2 influence response diversity. 

To do that, we are going to manipulate amount of diversity in responses to either or both env variables among the species, and also the correlation in the tolerances (position of optima, determine by the terms z1 and z2 in the above formula). We will make scenarios of communities with diversity in response to only E1, or both E1 and E2, with diversity in both that is positively correlated (co-tolerance) or negatively (anti-tolerance) or no correlation.

# Variation in diversity in z1

## High fluctuation in environmental change - negative correlation
Increasing variance in z1 - negative correlation between env variables (E1 and E2) with *high* fluctuations
We now create 3 communities. Community 1 is characterised by low diversity in z1, community 2 has medium diversity in z1, and community 3 has high diversity in z1. z2 is constant in the 3 communities and fixed to a medium level of diversity. 

E1 and E2 have high fluctuations and negative correlation. 

```{r}
## define the series of values of the environmental variables
E1_series <- 273.15 + seq(0, 50, 1)
E2_series <- seq(0, 50, 1)

## define new_data for following GAM fitting

new_data <- tibble(E1 = 273.15 + seq(0, 50, 0.2),
                   E2 = seq(0, 50, 0.2))
```



(ref:plot1env) Environmental variables with high variation and negative correlation. (a) E1 changing over time. (b) E2 changing over time.
```{r plot1env, fig.cap='(ref:plot1env)', fig.align="center", fig.height=6, fig.width=12}
# Specify the correlation E1 and E2 
#negative in this example and high variation in E1 and E2 

library(MASS)
sample_size <- 15                                       
sample_meanvector <- c(mean(E1_series),  mean(E2_series))                                   
sample_covariance_matrix <- matrix(c(150, -150,
                                     -150, 150),
                                   ncol = 2)

# create bivariate normal distribution
set.seed(65354)
refs <- mvrnorm(n = sample_size,
                mu = sample_meanvector, 
                Sigma = sample_covariance_matrix) %>%
  as_tibble() %>% 
  dplyr::rename(E1 = "V1", E2 = "V2") %>% 
  dplyr::mutate(time = seq.int(nrow(.)))

ts_length <- 20
refs <- tibble(E1 = 273.15 + seq(2.5, 47.5, length = ts_length),
                   E2 = 25,
               time = 1:ts_length)
#cor(refs)

# plot env change over time
p_E1 <- refs %>% 
  ggplot(aes(x = time, y = E1)) + geom_line() +
  labs(tag = "(a)")

p_E2 <- refs %>% 
  ggplot(aes(x = time, y = E2)) + geom_line() +
  labs(tag = "(b)")

# Plot environmental change over time
p_E1 + p_E2
detach("package:MASS", unload=TRUE)

```

### Community 1 - low diversity in z1. 


```{r}
## Set species parameters
species_pars <- list(a1_mean = 1e-9,
  b1_mean = 0.063,
  z1_mean = 285,
  w1_mean = 60,
  a2_mean = 1e-3,
  b2_mean = 0.02,
  z2_mean = 20,
  w2_mean = 10,
  zint_mean = 0,
  sd_rate_mean = 0,
  z1_range = NA,
  z2_range = NA)

```


(ref:plotcomm1_neg) Community 1, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).
```{r plotcomm1_neg, fig.cap='(ref:plotcomm1_neg)', fig.align="center", fig.height=12, fig.width=12}
s <- 4
# community 1 - low variation in z1. 
species_pars$z1_range <- 1.5
species_pars$z2_range <- 15

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm1 <- multi_performance_plot(comm)
performance_comm1
# Get directional dreivatives
dir_1 <- get_directionals(comm, new_data, refs)

```



### Community 2 - medium diversity in z1. 

(ref:plotcomm2_neg) Community 2, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).
```{r plotcomm2_neg, fig.cap='(ref:plotcomm2_neg)', fig.align="center", fig.height=12, fig.width=12}
species_pars$z1_range <- 25
species_pars$z2_range <- 15
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm2 <- multi_performance_plot(comm)
performance_comm2
# Get directional dreivatives
dir_2 <- get_directionals(comm, new_data, refs)

```


### Community 3 - high diversity in z1. 

(ref:plotcomm3_neg) Community 3, single species responses. (a) Species responses to the gradient of E1. Different colour lines show the dependency of the rate to the second environmental variable (E2). (b) Species responses to the gradient of E2. Different colour lines show the dependency of the rate to the second environmental variable (E1).
```{r plotcomm3_neg, fig.cap='(ref:plotcomm3_neg)', fig.align="center", fig.height=12, fig.width=12}
species_pars$z1_range <- 50
species_pars$z2_range <- 15
# b1_range <- 0.009
# b2_range <- 0.001

# create reproducible community
set.seed(2456)
comm <- get_community(s, species_pars)

# Visualise spp performances 
performance_comm3 <- multi_performance_plot(comm)
performance_comm3
# Get directional dreivatives
dir_3 <- get_directionals(comm, new_data, refs)
```


### Response diversity calculation 

(ref:RDplot1) Directional derivatives and response diversity for the three different communities. 
a, b, c. Species directional derivatives over time. d, e, f. Response diversity measured as similarity-based diversity metric. g, h, i. Response diversity measured as divergence (sign sensitive). 
```{r RDplot1, fig.cap='(ref:RDplot1)', fig.align="center", fig.height=10, fig.width=16}
# community 1  - calculation RD

# from long to wide
rdiv_1 <- dir_1 %>%
  spread( sp, dir_deriv)
rdiv_1[is.na(rdiv_1)] <- 0

# actual calculation for only the same species used above
rdiv_1$rdiv<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_1$sign<-apply(rdiv_1[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_1$Med<-mean(rdiv_1$rdiv)
rdiv_1$Med_sing<-mean(rdiv_1$sign)


# community 2  - calculation RD
# from long to wide
rdiv_2 <- dir_2 %>%
  spread( sp, dir_deriv)
rdiv_2[is.na(rdiv_2)] <- 0

# actual calculation for only the same species used above
rdiv_2$rdiv<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_2$sign<-apply(rdiv_2[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_2$Med<-mean(rdiv_2$rdiv)
rdiv_2$Med_sing<-mean(rdiv_2$sign)

# community 3  - calculation RD
# from long to wide
rdiv_3 <- dir_3 %>%
  spread( sp, dir_deriv)
rdiv_3[is.na(rdiv_3)] <- 0

# actual calculation for only the same species used above
rdiv_3$rdiv<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = F)
rdiv_3$sign<-apply(rdiv_3[,c(4:7)], 1, resp_div, sign_sens = T)
rdiv_3$Med<-mean(rdiv_3$rdiv)
rdiv_3$Med_sing<-mean(rdiv_3$sign)


plot_RD(dir_1, dir_2, dir_3, rdiv_1, rdiv_2, rdiv_3)
```

